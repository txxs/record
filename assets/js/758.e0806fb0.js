(window.webpackJsonp=window.webpackJsonp||[]).push([[758],{1150:function(n,e,t){"use strict";t.r(e);var i=t(13),s=Object(i.a)({},(function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[t("p",[n._v("严格来说,容器的初始化过程主要包括")]),n._v(" "),t("ul",[t("li",[n._v("BeanDefinition的Resource定位")]),n._v(" "),t("li",[n._v("BeanDefinition的载入和解析")]),n._v(" "),t("li",[n._v("BeanDefinition在容器中的注册")])]),n._v(" "),t("p",[n._v("在初始化的过程当中,我们会看到一个又一个的方法被调用,换句话说,其实是通过调用一些方法来完成IoC容器初始化的.")]),n._v(" "),t("p",[t("code",[n._v("refresh()方法")]),n._v(",其实标志"),t("strong",[n._v("容器初始化过程的正式启动")]),n._v(".")]),n._v(" "),t("p",[n._v("Spring之所以把这三个基本过程分开,并使用不同模块\n如使用相应的"),t("strong",[n._v("ResourceLoader")]),n._v("、"),t("strong",[n._v("BeanDefinitionReader")]),n._v("等模块,是因为这样可以让用户更灵活地对这三个过程进行裁剪或扩展,定义出最适合自己的IoC容器的初始化过程.")]),n._v(" "),t("h1",{attrs:{id:"_1-beandefinition的resource定位"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-beandefinition的resource定位"}},[n._v("#")]),n._v(" 1 BeanDefinition的Resource定位")]),n._v(" "),t("p",[t("strong",[n._v("BeanDefinition")]),n._v("\n从字面上理解,它代表着Bean的定义.\n其实,它就是完整的描述了在Spring配置文件中定义的节点中的所有信息,包括各种子节点.\n不太恰当地说,我们可以把它理解为配置文件中一个个"),t("bean"),n._v("节点所包含的信息")],1),n._v(" "),t("p",[n._v("在"),t("strong",[n._v("ApplicationContext")]),n._v("中,Spring已经为我们提供了一系列加载不同Resource的读取器的实现"),t("strong",[n._v("DefaultListableBeanFactory")]),n._v("只是一个纯粹的IoC容器,需要为它提供特定的读取器才能完成这些功能.\n但使用"),t("strong",[n._v("DefaultListableBeanFactory")]),n._v("这种更底层的容器能提高定制IoC容器的灵活性.")]),n._v(" "),t("p",[n._v("至于常用的"),t("strong",[n._v("ApplicationContext")]),n._v("见名知义,如")]),n._v(" "),t("ul",[t("li",[t("strong",[n._v("FileSystemXmlApplicationContext")])]),n._v(" "),t("li",[t("strong",[n._v("ClassPathXmlApplicationContext")])]),n._v(" "),t("li",[t("strong",[n._v("XmlWebApplicationContext")])]),n._v(" "),t("li",[n._v("...")])]),n._v(" "),t("p",[n._v("下面将以"),t("strong",[n._v("FileSystemXmlApplicationContext")]),n._v("为例,分析怎么完成Resource定位\n"),t("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-28e4fd8babdb5881.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"ApplicationContext继承体系"}}),n._v("\n从实现角度,我们近距离关心以"),t("strong",[n._v("FileSystemXmlApplicationContext")]),n._v("为核心的继承体系\n"),t("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-7cd374f07190bbf7?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:""}})]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('package org.springframework.context.support;\n\npublic class FileSystemXmlApplicationContext extends AbstractXmlApplicationContext {\n\n    public FileSystemXmlApplicationContext() {\n    }\n\n    // @param 父上下文\n    public FileSystemXmlApplicationContext(ApplicationContext parent) {\n        super(parent);\n    }\n \n    // 这个构造函数的configLocation包含BeanDefinition所在的文件路径\n    public FileSystemXmlApplicationContext(String configLocation) throws BeansException {\n        this(new String[] {configLocation}, true, null);\n    }\n\n    // 这个构造函数允许configLocation包含多个BeanDefinition的文件路径\n    public FileSystemXmlApplicationContext(String... configLocations) throws BeansException {\n        this(configLocations, true, null);\n    }\n\n    \n    // 这个构造函数允许configLocation包含多个BeanDefinition的文件路径的同时\n    // 还允许指定自己的双亲IoC容器\n    public FileSystemXmlApplicationContext(String[] configLocations, ApplicationContext parent) throws BeansException {\n        this(configLocations, true, parent);\n    }\n\n    public FileSystemXmlApplicationContext(String[] configLocations, boolean refresh) throws BeansException {\n        this(configLocations, refresh, null);\n    }\n\n    // 在对象的初始化过程中,调用refresh方法载入BeanDefinition,这个refresh启动了\n    // BeanDefinition的载入过程,我们会在下面详解\n    public FileSystemXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent)\n            throws BeansException {\n\n        super(parent);\n        setConfigLocations(configLocations);\n        if (refresh) {\n            refresh();\n        }\n    }\n\n    // 这是应用于文件系统的Resourse的实现,通过构造一个FileSystemResource得到一个在文件系统中定位的BeanDefinition\n    // 这个getResourceByPath是在BeanDefinitionReader中被调用的\n    // loadBeanDefinition采用了模板模式,具体的定位实现实际上是由各个子类完成的\n    @Override\n    protected Resource getResourceByPath(String path) {\n        if (path != null && path.startsWith("/")) {\n            path = path.substring(1);\n        }\n        return new FileSystemResource(path);\n    }\n}\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br"),t("span",{staticClass:"line-number"},[n._v("16")]),t("br"),t("span",{staticClass:"line-number"},[n._v("17")]),t("br"),t("span",{staticClass:"line-number"},[n._v("18")]),t("br"),t("span",{staticClass:"line-number"},[n._v("19")]),t("br"),t("span",{staticClass:"line-number"},[n._v("20")]),t("br"),t("span",{staticClass:"line-number"},[n._v("21")]),t("br"),t("span",{staticClass:"line-number"},[n._v("22")]),t("br"),t("span",{staticClass:"line-number"},[n._v("23")]),t("br"),t("span",{staticClass:"line-number"},[n._v("24")]),t("br"),t("span",{staticClass:"line-number"},[n._v("25")]),t("br"),t("span",{staticClass:"line-number"},[n._v("26")]),t("br"),t("span",{staticClass:"line-number"},[n._v("27")]),t("br"),t("span",{staticClass:"line-number"},[n._v("28")]),t("br"),t("span",{staticClass:"line-number"},[n._v("29")]),t("br"),t("span",{staticClass:"line-number"},[n._v("30")]),t("br"),t("span",{staticClass:"line-number"},[n._v("31")]),t("br"),t("span",{staticClass:"line-number"},[n._v("32")]),t("br"),t("span",{staticClass:"line-number"},[n._v("33")]),t("br"),t("span",{staticClass:"line-number"},[n._v("34")]),t("br"),t("span",{staticClass:"line-number"},[n._v("35")]),t("br"),t("span",{staticClass:"line-number"},[n._v("36")]),t("br"),t("span",{staticClass:"line-number"},[n._v("37")]),t("br"),t("span",{staticClass:"line-number"},[n._v("38")]),t("br"),t("span",{staticClass:"line-number"},[n._v("39")]),t("br"),t("span",{staticClass:"line-number"},[n._v("40")]),t("br"),t("span",{staticClass:"line-number"},[n._v("41")]),t("br"),t("span",{staticClass:"line-number"},[n._v("42")]),t("br"),t("span",{staticClass:"line-number"},[n._v("43")]),t("br"),t("span",{staticClass:"line-number"},[n._v("44")]),t("br"),t("span",{staticClass:"line-number"},[n._v("45")]),t("br"),t("span",{staticClass:"line-number"},[n._v("46")]),t("br"),t("span",{staticClass:"line-number"},[n._v("47")]),t("br"),t("span",{staticClass:"line-number"},[n._v("48")]),t("br"),t("span",{staticClass:"line-number"},[n._v("49")]),t("br"),t("span",{staticClass:"line-number"},[n._v("50")]),t("br"),t("span",{staticClass:"line-number"},[n._v("51")]),t("br"),t("span",{staticClass:"line-number"},[n._v("52")]),t("br"),t("span",{staticClass:"line-number"},[n._v("53")]),t("br"),t("span",{staticClass:"line-number"},[n._v("54")]),t("br"),t("span",{staticClass:"line-number"},[n._v("55")]),t("br"),t("span",{staticClass:"line-number"},[n._v("56")]),t("br")])]),t("p",[n._v("我们可以发现，在FileSystemXmlApplicationContext中不管调用哪个构造函数，最终都是会调用这个包含了refresh方法的构造函数，因此我们可以很容易得出结论：触发对"),t("code",[n._v("BeanDefinition")]),n._v("资源定位过程的"),t("code",[n._v("refresh")]),n._v("的调用是在"),t("code",[n._v("FileSystemXmlApplicationContext")]),n._v("的构造函数中启动的.\n"),t("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-5635a0bc0b268228?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:""}}),n._v("\n根据上图及"),t("strong",[n._v("FileSystemXmlApplicationContext")]),n._v("中含有**"),t("em",[n._v("refresh()"),t("em",[t("strong",[n._v("方法的构造函数的分析,可清楚地看到整个")]),n._v("BeanDefinition")])]),n._v("资源定位的过程.\n该过程最初是由***refresh()***触发,而**"),t("em",[n._v("refresh()"),t("em",[t("strong",[n._v("的调用是在")]),n._v("FileSystemXmlApplicationContext")])]),n._v("的构造函数中启动的,大致调用过程如下图\n"),t("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-18bf13dff31cd6e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:""}}),n._v("\n看了调用过程,我们可能好奇这个"),t("code",[n._v("FileSystemXmlAppplicationContext")]),n._v("在什么地方定义了"),t("code",[n._v("BeanDefinition")]),n._v("的读入器"),t("code",[n._v("BeanDefinitionReader")]),n._v("的呢?\n关于这个读入器的配置,我们到其基类  "),t("code",[n._v("AbstractRefreshableApplicationContext")]),n._v("  的 "),t("code",[n._v("refreshBeanFactory()")]),n._v("方法看看\n"),t("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-eef2f481155ad199?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:""}}),n._v("\n刚才我们提到,**"),t("em",[n._v("refresh()"),t("em",[t("strong",[n._v("的调用是在")]),n._v("FileSystemXmlApplicationContext")])]),n._v("的构造函数中启动的\n而这个**"),t("em",[n._v("refresh()"),t("em",[t("strong",[n._v("又是从")]),n._v("AbstractApplicationContext")])]),n._v("继承而来\n因此,结合前面方法时序图知**"),t("em",[n._v("refreshBeanFactory()"),t("em",[t("strong",[n._v("被")]),n._v("FileSystemXmlApplicationContext")])]),n._v("构造函数中的***refresh()*"),t("strong",[n._v("调用.\n在这个方法（"),t("strong",[t("em",[n._v("refreshBeanFactory()"),t("em",[t("strong",[n._v("）中，通过"),t("strong",[t("em",[n._v("createBeanFactory()"),t("em",[t("strong",[n._v("构建了一个容器供")]),n._v("ApplicationContext")])]),n._v("使用.\n这个容器就是前面我们提到的")]),n._v("DefaultListableBeanFactory")]),n._v(",同时它还启动了"),t("strong",[t("em",[n._v("loadBeanDefinition()"),t("em",[t("strong",[n._v("来载入")]),n._v("BeanDefinition")])]),n._v(",这里和以编程式使用IoC容器的过程很相似\n在")]),n._v("AbstractRefreshableApplictionContext")])]),n._v("中,这里是使用")]),n._v("BeanDefinitionReader")]),n._v("载入Bean定义的地方,因为允许有多种载入方式,这里通过一个抽象函数把具体的实现委托给子类完成")]),n._v(" "),t("p",[n._v("从前面的方法调用栈可以发现***refreshBeanFactory***方法中调用的**"),t("em",[n._v("loadBeanDefinitions"),t("em",[t("strong",[n._v("方法其实最终是调用")]),n._v("AbstractBeanDefinitionReader")])]),n._v("里面的**"),t("em",[n._v("loadBeanDefinitions"),t("em",[t("strong",[n._v("方法\n"),t("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-60cb490082e9b896.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:""}}),n._v("\n对于取得")]),n._v("Resource")])]),n._v("的具体过程，我们来看看"),t("code",[n._v("DefaultResourceLoader")]),n._v("怎样完成\n"),t("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-bcb69b628fc42ae2?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:""}}),n._v("\n上图中 "),t("code",[n._v("getResourcePath()")]),n._v("将会被"),t("code",[n._v("FileSystemXmlApplicationContext")]),n._v("实现.\n该方法返回的是一个"),t("code",[n._v("FileSystemResource")]),n._v("对象,通过这个对象,Spring可以进行相关的I/O操作,完成"),t("code",[n._v("BeanDefinition")]),n._v("的定位.")]),n._v(" "),t("p",[n._v("如果是其他的"),t("code",[n._v("ApplicationContext")]),n._v(",那么会对应生成其他种类的"),t("code",[n._v("Resource")]),n._v("，比如"),t("code",[n._v("ClassPathResource")]),n._v("、"),t("code",[n._v("ServletContextResource")]),n._v("等")]),n._v(" "),t("p",[n._v("所以"),t("strong",[n._v("BeanDefinition")]),n._v("的定位到这里就完成了.\n在"),t("strong",[n._v("BeanDefinition")]),n._v("定位完成的基础上,就可以通过返回的"),t("strong",[n._v("Resource")]),n._v("对象进行"),t("strong",[n._v("BeanDefinition")]),n._v("的载入了.\n在定位过程完成后,为"),t("strong",[n._v("BeanDefinition")]),n._v("的载入创造了I/O操作的条件,但具体的数据还没有开始读入.这些读入将在下面介绍的"),t("strong",[n._v("BeanDefinition")]),n._v("的载入和解析中来完成.")])])}),[],!1,null,null,null);e.default=s.exports}}]);