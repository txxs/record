(window.webpackJsonp=window.webpackJsonp||[]).push([[1195],{1590:function(_,v,t){"use strict";t.r(v);var a=t(13),s=Object(a.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("ul",[t("li",[_._v("选一个数据库中间件,然后深入之")]),_._v(" "),t("li",[_._v("设计分库分表的方案，要分成多少个库，每个库分成多少个表")]),_._v(" "),t("li",[_._v("基于已选的数据库中间件，以及在测试环境建立好的分库分表，?能否正常执行分库分表的读写")]),_._v(" "),t("li",[_._v("完成单库单表到分库分表的迁移(使用上一文提到的双写方案)")]),_._v(" "),t("li",[_._v("线上系统,开始基于分库分表对外服务")])]),_._v(" "),t("p",[_._v("突然! 扩容了，扩容成6个库，每个库需要12个表，你怎么来增加更多库和表？\n当你已经弄好分库分表方案，测试也通过了，数据能均匀分布到各个库和表里去，而且接着你还通过双写方案上了系统，已经直接基于分库分表方案在搞了。\n需求来了~现在这些库和表又支撑不住了，要继续扩容，咋办？")]),_._v(" "),t("p",[_._v("可能")]),_._v(" "),t("ul",[t("li",[_._v("每个库的容量又快满了")]),_._v(" "),t("li",[_._v("表数据量又太大")]),_._v(" "),t("li",[_._v("每个库的写并发太高")])]),_._v(" "),t("p",[_._v("得继续扩容!")]),_._v(" "),t("h1",{attrs:{id:"停机扩容-不推荐"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#停机扩容-不推荐"}},[_._v("#")]),_._v(" 停机扩容(不推荐)")]),_._v(" "),t("p",[_._v("和停机迁移一样，步骤几乎一致，唯一不同是导数据的工具，是把现有库表的数据抽出来慢慢导入到新的库和表里去。\n最好别这样，有点不太靠谱，既然分库分表，就说明数据量实在太大，这么玩可能玩脱。")]),_._v(" "),t("p",[_._v("从单库单表迁移到分库分表时，数据量并不是很大，单表最大也就两三千万。写个工具，多弄几台机器并行跑，1小时数据就导完了。")]),_._v(" "),t("p",[_._v("但如果是：3个库+12个表。跑一段时间，数据量都1亿~2亿了，光是导2亿数据，都要导个几个小时，6点，刚刚导完数据，还要搞后续的修改配置，重启系统，测试验证，大半天才搞完。")]),_._v(" "),t("h1",{attrs:{id:"优化方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优化方案"}},[_._v("#")]),_._v(" 优化方案")]),_._v(" "),t("p",[_._v("一开始上来就是32个库，每个库32个表，1024张表：")]),_._v(" "),t("ul",[t("li",[_._v("基本上国内互联网肯定都够用")]),_._v(" "),t("li",[_._v("无论并发支撑还是数据量支撑都没问题")])]),_._v(" "),t("p",[_._v("每个库正常承载的写入并发量是1000，那么32个库就可以承载"),t("code",[_._v("32 * 1000 = 32000")]),_._v("的写并发。\n如果每个库承载1500的写并发，"),t("code",[_._v("32 * 1500 = 48000")]),_._v("的写并发，接近5万/s的写并发。\n前面再加个MQ，削峰，每秒写入MQ 8万条数据，每秒消费5万条数据。\n1024张表，假设每个表放500万数据，在MySQL里可以放50亿条数据。\n每秒的5万写并发，总共50亿条数据，对于国内大部分互联网公司来说都够。")]),_._v(" "),t("p",[_._v("分库分表的扩容，"),t("strong",[_._v("第一次分库分表，就一次性给他分个够")]),_._v("。\n32个库，1024张表，对大部分的中小型互联网公司来说，已经可以支撑好几年。\n一个实践是利用"),t("code",[_._v("32 * 32")]),_._v("来分库分表，即分为32个库，每个库里一个表分为32张表，一共就是1024张表。根据某个id先根据32取模路由到库，再根据32取模路由到库里的表。")]),_._v(" "),t("p",[_._v("刚开始的时候，这个库可能就是逻辑库，建在一个数据库上的\n也就是一个MySQL服务器可能建了n个库,后面如果要拆分，就不断在库和MySQL服务器之间做迁移就可以了。然后系统配合改一下配置即可。")]),_._v(" "),t("p",[_._v("比如说最多可以扩展到32个数据库服务器，每个数据库服务器是一个库。如果还是不够？\n最多可以扩展到1024个数据库服务器，每个数据库服务器上面一个库一个表。因为最多是1024个表")]),_._v(" "),t("p",[_._v("这么搞，是不用自己写代码做数据迁移的，都交给DBA来搞好了，但是DBA确实需要做一些库表迁移的工作，总比你自己写代码，抽数据导数据来的效率高得多")]),_._v(" "),t("p",[_._v("哪怕是要减少库的数量，也很简单，按倍数缩容就可以了，然后修改一下路由规则。")]),_._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190713122920517.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_1,color_FFFFFF,t_70",alt:""}})]),_._v(" "),t("h1",{attrs:{id:"_5-总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-总结"}},[_._v("#")]),_._v(" 5 总结")]),_._v(" "),t("h2",{attrs:{id:"_5-1-确定方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-确定方案"}},[_._v("#")]),_._v(" 5.1 确定方案")]),_._v(" "),t("p",[_._v("几台数据库服务器,每台服务器上几个库，每个库多少个表，推荐是"),t("code",[_._v("32库 * 32表")]),_._v("，对于大部分公司来说，可能几年都够了")]),_._v(" "),t("h2",{attrs:{id:"_5-2-路由规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-路由规则"}},[_._v("#")]),_._v(" 5.2 路由规则")]),_._v(" "),t("p",[_._v("orderId 模 32 = 库，orderId / 32 模 32 = 表")]),_._v(" "),t("h2",{attrs:{id:"_5-3-扩容"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-扩容"}},[_._v("#")]),_._v(" 5.3 扩容")]),_._v(" "),t("p",[_._v("当扩容时,申请增加更多的数据库服务器，装好MySQL，倍数扩容，4台服务器，扩到8台服务器，16台服务器")]),_._v(" "),t("h2",{attrs:{id:"_5-4-迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-迁移"}},[_._v("#")]),_._v(" 5.4 迁移")]),_._v(" "),t("p",[_._v("由DBA负责将原先数据库服务器的库，迁移到新的数据库服务器上去，很多工具，库迁移，比较便捷")]),_._v(" "),t("h2",{attrs:{id:"_5-5-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-配置"}},[_._v("#")]),_._v(" 5.5 配置")]),_._v(" "),t("p",[_._v("我们这边就是修改一下配置，调整迁移的库所在数据库服务器的地址")]),_._v(" "),t("h2",{attrs:{id:"_5-6-发布"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-发布"}},[_._v("#")]),_._v(" 5.6 发布")]),_._v(" "),t("p",[_._v("重新发布系统，上线，原先的路由规则变都不用变，直接可以基于2倍的数据库服务器的资源，继续进行线上系统的提供服务")]),_._v(" "),t("ul",[t("li",[_._v("分库分表扩容方案"),t("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190713124154927.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])]),_._v(" "),t("p",[_._v("参考")]),_._v(" "),t("ul",[t("li",[_._v("《Java工程师面试突击》")])])])}),[],!1,null,null,null);v.default=s.exports}}]);