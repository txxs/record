(window.webpackJsonp=window.webpackJsonp||[]).push([[1275],{1669:function(s,t,a){"use strict";a.r(t);var e=a(13),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"_1-redis-sentinel的意义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-redis-sentinel的意义"}},[s._v("#")]),s._v(" 1 Redis Sentinel的意义")]),s._v(" "),a("ul",[a("li",[s._v("master宕机了咋整？等运维手工从主切换，再通知所有程序把地址统统改一遍重新上线？那么服务就会停滞很久，显然对于大型系统这是灾难性的！\n所以必须有高可用方案，当故障发生时可自动从主切换，程序也不用重启，不必手动运维。Redis 官方就提供了这样一种方案 —— Redis Sentinel(哨兵)。")])]),s._v(" "),a("p",[s._v("sentinal，哨兵，redis集群架构中非常重要的一个组件，主要功能如下")]),s._v(" "),a("ul",[a("li",[s._v("集群监控\n监控Redis master和slave进程的正常工作")]),s._v(" "),a("li",[s._v("消息通知\n如果某个Redis实例有故障，那么哨兵负责发送报警消息给管理员")]),s._v(" "),a("li",[s._v("故障转移\n若master node宕机，会自动转移到slave node上")]),s._v(" "),a("li",[s._v("配置中心\n若发生故障转移，通知client客户端新的master地址")])]),s._v(" "),a("p",[s._v("哨兵本身也是分布式，作为一个集群运行：")]),s._v(" "),a("ul",[a("li",[s._v("故障转移时，判断一个master node是否宕机，需要大部分哨兵都同意，涉及分布式选举")]),s._v(" "),a("li",[s._v("即使部分哨兵节点宕机，哨兵集群还是能正常工作")])]),s._v(" "),a("blockquote",[a("p",[s._v("目前采用的是sentinal 2版本，sentinal 2相对于sentinal 1来说，重写了很多代码，主要是让故障转移的机制和算法变得更加健壮和简单")])]),s._v(" "),a("p",[s._v("哨兵 + Redis主从的部署架构不保证数据零丢失，只保证redis集群的高可用性。")]),s._v(" "),a("h1",{attrs:{id:"为何2个节点无法正常工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为何2个节点无法正常工作"}},[s._v("#")]),s._v(" 为何2个节点无法正常工作")]),s._v(" "),a("p",[s._v("必须部署2个以上的节点。若仅部署2个实例，quorum=1")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("+----+         +----+\n| M1 |---------| R1 |\n| S1 |         | S2 |\n+----+         +----+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("Configuration: "),a("code",[s._v("quorum = 1")])]),s._v(" "),a("p",[s._v("master宕机，s1和s2中只要有1个哨兵认为master宕机就可以进行切换，同时会在s1和s2中选举出一个执行故障转移.\n但此时，需要majority，也就是大多数哨兵都是运行的，2个哨兵的majority就是2")]),s._v(" "),a("blockquote",[a("p",[s._v("2个哨兵的majority=2\n3个哨兵的majority=2\n4个哨兵的majority=2\n5个哨兵的majority=3")])]),s._v(" "),a("p",[s._v("2个哨兵都运行着，就可以允许执行故障转移")]),s._v(" "),a("p",[s._v("若整个M1和S1运行的机器宕机了，那么哨兵仅剩1个，此时就无majority来允许执行故障转移，虽然另外一台机器还有一个R1，但故障转移不会执行")]),s._v(" "),a("h1",{attrs:{id:"_3节点哨兵集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3节点哨兵集群"}},[s._v("#")]),s._v(" 3节点哨兵集群")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("       +----+\n       | M1 |\n       | S1 |\n       +----+\n          |\n+----+    |    +----+\n| R2 |----+----| R3 |\n| S2 |         | S3 |\n+----+         +----+\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("Configuration: quorum = 2，majority")]),s._v(" "),a("p",[s._v("若M1节点宕机了，还剩下2个哨兵，S2和S3可以一致认为master宕机了，然后选举出一个来执行故障转移")]),s._v(" "),a("p",[s._v("同时3个哨兵的"),a("code",[s._v("majority")]),s._v("是2，所以余存的2个哨兵运行着，就可执行故障转移")]),s._v(" "),a("h1",{attrs:{id:"_2-redis-sentinel-架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-sentinel-架构"}},[s._v("#")]),s._v(" 2 Redis Sentinel 架构")]),s._v(" "),a("h2",{attrs:{id:"redis-sentinel故障转移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel故障转移"}},[s._v("#")]),s._v(" Redis Sentinel故障转移")]),s._v(" "),a("ol",[a("li",[s._v("多个sentinel发现并确认master有问题。")]),s._v(" "),a("li",[s._v("选举出一个sentinel作为领导。")]),s._v(" "),a("li",[s._v("选出一个slave作为master.")]),s._v(" "),a("li",[s._v("通知其余slave成为新的master的slave.")]),s._v(" "),a("li",[s._v("通知客户端主从变化")]),s._v(" "),a("li",[s._v("等待老的master复活成为新master的slave\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210420141013774.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])]),s._v(" "),a("ul",[a("li",[s._v("可监控多套\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/2021042014284067.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])]),s._v(" "),a("h1",{attrs:{id:"_3-安装与配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-安装与配置"}},[s._v("#")]),s._v(" 3 安装与配置")]),s._v(" "),a("ol",[a("li",[s._v("配置开启主从节点")]),s._v(" "),a("li",[s._v("配置开启sentinel监控主节点。(sentinel是特殊的redis)")]),s._v(" "),a("li",[s._v("实际应该多机器")]),s._v(" "),a("li",[s._v("详细配置节点")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210420143559745.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}}),s._v(" "),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210420143538431.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})]),s._v(" "),a("p",[s._v("Redis 主节点")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("启动"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nredis-server redis- "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7000")]),s._v(".conf\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("配置"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7000")]),s._v("\ndaemonize "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile /var/run/redis-7000.pid\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7000.log"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/soft/redis/data/"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("Redis 从节点")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("启动"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nredis-server redis-7001.conf\nredis-server redis-7002.conf\n\nslave-1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("配置"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7001")]),s._v("\ndaemonize "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile /var/run/redis-7001.pid\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7001.log"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/soft/redis/data/"')]),s._v("\nslaveof "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7000")]),s._v("\n\nslave-2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("配置"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7002")]),s._v("\ndaemonize "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\npidfile /var/run/redis-7002.pid\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7002.log"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/soft/redis/data/"')]),s._v("\nslaveof "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7000")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("Sentinel 主要配置")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("port "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/soft/redis/data/"')]),s._v("\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" '),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('.log"')]),s._v("\nsentinel monitor mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nsentinel down-after-milliseconds mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nsentinel parallel-syncs mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel failover-timeout mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"演示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#演示"}},[s._v("#")]),s._v(" 演示")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/407d586e9e68f5ab618429f486f47b77.png",alt:""}})]),s._v(" "),a("ul",[a("li",[a("p",[s._v("主节点配置"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/e0ccc6ea9b2d8cfac7e5c18188bff594.png",alt:""}}),s._v(" "),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210206170428942.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])]),s._v(" "),a("li",[a("p",[s._v("重定向"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/14364230c56b886b6beadc566d2b13a7.png",alt:""}})])]),s._v(" "),a("li",[a("p",[s._v("打印检查配置文件"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/91ea7d183e7b6432231735be89605743.png",alt:""}})])]),s._v(" "),a("li",[a("p",[s._v("启动\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210206170745522.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70#pic_center",alt:""}})])])]),s._v(" "),a("h1",{attrs:{id:"_4-客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-客户端"}},[s._v("#")]),s._v(" 4 客户端")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("客户端实现基本原理-1\n"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/577082c68e80768c379c3e6a27ed6139.png",alt:""}})])]),s._v(" "),a("li",[a("p",[s._v("客户端实现基本原理-2\n"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/36a24d0612871f9201a1336d410e4ec5.png",alt:""}})])]),s._v(" "),a("li",[a("p",[s._v("客户端实现基本原理-3 验证"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/a920bd693c109e0613fef5c5fbb81c91.png",alt:""}})])]),s._v(" "),a("li",[a("p",[s._v("客户端实现基本原理-4 通知(发布订阅))\n"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/a24f586a657f8dfadfa32da4de87d319.png",alt:""}}),s._v(" "),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210420162740248.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])])]),s._v(" "),a("h2",{attrs:{id:"客户端接入流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客户端接入流程"}},[s._v("#")]),s._v(" 客户端接入流程")]),s._v(" "),a("ol",[a("li",[s._v("Sentinel地址集合")]),s._v(" "),a("li",[s._v("masterName")]),s._v(" "),a("li",[s._v("不是代理模式")])]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),s._v(" sentinelPool "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("masterName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sentinelSet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" poolConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" jedis "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tjedis "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redisSentinelPool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResource")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//jedis command")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tlogger"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedis "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\tjedis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h1",{attrs:{id:"_5-定时任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-定时任务"}},[s._v("#")]),s._v(" 5 定时任务")]),s._v(" "),a("ol",[a("li",[s._v("每10s 每个 sentinel 对 master 和 replica 执行 INFO 命令")])]),s._v(" "),a("ul",[a("li",[s._v("发现 replica  节点")]),s._v(" "),a("li",[s._v("确认主从关系\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210419164949341.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])]),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[s._v("每 2s 每个 sentinel 通过 master 节点的channel交换信息(pub/sub)")])]),s._v(" "),a("ul",[a("li",[s._v("通过 "),a("em",[s._v("sentinel")]),s._v(" :java频道交互")]),s._v(" "),a("li",[s._v('交互对节点的"看法”和自身信息\n'),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210420153539965.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])]),s._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[s._v("每 1s 每个 sentinel 对其他 sentinel 和 redis 执行ping")])]),s._v(" "),a("ul",[a("li",[s._v("心跳检测，失败判定依据\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/2021042015015784.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})])]),s._v(" "),a("h1",{attrs:{id:"_6-主观下线和客观下线"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-主观下线和客观下线"}},[s._v("#")]),s._v(" 6 主观下线和客观下线")]),s._v(" "),a("h2",{attrs:{id:"主观下线-subjectively-down-sdown"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主观下线-subjectively-down-sdown"}},[s._v("#")]),s._v(" 主观下线(Subjectively Down,SDOWN)")]),s._v(" "),a("p",[a("code",[s._v("单个")]),s._v(" Sentinel 节点对服务器做出的下线判断，即单个 Sentinel 认为某个服务下线（有可能是接收不到订阅，之间的网络不通等一系列原因）。")]),s._v(" "),a("p",[s._v('注意主观下线是每个sentinel节点对Redis节点失败的"'),a("strong",[s._v("偏见")]),s._v("”。所以还需要客观下线机制。")]),s._v(" "),a("h2",{attrs:{id:"客观下线-objectively-down-odown"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客观下线-objectively-down-odown"}},[s._v("#")]),s._v(" 客观下线(Objectively Down,ODOWN)")]),s._v(" "),a("p",[a("code",[s._v("多个")]),s._v(" Sentinel 实例在对同一个服务器做出 SDOWN 判断，并且通过命令互相交流之后，得出的服务器下线判断，然后开启 failover。")]),s._v(" "),a("p",[s._v("只有在足够数量( 超过quorum个)的 Sentinel 都将一个服务器标记为主观下线之后， 服务器才会被标记为客观下线（ODOWN）。只有当 Master 被认定为客观下线时，才会发生故障迁移。")]),s._v(" "),a("h2",{attrs:{id:"仲裁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#仲裁"}},[s._v("#")]),s._v(" 仲裁")]),s._v(" "),a("p",[s._v("仲裁指配置文件中的 "),a("code",[s._v("quorum")]),s._v(" 参数。某个 Sentinel 先将 Master 节点标记为主观下线，然后会将这个判定通过 "),a("code",[s._v("sentinel is-master-down-by-addr")]),s._v(" 命令询问其他 Sentinel 节点是否也同样认为该 addr 的 Master 节点要做主观下线。\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20210420160002275.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70",alt:""}})]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("sentinel monitor "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("masterName"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("quorum"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nsentinel monitor myMaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\nsentinel down-after-milliseconds "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" masterName"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" timeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nsentinel down-after-milliseconds mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("最后当达成这一共识的 Sentinel 个数达到前面说的 quorum 设置的值时，该 Master 节点会被认定为客观下线并进行故障转移。\n"),a("code",[s._v("quorum")]),s._v(" 值一般设为 Sentinel 个数的二分之一加 1，例如 3 个 Sentinel 就设为 2。")]),s._v(" "),a("p",[s._v("综上可得")]),s._v(" "),a("h2",{attrs:{id:"哨兵工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#哨兵工作原理"}},[s._v("#")]),s._v(" 哨兵工作原理")]),s._v(" "),a("ol",[a("li",[s._v("每个 Sentinel 以 1次/s 向它所知的 Master，Slave 以及其他 Sentinel 节点发送一个 PING")]),s._v(" "),a("li",[s._v("若一个实例距离最后一次有效回复 PING 的时间超过配置文件 "),a("code",[s._v("down-after-milliseconds")]),s._v("，则该实例会被 Sentinel 标记为 "),a("strong",[s._v("主观下线")])]),s._v(" "),a("li",[s._v("若一个 Master 被标记为主观下线，那么正在监视这个 Master 的所有 Sentinel 要以 1次/s 确认 Master 是否真的进入主观下线状态")]),s._v(" "),a("li",[s._v("当有足够数量 Sentinel（大于等于配置文件指定的值）在指定时间范围内确认 Master 的确进入主观下线状态，则 Master 会被标记为 "),a("strong",[s._v("客观下线")])]),s._v(" "),a("li",[s._v("若 Master 处于 ODOWN 状态，则投票自动选出新Master。将剩余从节点指向新Master继续数据复制")]),s._v(" "),a("li",[s._v("在正常情况下，每个 Sentinel 会以每 10 秒一次的频率向它已知的所有 Master，Slave 发送 INFO 命令；当 Master 被 Sentinel 标记为客观下线时，Sentinel 向已下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次；")]),s._v(" "),a("li",[s._v("若没有足够数量 Sentinel 同意 Master 已经下线，Master 的"),a("strong",[s._v("客观下线")]),s._v("状态会被移除。若 Master 重新向 Sentinel 的 PING 命令返回有效回复，Master 的主观下线状态就会被移除。")])]),s._v(" "),a("h1",{attrs:{id:"_7-领导者选举"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-领导者选举"}},[s._v("#")]),s._v(" 7 领导者选举")]),s._v(" "),a("p",[s._v("原因：只有一个sentinel节点完成故障转移。\n选举：通过sentinel is-master-down-by-addr命令都希望成为领导者：")]),s._v(" "),a("ol",[a("li",[s._v("每个做主观下线的Sentinel节点向其他Sentinel节点发送命令，要求将它设置为领导者")]),s._v(" "),a("li",[s._v("收到命令的Sentinel节点如果没有同意通过其他Sentinel节点发送的命令，那么将同意该请求，否则拒绝")]),s._v(" "),a("li",[s._v("如果该Sentinel节点发现自己的票数已经超过Sentinel集合半数且超过quorum，则将成为领导者")]),s._v(" "),a("li",[s._v("如果此过程有多个Sentinel节点成为了领导者，那么将等待一段时间重新选举")])]),s._v(" "),a("ul",[a("li",[s._v("选举实例\n"),a("img",{attrs:{src:"https://img-service.csdnimg.cn/img_convert/780616dab829e1a2bcc249be5fe34ea1.png",alt:""}})])]),s._v(" "),a("h1",{attrs:{id:"_8-故障转移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-故障转移"}},[s._v("#")]),s._v(" 8 故障转移")]),s._v(" "),a("h3",{attrs:{id:"领导者节点完成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#领导者节点完成"}},[s._v("#")]),s._v(" 领导者节点完成")]),s._v(" "),a("ol",[a("li",[s._v('从slave节点中选出一个“合适的"节点作为新的master节点')]),s._v(" "),a("li",[s._v("对上面的slave节点执行slaveof no one命令让其成为master节点")]),s._v(" "),a("li",[s._v("向剩余slave节点发送命令，让它们成为新master节点的slave节点，复制规则和parallel-syncs参数有关")]),s._v(" "),a("li",[s._v("更新对原来master节点配置为slave，并保持着对其关注，当其恢复后命令它去复制新的master节点。")])]),s._v(" "),a("h3",{attrs:{id:"选择合适的slave节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选择合适的slave节点"}},[s._v("#")]),s._v(" 选择合适的slave节点")]),s._v(" "),a("ol",[a("li",[s._v("选择slave priority(slave节点优先级)最高的slave节点，如果存在划返同，不存在则继续。")]),s._v(" "),a("li",[s._v("选择复制偏移量最大的slave节点(复制的最完整)，若存在则返回，不存在则\n继续。")]),s._v(" "),a("li",[s._v("选择runId最小的slave节点。")])]),s._v(" "),a("h1",{attrs:{id:"常见开发运维问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见开发运维问题"}},[s._v("#")]),s._v(" 常见开发运维问题")]),s._v(" "),a("h2",{attrs:{id:"节点运维"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点运维"}},[s._v("#")]),s._v(" 节点运维")]),s._v(" "),a("ul",[a("li",[s._v("机器下线:例如过保等情况")]),s._v(" "),a("li",[s._v("机器性能不足:例如CPU、内存、硬盘、网络等")]),s._v(" "),a("li",[s._v("节点自身故障:例如服务不稳定等")])]),s._v(" "),a("p",[s._v("主节点\n"),a("code",[s._v("sentinel failover <masterName>")]),s._v(" "),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200910035357117.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70#pic_center",alt:""}})]),s._v(" "),a("p",[s._v("节点下线")]),s._v(" "),a("ul",[a("li",[s._v("从节点:临时下线还是永久下线,例如是否做一些清理工作。但是要考虑读写分离的情况。")]),s._v(" "),a("li",[s._v("Sentinel节点: 同上。")])]),s._v(" "),a("p",[s._v("节点上线")]),s._v(" "),a("ul",[a("li",[s._v("主节点: sentinel failover进行替换")]),s._v(" "),a("li",[s._v("从节点: slaveof即可, sentinel节点可以感知")]),s._v(" "),a("li",[s._v("sentinel节点:参考其他sentinel节点启动即可。")])]),s._v(" "),a("p",[s._v("从节点的作用")]),s._v(" "),a("ol",[a("li",[s._v("副本：高可用基础")]),s._v(" "),a("li",[s._v("拓展读能力\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200909232846263.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_16,color_FFFFFF,t_70#pic_center",alt:""}})])]),s._v(" "),a("p",[s._v("由于Redis Sentinel只会对主节点进行故障转移,对从节点采取主观的下线,所以需要自定义一个客户端来监控对应的事件")]),s._v(" "),a("p",[s._v("三个消息")]),s._v(" "),a("ul",[a("li",[s._v("+switch-master :切换主节点(从节点晋升主节点)")]),s._v(" "),a("li",[s._v("+convert-to-slave :切换从节点(原主节点降为从节点)")]),s._v(" "),a("li",[s._v("+sdown:主观下线。")])]),s._v(" "),a("h1",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Redis Sentinel是Redis的高可用实现方案：\n故障发现、故障自动转移、配置中心、客户端通知。")])]),s._v(" "),a("li",[a("p",[s._v("Redis Sentinel从2.8版本开始才正式生产可用")])]),s._v(" "),a("li",[a("p",[s._v("尽可能在不同物理机上部署Redis Sentinel的所有节点")])]),s._v(" "),a("li",[a("p",[s._v("Redis Sentinel中的Sentinel节点个数应该≥3，且最好为奇数，便于选举")])]),s._v(" "),a("li",[a("p",[s._v("Redis Sentinel中的数据节点与普通数据节点无差异")])]),s._v(" "),a("li",[a("p",[s._v("客户端初始化时连接的是Sentinel节点集合，不再是具体的Redis节点，但\nSentinel只是配置中心，并非代理")])]),s._v(" "),a("li",[a("p",[s._v("Redis Sentinel通过三个定时任务实现了Sentinel节点对于主节点、从节点、\n其余Sentinel节点的监控")])]),s._v(" "),a("li",[a("p",[s._v("Redis Sentinel在对节点做失败判定时分为主观下线和客观下线")])]),s._v(" "),a("li",[a("p",[s._v("看懂Redis Sentinel故障转移日志对于Redis Sentinel以及问题排查非常有帮助")])]),s._v(" "),a("li",[a("p",[s._v("Redis Sentinel实现读写分离高可用可以依赖Sentinel节点的消息通知,获取Redis数据节点的状态变化")])])]),s._v(" "),a("p",[s._v("参考")]),s._v(" "),a("ul",[a("li",[s._v("https://hellokangning.github.io/zh/post/redis-sentinel-client-connection/")])])])}),[],!1,null,null,null);t.default=n.exports}}]);