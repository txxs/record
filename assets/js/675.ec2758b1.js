(window.webpackJsonp=window.webpackJsonp||[]).push([[675],{1065:function(e,s,n){"use strict";n.r(s);var a=n(13),t=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("p",[e._v("JAVA媒体提供任务机制来安全的终止线程。但是它提供了中断（interruption），这是一种写作机制，能够使一个线程终止另外一个线程。")]),e._v(" "),n("p",[e._v("一般来说没人希望立即终止，因为必要时总要先清理再终止。")]),e._v(" "),n("p",[e._v("开发一个应用能够妥善处理失败、关闭、取消等过程非常重要也有挑战。")]),e._v(" "),n("h3",{attrs:{id:"_7-1-任务取消"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-任务取消"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#71-%E4%BB%BB%E5%8A%A1%E5%8F%96%E6%B6%88"}}),e._v("7.1 任务取消")]),e._v(" "),n("p",[e._v("一定不要使用Thread.stop和suspend这些机制。")]),e._v(" "),n("p",[e._v("一种协作机制就是“标记位”。例如使用volatile类型的field来保存取消状态。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@ThreadSafe\npublic class PrimeGenerator implements Runnable {\n    private static ExecutorService exec = Executors.newCachedThreadPool();\n\n    @GuardedBy("this") private final List<BigInteger> primes\n            = new ArrayList<BigInteger>();\n    private volatile boolean cancelled;\n\n    public void run() {\n        BigInteger p = BigInteger.ONE;\n        while (!cancelled) {\n            p = p.nextProbablePrime();\n            synchronized (this) {\n                primes.add(p);\n            }\n        }\n    }\n\n    public void cancel() {\n        cancelled = true;\n    }\n\n    public synchronized List<BigInteger> get() {\n        return new ArrayList<BigInteger>(primes);\n    }\n\n    static List<BigInteger> aSecondOfPrimes() throws InterruptedException {\n        PrimeGenerator generator = new PrimeGenerator();\n        exec.execute(generator);\n        try {\n            SECONDS.sleep(1);\n        } finally {\n            generator.cancel();\n        }\n        return generator.get();\n    }\n}\n\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br")])]),n("p",[e._v("##1.1 中断\n下面的例子会出现死锁，线程根本不会停止")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("class BrokenPrimeProducer extends Thread {\n    private final BlockingQueue<BigInteger> queue;\n    private volatile boolean cancelled = false;\n\n    BrokenPrimeProducer(BlockingQueue<BigInteger> queue) {\n        this.queue = queue;\n    }\n\n    public void run() {\n        try {\n            BigInteger p = BigInteger.ONE;\n            while (!cancelled)\n                queue.put(p = p.nextProbablePrime());\n        } catch (InterruptedException consumed) {\n        }\n    }\n\n    public void cancel() {\n        cancelled = true;\n    }\n}\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br")])]),n("p",[e._v("interrupt 方法：中断目标线程。isInterrupted：返回目标线程的中断状态。静态的 interrupted方法：清除当前线程的中断状态，并返回它之前的值。大多数可中断的阻塞方法会在入口处检查中断状态")]),e._v(" "),n("p",[e._v("对中断操作（调用interrupt）的正确理解\n他并不会真正的中断一个正在运行的线程，而只是发出中断请求，然后由线程在下一个合适的时候中断自己。比如，wait、sleep、\njoin等方法，当他们收到中断请求或开始执行时，发现某个已经被设置好的中断状态，则抛出异常interruptedException。")]),e._v(" "),n("p",[e._v("每个线程都有一个boolean类型的中断状态。当调用Thread.interrupt方法时，该值被设置为true，Thread.interruptted可以恢复中断。")]),e._v(" "),n("p",[e._v("阻塞库方法，例如sleep和wait、join都会检查中断，并且发现中断则提前返回，他们会清楚中断状态，并抛出InterruptedException。")]),e._v(" "),n("p",[e._v("但是对于其他方法interrupt仅仅是传递了中断的请求消息，并不会使线程中断，需要由线程在下一个合适的时刻中断自己。")]),e._v(" "),n("p",[e._v("通常，用中断是取消的最合理的实现方式。")]),e._v(" "),n("p",[e._v("上面的例子的改进方法就是")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("public class PrimeProducer extends Thread {\n    private final BlockingQueue<BigInteger> queue;\n\n    PrimeProducer(BlockingQueue<BigInteger> queue) {\n        this.queue = queue;\n    }\n\n    public void run() {\n        try {\n            BigInteger p = BigInteger.ONE;\n            while (!Thread.currentThread().isInterrupted())\n                queue.put(p = p.nextProbablePrime());\n        } catch (InterruptedException consumed) {\n            /* Allow thread to exit */\n        }\n    }\n\n    public void cancel() {\n        interrupt();\n    }\n}\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br")])]),n("h4",{attrs:{id:"_7-1-2-中断策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2-中断策略"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#712-%E4%B8%AD%E6%96%AD%E7%AD%96%E7%95%A5"}}),e._v("7.1.2 中断策略")]),e._v(" "),n("p",[e._v("发生了中断，需要尽快退出执行流程，并把中断信息传递给调用者，从而使调用栈中的上层代码可以采取进一步的操作。当然任务也可以不需要放弃所有操作，可以推迟处理中断清楚，知道某个时机。")]),e._v(" "),n("h4",{attrs:{id:"_7-1-3-响应中断"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-3-响应中断"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#713-%E5%93%8D%E5%BA%94%E4%B8%AD%E6%96%AD"}}),e._v("7.1.3 响应中断")]),e._v(" "),n("ul",[n("li",[e._v("传递异常")]),e._v(" "),n("li",[e._v("回复中断状态")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("public class NoncancelableTask {\n    public Task getNextTask(BlockingQueue<Task> queue) {\n        boolean interrupted = false;\n        try {\n            while (true) {\n                try {\n                    return queue.take();\n                } catch (InterruptedException e) {\n                    interrupted = true;\n                    // fall through and retry\n                }\n            }\n        } finally {\n            if (interrupted)\n                Thread.currentThread().interrupt();\n        }\n    }\n\n    interface Task {\n    }\n}\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br")])]),n("h4",{attrs:{id:"_7-1-6-处理不可中断的阻塞"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-6-处理不可中断的阻塞"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#716-%E5%A4%84%E7%90%86%E4%B8%8D%E5%8F%AF%E4%B8%AD%E6%96%AD%E7%9A%84%E9%98%BB%E5%A1%9E"}}),e._v("7.1.6 处理不可中断的阻塞")]),e._v(" "),n("p",[e._v("例如Socket I/O或者内置锁都不能响应中断，这时候该如何做才能终止他们呢？可以通过重写Thread.interrupt方法，例如加入close的逻辑。")]),e._v(" "),n("h3",{attrs:{id:"_7-2-停止基于线程的服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-停止基于线程的服务"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#72-%E5%81%9C%E6%AD%A2%E5%9F%BA%E4%BA%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%9C%8D%E5%8A%A1"}}),e._v("7.2 停止基于线程的服务")]),e._v(" "),n("h4",{attrs:{id:"_7-2-1-示例-日志服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-1-示例-日志服务"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#721-%E7%A4%BA%E4%BE%8B%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1"}}),e._v("7.2.1 示例：日志服务")]),e._v(" "),n("h4",{attrs:{id:"_7-2-2-关闭executorservice"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-2-关闭executorservice"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#722-%E5%85%B3%E9%97%ADexecutorservice"}}),e._v("7.2.2 关闭ExecutorService")]),e._v(" "),n("h4",{attrs:{id:"_7-2-3-poison-pill"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-3-poison-pill"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#723-poison-pill"}}),e._v("7.2.3 Poison Pill")]),e._v(" "),n("p",[e._v("例如CloseEvent机制或者POISON对象，来做特殊的识别，从而让程序自己处理停止操作，退出线程。")]),e._v(" "),n("h3",{attrs:{id:"_7-3-处理非正常的线程终止"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-处理非正常的线程终止"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#73-%E5%A4%84%E7%90%86%E9%9D%9E%E6%AD%A3%E5%B8%B8%E7%9A%84%E7%BA%BF%E7%A8%8B%E7%BB%88%E6%AD%A2"}}),e._v("7.3 处理非正常的线程终止")]),e._v(" "),n("h3",{attrs:{id:"_7-4-jvm关闭"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-jvm关闭"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#74-jvm%E5%85%B3%E9%97%AD"}}),e._v("7.4 JVM关闭")]),e._v(" "),n("h2",{attrs:{id:"第8章-线程池的使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第8章-线程池的使用"}},[e._v("#")]),e._v(" "),n("a",{attrs:{href:"#%E7%AC%AC8%E7%AB%A0-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%BD%BF%E7%94%A8"}}),e._v("第8章 线程池的使用")]),e._v(" "),n("p",[e._v("一个很好的"),n("a",{attrs:{href:"https://my.oschina.net/xionghui/blog/494698",target:"_blank",rel:"noopener noreferrer"}},[e._v("ThreadPoolExecutor源码分析文档"),n("OutboundLink")],1)]),e._v(" "),n("p",[e._v("ThreadPoolExecutor UML图：")]),e._v(" "),n("p",[n("a",{attrs:{href:"https://camo.githubusercontent.com/c0809a89c8ec3367d66a4181e6ab39f380c8b2e8/687474703a2f2f6e656f72656d696e642e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031362f30392f6a6176612d372d636f6e63757272656e742d6578656375746f72732d756d6c2d636c6173732d6469616772616d2d6578616d706c652e706e67",target:"_blank",rel:"noopener noreferrer"}},[n("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-77840b3322b97eca?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image"}}),n("OutboundLink")],1)]),e._v(" "),n("p",[n("a",{attrs:{href:"https://camo.githubusercontent.com/6a87675bedf83eb673abb2c90025ebc35e52a584/687474703a2f2f6e656f72656d696e642e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031362f30392f6a6176612d372d636f6e63757272656e742d636f6c6c656374696f6e732d756d6c2d636c6173732d6469616772616d2d6578616d706c652e706e67",target:"_blank",rel:"noopener noreferrer"}},[n("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-4172f899bcf770d7?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image"}}),n("OutboundLink")],1)]),e._v(" "),n("p",[n("a",{attrs:{href:"https://camo.githubusercontent.com/2c7da5881649bfadbae9dec00dd5b4c45ffdeb74/687474703a2f2f6e656f72656d696e642e636f6d2f77702d636f6e74656e742f75706c6f6164732f323031362f30392f6a6176612d372d636f6e63757272656e742d6675747572652d756d6c2d636c6173732d6469616772616d2d6578616d706c652e706e67",target:"_blank",rel:"noopener noreferrer"}},[n("img",{attrs:{src:"http://upload-images.jianshu.io/upload_images/4685968-b0cc68de7aaba827?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image"}}),n("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=t.exports}}]);