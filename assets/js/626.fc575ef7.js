(window.webpackJsonp=window.webpackJsonp||[]).push([[626],{1016:function(e,s,n){"use strict";n.r(s);var a=n(13),t=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"table-of-contents"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#table-of-contents"}},[e._v("#")]),e._v(" Table of Contents")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E6%A6%82%E8%BF%B0"}},[e._v("æ¦‚è¿°")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#selector%E7%9A%84%E4%B8%AD%E7%9A%84%E9%87%8D%E8%A6%81%E5%B1%9E%E6%80%A7"}},[e._v("Selectorçš„ä¸­çš„é‡è¦å±æ€§")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#selector-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"}},[e._v("Selector æºç è§£æ")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#1%E3%80%81selector%E7%9A%84%E6%9E%84%E5%BB%BA"}},[e._v("1ã€Selectorçš„æ„å»º")]),e._v("\n* "),n("a",{attrs:{href:"#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9C%8B%E4%B8%8B-selectoropen%EF%BC%9A"}},[e._v("æ¥ä¸‹æ¥çœ‹ä¸‹ selector.open()ï¼š")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#epollselectorimpl"}},[e._v("EPollSelectorImpl")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#epollarraywrapper"}},[e._v("EPollArrayWrapper")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#serversocketchannel%E7%9A%84%E6%9E%84%E5%BB%BA"}},[e._v("ServerSocketChannelçš„æ„å»º")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#%E5%B0%86serversocketchannel%E6%B3%A8%E5%86%8C%E5%88%B0selector"}},[e._v("å°†ServerSocketChannelæ³¨å†Œåˆ°Selector")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#epollselectorimpl-implregister"}},[e._v("EPollSelectorImpl. implRegister")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#selection%E6%93%8D%E4%BD%9C"}},[e._v("Selectionæ“ä½œ")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#epoll%E5%8E%9F%E7%90%86"}},[e._v("epollåŸç†")])])])]),e._v(" "),n("li",[n("a",{attrs:{href:"#%E5%90%8E%E8%AE%B0"}},[e._v("åè®°")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"}},[e._v("å‚è€ƒæ–‡ç« ")])])]),e._v(" "),n("p",[e._v("æœ¬æ–‡è½¬è‡ªäº’è”ç½‘")]),e._v(" "),n("p",[e._v("æœ¬ç³»åˆ—æ–‡ç« å°†æ•´ç†åˆ°æˆ‘åœ¨GitHubä¸Šçš„ã€ŠJavaé¢è¯•æŒ‡å—ã€‹ä»“åº“ï¼Œæ›´å¤šç²¾å½©å†…å®¹è¯·åˆ°æˆ‘çš„ä»“åº“é‡ŒæŸ¥çœ‹")]),e._v(" "),n("blockquote",[n("p",[e._v("https://github.com/h2pl/Java-Tutorial")])]),e._v(" "),n("p",[e._v("å–œæ¬¢çš„è¯éº»çƒ¦ç‚¹ä¸‹Starå“ˆ")]),e._v(" "),n("p",[e._v("æ–‡ç« å°†åŒæ­¥åˆ°æˆ‘çš„ä¸ªäººåšå®¢ï¼š")]),e._v(" "),n("blockquote",[n("p",[e._v("www.how2playlife.com")])]),e._v(" "),n("p",[e._v("æœ¬æ–‡æ˜¯å¾®ä¿¡å…¬ä¼—å·ã€JavaæŠ€æœ¯æ±Ÿæ¹–ã€‘çš„ã€Šä¸å¯è½»è§†çš„Javaç½‘ç»œç¼–ç¨‹ã€‹å…¶ä¸­ä¸€ç¯‡ï¼Œæœ¬æ–‡éƒ¨åˆ†å†…å®¹æ¥æºäºç½‘ç»œï¼Œä¸ºäº†æŠŠæœ¬æ–‡ä¸»é¢˜è®²å¾—æ¸…æ™°é€å½»ï¼Œä¹Ÿæ•´åˆäº†å¾ˆå¤šæˆ‘è®¤ä¸ºä¸é”™çš„æŠ€æœ¯åšå®¢å†…å®¹ï¼Œå¼•ç”¨å…¶ä¸­äº†ä¸€äº›æ¯”è¾ƒå¥½çš„åšå®¢æ–‡ç« ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»ä½œè€…ã€‚")]),e._v(" "),n("p",[e._v("è¯¥ç³»åˆ—åšæ–‡ä¼šå‘Šè¯‰ä½ å¦‚ä½•ä»è®¡ç®—æœºç½‘ç»œçš„åŸºç¡€çŸ¥è¯†å…¥æ‰‹ï¼Œä¸€æ­¥æ­¥åœ°å­¦ä¹ Javaç½‘ç»œåŸºç¡€ï¼Œä»socketåˆ°nioã€bioã€aioå’Œnettyç­‰ç½‘ç»œç¼–ç¨‹çŸ¥è¯†ï¼Œå¹¶ä¸”è¿›è¡Œå®æˆ˜ï¼Œç½‘ç»œç¼–ç¨‹æ˜¯æ¯ä¸€ä¸ªJavaåç«¯å·¥ç¨‹å¸ˆå¿…é¡»è¦å­¦ä¹ å’Œç†è§£çš„çŸ¥è¯†ç‚¹ï¼Œè¿›ä¸€æ­¥æ¥è¯´ï¼Œä½ è¿˜éœ€è¦æŒæ¡Linuxä¸­çš„ç½‘ç»œç¼–ç¨‹åŸç†ï¼ŒåŒ…æ‹¬IOæ¨¡å‹ã€ç½‘ç»œç¼–ç¨‹æ¡†æ¶nettyçš„è¿›é˜¶åŸç†ï¼Œæ‰èƒ½æ›´å®Œæ•´åœ°äº†è§£æ•´ä¸ªJavaç½‘ç»œç¼–ç¨‹çš„çŸ¥è¯†ä½“ç³»ï¼Œå½¢æˆè‡ªå·±çš„çŸ¥è¯†æ¡†æ¶ã€‚")]),e._v(" "),n("p",[e._v("ä¸ºäº†æ›´å¥½åœ°æ€»ç»“å’Œæ£€éªŒä½ çš„å­¦ä¹ æˆæœï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¹Ÿä¼šæä¾›éƒ¨åˆ†çŸ¥è¯†ç‚¹å¯¹åº”çš„é¢è¯•é¢˜ä»¥åŠå‚è€ƒç­”æ¡ˆã€‚")]),e._v(" "),n("p",[e._v("å¦‚æœå¯¹æœ¬ç³»åˆ—æ–‡ç« æœ‰ä»€ä¹ˆå»ºè®®ï¼Œæˆ–è€…æ˜¯æœ‰ä»€ä¹ˆç–‘é—®çš„è¯ï¼Œä¹Ÿå¯ä»¥å…³æ³¨å…¬ä¼—å·ã€JavaæŠ€æœ¯æ±Ÿæ¹–ã€‘è”ç³»ä½œè€…ï¼Œæ¬¢è¿ä½ å‚ä¸æœ¬ç³»åˆ—åšæ–‡çš„åˆ›ä½œå’Œä¿®è®¢ã€‚")]),e._v(" "),n("h2",{attrs:{id:"æ¦‚è¿°"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#æ¦‚è¿°"}},[e._v("#")]),e._v(" æ¦‚è¿°")]),e._v(" "),n("p",[e._v("Selectoræ˜¯NIOä¸­å®ç°I/Oå¤šè·¯å¤ç”¨çš„å…³é”®ç±»ã€‚Selectorå®ç°äº†é€šè¿‡ä¸€ä¸ªçº¿ç¨‹ç®¡ç†å¤šä¸ªChannelï¼Œä»è€Œç®¡ç†å¤šä¸ªç½‘ç»œè¿æ¥çš„ç›®çš„ã€‚")]),e._v(" "),n("p",[e._v("Channelä»£è¡¨è¿™ä¸€ä¸ªç½‘ç»œè¿æ¥é€šé“ï¼Œæˆ‘ä»¬å¯ä»¥å°†Channelæ³¨å†Œåˆ°Selectorä¸­ä»¥å®ç°Selectorå¯¹å…¶çš„ç®¡ç†ã€‚ä¸€ä¸ªChannelå¯ä»¥æ³¨å†Œåˆ°å¤šä¸ªä¸åŒçš„Selectorä¸­ã€‚")]),e._v(" "),n("p",[e._v("å½“Channelæ³¨å†Œåˆ°Selectoråä¼šè¿”å›ä¸€ä¸ªSelectionKeyå¯¹è±¡ï¼Œè¯¥SelectionKeyå¯¹è±¡åˆ™ä»£è¡¨è¿™è¿™ä¸ªChannelå’Œå®ƒæ³¨å†Œçš„Selectoré—´çš„å…³ç³»ã€‚å¹¶ä¸”SelectionKeyä¸­ç»´æŠ¤ç€ä¸¤ä¸ªå¾ˆé‡è¦çš„å±æ€§ï¼šinterestOpsã€readyOps\ninterestOpsæ˜¯æˆ‘ä»¬å¸Œæœ›Selectorç›‘å¬Channelçš„å“ªäº›äº‹ä»¶ã€‚")]),e._v(" "),n("p",[e._v("æˆ‘ä»¬å°†æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶è®¾ç½®åˆ°è¯¥å­—æ®µï¼Œè¿™æ ·åœ¨selectionæ“ä½œæ—¶ï¼Œå½“å‘ç°è¯¥Channelæœ‰æˆ‘ä»¬æ‰€æ„Ÿå…´è¶£çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šå°†æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶å†è®¾ç½®åˆ°readyOpsä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾—çŸ¥æ˜¯å“ªäº›äº‹ä»¶å‘ç”Ÿäº†ä»¥åšç›¸åº”å¤„ç†ã€‚")]),e._v(" "),n("h2",{attrs:{id:"selectorçš„ä¸­çš„é‡è¦å±æ€§"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#selectorçš„ä¸­çš„é‡è¦å±æ€§"}},[e._v("#")]),e._v(" Selectorçš„ä¸­çš„é‡è¦å±æ€§")]),e._v(" "),n("p",[e._v("Selectorä¸­ç»´æŠ¤3ä¸ªç‰¹åˆ«é‡è¦çš„SelectionKeyé›†åˆï¼Œåˆ†åˆ«æ˜¯")]),e._v(" "),n("ul",[n("li",[e._v("keysï¼šæ‰€æœ‰æ³¨å†Œåˆ°Selectorçš„Channelæ‰€è¡¨ç¤ºçš„SelectionKeyéƒ½ä¼šå­˜åœ¨äºè¯¥é›†åˆä¸­ã€‚keyså…ƒç´ çš„æ·»åŠ ä¼šåœ¨Channelæ³¨å†Œåˆ°Selectoræ—¶å‘ç”Ÿã€‚")]),e._v(" "),n("li",[e._v("selectedKeysï¼šè¯¥é›†åˆä¸­çš„æ¯ä¸ªSelectionKeyéƒ½æ˜¯å…¶å¯¹åº”çš„Channelåœ¨ä¸Šä¸€æ¬¡æ“ä½œselectionæœŸé—´è¢«æ£€æŸ¥åˆ°è‡³å°‘æœ‰ä¸€ç§SelectionKeyä¸­æ‰€æ„Ÿå…´è¶£çš„æ“ä½œå·²ç»å‡†å¤‡å¥½è¢«å¤„ç†ã€‚è¯¥é›†åˆæ˜¯keysçš„ä¸€ä¸ªå­é›†ã€‚")]),e._v(" "),n("li",[e._v("cancelledKeysï¼šæ‰§è¡Œäº†å–æ¶ˆæ“ä½œçš„SelectionKeyä¼šè¢«æ”¾å…¥åˆ°è¯¥é›†åˆä¸­ã€‚è¯¥é›†åˆæ˜¯keysçš„ä¸€ä¸ªå­é›†ã€‚")])]),e._v(" "),n("p",[e._v("ä¸‹é¢çš„æºç è§£æä¼šè¯´æ˜ä¸Šé¢3ä¸ªé›†åˆçš„ç”¨å¤„")]),e._v(" "),n("h2",{attrs:{id:"selector-æºç è§£æ"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#selector-æºç è§£æ"}},[e._v("#")]),e._v(" Selector æºç è§£æ")]),e._v(" "),n("p",[e._v("ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€æ®µå¯¹Selectorçš„ä½¿ç”¨æµç¨‹è®²è§£æ¥è¿›ä¸€æ­¥æ·±å…¥å…¶å®ç°åŸç†ã€‚\né¦–å…ˆå…ˆæ¥æ®µSelectoræœ€ç®€å•çš„ä½¿ç”¨ç‰‡æ®µ")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("        ServerSocketChannel serverChannel = ServerSocketChannel.open();\n        serverChannel.configureBlocking(false);\n        int port = 5566;          \n        serverChannel.socket().bind(new InetSocketAddress(port));\n        Selector selector = Selector.open();\n        serverChannel.register(selector, SelectionKey.OP_ACCEPT);\n        while(true){\n            int n = selector.select();\n            if(n > 0) {\n                Iterator<SelectionKey> iter = selector.selectedKeys().iterator();\n                while (iter.hasNext()) {\n                    SelectionKey selectionKey = iter.next();\n                    ......\n                    iter.remove();\n                }\n            }\n        }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br")])]),n("h3",{attrs:{id:"_1ã€selectorçš„æ„å»º"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1ã€selectorçš„æ„å»º"}},[e._v("#")]),e._v(" 1ã€Selectorçš„æ„å»º")]),e._v(" "),n("p",[e._v("SocketChannelã€ServerSocketChannelå’ŒSelectorçš„å®ä¾‹åˆå§‹åŒ–éƒ½é€šè¿‡SelectorProviderç±»å®ç°ã€‚")]),e._v(" "),n("p",[e._v("ServerSocketChannel.open();")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    public static ServerSocketChannel open() throws IOException {\n        return SelectorProvider.provider().openServerSocketChannel();\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("SocketChannel.open();")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    public static SocketChannel open() throws IOException {\n        return SelectorProvider.provider().openSocketChannel();\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("Selector.open();")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    public static Selector open() throws IOException {\n        return SelectorProvider.provider().openSelector();\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("æˆ‘ä»¬æ¥è¿›ä¸€æ­¥çš„äº†è§£ä¸‹SelectorProvider.provider()")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    public static SelectorProvider provider() {\n        synchronized (lock) {\n            if (provider != null)\n                return provider;\n            return AccessController.doPrivileged(\n                new PrivilegedAction<>() {\n                    public SelectorProvider run() {\n                            if (loadProviderFromProperty())\n                                return provider;\n                            if (loadProviderAsService())\n                                return provider;\n                            provider = sun.nio.ch.DefaultSelectorProvider.create();\n                            return provider;\n                        }\n                    });\n        }\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br")])]),n("p",[e._v("â‘  å¦‚æœé…ç½®äº†â€œjava.nio.channels.spi.SelectorProviderâ€å±æ€§ï¼Œåˆ™é€šè¿‡è¯¥å±æ€§å€¼loadå¯¹åº”çš„SelectorProviderå¯¹è±¡ï¼Œå¦‚æœæ„å»ºå¤±è´¥åˆ™æŠ›å¼‚å¸¸ã€‚\nâ‘¡ å¦‚æœproviderç±»å·²ç»å®‰è£…åœ¨äº†å¯¹ç³»ç»Ÿç±»åŠ è½½ç¨‹åºå¯è§çš„jaråŒ…ä¸­ï¼Œå¹¶ä¸”è¯¥jaråŒ…çš„æºç ç›®å½•META-INF/servicesåŒ…å«æœ‰ä¸€ä¸ªjava.nio.channels.spi.SelectorProvideræä¾›ç±»é…ç½®æ–‡ä»¶ï¼Œåˆ™å–æ–‡ä»¶ä¸­ç¬¬ä¸€ä¸ªç±»åè¿›è¡Œloadä»¥æ„å»ºå¯¹åº”çš„SelectorProviderå¯¹è±¡ï¼Œå¦‚æœæ„å»ºå¤±è´¥åˆ™æŠ›å¼‚å¸¸ã€‚\nâ‘¢ å¦‚æœä¸Šé¢ä¸¤ç§æƒ…å†µéƒ½ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ç³»ç»Ÿé»˜è®¤çš„SelectorProviderï¼Œå³ï¼Œsun.nio.ch.DefaultSelectorProvider.create();\nâ‘£ éšååœ¨è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå³SelectorProvider.provider()ã€‚åˆ™è¿”å›ç¬¬ä¸€æ¬¡è°ƒç”¨çš„ç»“æœã€‚")]),e._v(" "),n("p",[e._v("ä¸åŒç³»ç»Ÿå¯¹åº”ç€ä¸åŒçš„sun.nio.ch.DefaultSelectorProvider")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://upload-images.jianshu.io/upload_images/4235178-a02c498e08979aff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/640/format/webp",alt:""}})]),e._v(" "),n("p",[e._v("è¿™é‡Œæˆ‘ä»¬çœ‹linuxä¸‹é¢çš„sun.nio.ch.DefaultSelectorProvider")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("public class DefaultSelectorProvider {\n\n    /**\n     * Prevent instantiation.\n     */\n    private DefaultSelectorProvider() { }\n\n    /**\n     * Returns the default SelectorProvider.\n     */\n    public static SelectorProvider create() {\n        return new sun.nio.ch.EPollSelectorProvider();\n    }\n\n}\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br")])]),n("p",[e._v("å¯ä»¥çœ‹è§ï¼Œlinuxç³»ç»Ÿä¸‹sun.nio.ch.DefaultSelectorProvider.create(); ä¼šç”Ÿæˆä¸€ä¸ªsun.nio.ch.EPollSelectorProviderç±»å‹çš„SelectorProviderï¼Œè¿™é‡Œå¯¹åº”äºlinuxç³»ç»Ÿçš„epoll")]),e._v(" "),n("h6",{attrs:{id:"æ¥ä¸‹æ¥çœ‹ä¸‹-selector-open"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#æ¥ä¸‹æ¥çœ‹ä¸‹-selector-open"}},[e._v("#")]),e._v(" æ¥ä¸‹æ¥çœ‹ä¸‹ selector.open()ï¼š")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    /**\n     * Opens a selector.\n     *\n     * <p> The new selector is created by invoking the {@link\n     * java.nio.channels.spi.SelectorProvider#openSelector openSelector} method\n     * of the system-wide default {@link\n     * java.nio.channels.spi.SelectorProvider} object.  </p>\n     *\n     * @return  A new selector\n     *\n     * @throws  IOException\n     *          If an I/O error occurs\n     */\n    public static Selector open() throws IOException {\n        return SelectorProvider.provider().openSelector();\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br")])]),n("p",[e._v("åœ¨å¾—åˆ°sun.nio.ch.EPollSelectorProvideråè°ƒç”¨openSelector()æ–¹æ³•æ„å»ºSelectorï¼Œè¿™é‡Œä¼šæ„å»ºä¸€ä¸ªEPollSelectorImplå¯¹è±¡ã€‚")]),e._v(" "),n("h3",{attrs:{id:"epollselectorimpl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#epollselectorimpl"}},[e._v("#")]),e._v(" EPollSelectorImpl")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("class EPollSelectorImpl\n    extends SelectorImpl\n{\n\n    // File descriptors used for interrupt\n    protected int fd0;\n    protected int fd1;\n\n    // The poll object\n    EPollArrayWrapper pollWrapper;\n\n    // Maps from file descriptors to keys\n    private Map<Integer,SelectionKeyImpl> fdToKey;\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("EPollSelectorImpl(SelectorProvider sp) throws IOException {\n        super(sp);\n        long pipeFds = IOUtil.makePipe(false);\n        fd0 = (int) (pipeFds >>> 32);\n        fd1 = (int) pipeFds;\n        try {\n            pollWrapper = new EPollArrayWrapper();\n            pollWrapper.initInterrupt(fd0, fd1);\n            fdToKey = new HashMap<>();\n        } catch (Throwable t) {\n            try {\n                FileDispatcherImpl.closeIntFD(fd0);\n            } catch (IOException ioe0) {\n                t.addSuppressed(ioe0);\n            }\n            try {\n                FileDispatcherImpl.closeIntFD(fd1);\n            } catch (IOException ioe1) {\n                t.addSuppressed(ioe1);\n            }\n            throw t;\n        }\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br")])]),n("p",[e._v("EPollSelectorImplæ„é€ å‡½æ•°å®Œæˆï¼š\nâ‘  EPollArrayWrapperçš„æ„å»ºï¼ŒEpollArrayWapperå°†Linuxçš„epollç›¸å…³ç³»ç»Ÿè°ƒç”¨å°è£…æˆäº†nativeæ–¹æ³•ä¾›EpollSelectorImplä½¿ç”¨ã€‚\nâ‘¡ é€šè¿‡EPollArrayWrapperå‘epollæ³¨å†Œä¸­æ–­äº‹ä»¶")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    void initInterrupt(int fd0, int fd1) {\n        outgoingInterruptFD = fd1;\n        incomingInterruptFD = fd0;\n        epollCtl(epfd, EPOLL_CTL_ADD, fd0, EPOLLIN);\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("p",[e._v("â‘¢ fdToKeyï¼šæ„å»ºæ–‡ä»¶æè¿°ç¬¦-SelectionKeyImplæ˜ å°„è¡¨ï¼Œæ‰€æœ‰æ³¨å†Œåˆ°selectorçš„channelå¯¹åº”çš„SelectionKeyå’Œä¸ä¹‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦éƒ½ä¼šæ”¾å…¥åˆ°è¯¥æ˜ å°„è¡¨ä¸­ã€‚")]),e._v(" "),n("h3",{attrs:{id:"epollarraywrapper"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#epollarraywrapper"}},[e._v("#")]),e._v(" EPollArrayWrapper")]),e._v(" "),n("p",[e._v("EPollArrayWrapperå®Œæˆäº†å¯¹epollæ–‡ä»¶æè¿°ç¬¦çš„æ„å»ºï¼Œä»¥åŠå¯¹linuxç³»ç»Ÿçš„epollæŒ‡ä»¤æ“çºµçš„å°è£…ã€‚ç»´æŠ¤æ¯æ¬¡selectionæ“ä½œçš„ç»“æœï¼Œå³epoll_waitç»“æœçš„epoll_eventæ•°ç»„ã€‚\nEPollArrayWrapperæ“çºµäº†ä¸€ä¸ªlinuxç³»ç»Ÿä¸‹epoll_eventç»“æ„çš„æœ¬åœ°æ•°ç»„ã€‚")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("* typedef union epoll_data {\n*     void *ptr;\n*     int fd;\n*     __uint32_t u32;\n*     __uint64_t u64;\n*  } epoll_data_t;\n*\n* struct epoll_event {\n*     __uint32_t events;\n*     epoll_data_t data;\n* };\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br")])]),n("p",[e._v("epoll_eventçš„æ•°æ®æˆå‘˜(epoll_data_t data)åŒ…å«æœ‰ä¸é€šè¿‡epoll_ctlå°†æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œåˆ°epollæ—¶è®¾ç½®çš„æ•°æ®ç›¸åŒçš„æ•°æ®ã€‚è¿™é‡Œdata.fdä¸ºæˆ‘ä»¬æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ ·æˆ‘ä»¬åœ¨å¤„ç†äº‹ä»¶çš„æ—¶å€™æŒæœ‰æœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦äº†ã€‚")]),e._v(" "),n("p",[e._v("EPollArrayWrapperå°†Linuxçš„epollç›¸å…³ç³»ç»Ÿè°ƒç”¨å°è£…æˆäº†nativeæ–¹æ³•ä¾›EpollSelectorImplä½¿ç”¨ã€‚")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    private native int epollCreate();\n    private native void epollCtl(int epfd, int opcode, int fd, int events);\n    private native int epollWait(long pollAddress, int numfds, long timeout,\n                                 int epfd) throws IOException;\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[e._v("ä¸Šè¿°ä¸‰ä¸ªnativeæ–¹æ³•å°±å¯¹åº”Linuxä¸‹epollç›¸å…³çš„ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    // The fd of the epoll driver\n    private final int epfd;\n\n     // The epoll_event array for results from epoll_wait\n    private final AllocatedNativeObject pollArray;\n\n    // Base address of the epoll_event array\n    private final long pollArrayAddress;\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    // ç”¨äºå­˜å‚¨å·²ç»æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦å’Œå…¶æ³¨å†Œç­‰å¾…æ”¹å˜çš„äº‹ä»¶çš„å…³è”å…³ç³»ã€‚åœ¨epoll_waitæ“ä½œå°±æ˜¯è¦æ£€æµ‹è¿™é‡Œæ–‡ä»¶æè¿°æ³•æ³¨å†Œçš„äº‹ä»¶æ˜¯å¦æœ‰å‘ç”Ÿã€‚\n    private final byte[] eventsLow = new byte[MAX_UPDATE_ARRAY_SIZE];\n    private final Map<Integer,Byte> eventsHigh = new HashMap<>();\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    EPollArrayWrapper() throws IOException {\n        // creates the epoll file descriptor\n        epfd = epollCreate();\n\n        // the epoll_event array passed to epoll_wait\n        int allocationSize = NUM_EPOLLEVENTS * SIZE_EPOLLEVENT;\n        pollArray = new AllocatedNativeObject(allocationSize, true);\n        pollArrayAddress = pollArray.address();\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br")])]),n("p",[e._v("EPoolArrayWrapperæ„é€ å‡½æ•°ï¼Œåˆ›å»ºäº†epollæ–‡ä»¶æè¿°ç¬¦ã€‚æ„å»ºäº†ä¸€ä¸ªç”¨äºå­˜æ”¾epoll_waitè¿”å›ç»“æœçš„epoll_eventæ•°ç»„ã€‚")]),e._v(" "),n("h3",{attrs:{id:"serversocketchannelçš„æ„å»º"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#serversocketchannelçš„æ„å»º"}},[e._v("#")]),e._v(" ServerSocketChannelçš„æ„å»º")]),e._v(" "),n("p",[e._v("ServerSocketChannel.open();")]),e._v(" "),n("p",[e._v("è¿”å›ServerSocketChannelImplå¯¹è±¡ï¼Œæ„å»ºlinuxç³»ç»Ÿä¸‹ServerSocketçš„æ–‡ä»¶æè¿°ç¬¦ã€‚")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    // Our file descriptor\n    private final FileDescriptor fd;\n\n    // fd value needed for dev/poll. This value will remain valid\n    // even after the value in the file descriptor object has been set to -1\n    private int fdVal;\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    ServerSocketChannelImpl(SelectorProvider sp) throws IOException {\n        super(sp);\n        this.fd =  Net.serverSocket(true);\n        this.fdVal = IOUtil.fdVal(fd);\n        this.state = ST_INUSE;\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("h3",{attrs:{id:"å°†serversocketchannelæ³¨å†Œåˆ°selector"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#å°†serversocketchannelæ³¨å†Œåˆ°selector"}},[e._v("#")]),e._v(" å°†ServerSocketChannelæ³¨å†Œåˆ°Selector")]),e._v(" "),n("p",[e._v("serverChannel.register(selector, SelectionKey.OP_ACCEPT);")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    public final SelectionKey register(Selector sel, int ops,\n                                       Object att)\n        throws ClosedChannelException\n    {\n        synchronized (regLock) {\n            if (!isOpen())\n                throw new ClosedChannelException();\n            if ((ops & ~validOps()) != 0)\n                throw new IllegalArgumentException();\n            if (blocking)\n                throw new IllegalBlockingModeException();\n            SelectionKey k = findKey(sel);\n            if (k != null) {\n                k.interestOps(ops);\n                k.attach(att);\n            }\n            if (k == null) {\n                // New registration\n                synchronized (keyLock) {\n                    if (!isOpen())\n                        throw new ClosedChannelException();\n                    k = ((AbstractSelector)sel).register(this, ops, att);\n                    addKey(k);\n                }\n            }\n            return k;\n        }\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    protected final SelectionKey register(AbstractSelectableChannel ch,\n                                          int ops,\n                                          Object attachment)\n    {\n        if (!(ch instanceof SelChImpl))\n            throw new IllegalSelectorException();\n        SelectionKeyImpl k = new SelectionKeyImpl((SelChImpl)ch, this);\n        k.attach(attachment);\n        synchronized (publicKeys) {\n            implRegister(k);\n        }\n        k.interestOps(ops);\n        return k;\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("p",[e._v("â‘  æ„å»ºä»£è¡¨channelå’Œselectoré—´å…³ç³»çš„SelectionKeyå¯¹è±¡\nâ‘¡ implRegister(k)å°†channelæ³¨å†Œåˆ°epollä¸­\nâ‘¢ k.interestOps(int) å®Œæˆä¸‹é¢ä¸¤ä¸ªæ“ä½œï¼š\na) ä¼šå°†æ³¨å†Œçš„æ„Ÿå…´è¶£çš„äº‹ä»¶å’Œå…¶å¯¹åº”çš„æ–‡ä»¶æè¿°å­˜å‚¨åˆ°EPollArrayWrapperå¯¹è±¡çš„eventsLowæˆ–eventsHighä¸­ï¼Œè¿™æ˜¯ç»™åº•å±‚å®ç°epoll_waitæ—¶ä½¿ç”¨çš„ã€‚\nb) åŒæ—¶è¯¥æ“ä½œè¿˜ä¼šå°†è®¾ç½®SelectionKeyçš„interestOpså­—æ®µï¼Œè¿™æ˜¯ç»™æˆ‘ä»¬ç¨‹åºå‘˜è·å–ä½¿ç”¨çš„ã€‚")]),e._v(" "),n("h3",{attrs:{id:"epollselectorimpl-implregister"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#epollselectorimpl-implregister"}},[e._v("#")]),e._v(" EPollSelectorImpl. implRegister")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    protected void implRegister(SelectionKeyImpl ski) {\n        if (closed)\n            throw new ClosedSelectorException();\n        SelChImpl ch = ski.channel;\n        int fd = Integer.valueOf(ch.getFDVal());\n        fdToKey.put(fd, ski);\n        pollWrapper.add(fd);\n        keys.add(ski);\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br")])]),n("p",[e._v("â‘  å°†channelå¯¹åº”çš„fd(æ–‡ä»¶æè¿°ç¬¦)å’Œå¯¹åº”çš„SelectionKeyImplæ”¾åˆ°fdToKeyæ˜ å°„è¡¨ä¸­ã€‚\nâ‘¡ å°†channelå¯¹åº”çš„fd(æ–‡ä»¶æè¿°ç¬¦)æ·»åŠ åˆ°EPollArrayWrapperä¸­ï¼Œå¹¶å¼ºåˆ¶åˆå§‹åŒ–fdçš„äº‹ä»¶ä¸º0 ( å¼ºåˆ¶åˆå§‹æ›´æ–°äº‹ä»¶ä¸º0ï¼Œå› ä¸ºè¯¥äº‹ä»¶å¯èƒ½å­˜åœ¨äºä¹‹å‰è¢«å–æ¶ˆè¿‡çš„æ³¨å†Œä¸­ã€‚)\nâ‘¢ å°†selectionKeyæ”¾å…¥åˆ°keysé›†åˆä¸­ã€‚")]),e._v(" "),n("h3",{attrs:{id:"selectionæ“ä½œ"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#selectionæ“ä½œ"}},[e._v("#")]),e._v(" Selectionæ“ä½œ")]),e._v(" "),n("p",[e._v("selectionæ“ä½œæœ‰3ä¸­ç±»å‹ï¼š\nâ‘  select()ï¼šè¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ç›´åˆ°è‡³å°‘ä¸€ä¸ªchannelè¢«é€‰æ‹©(å³ï¼Œè¯¥channelæ³¨å†Œçš„äº‹ä»¶å‘ç”Ÿäº†)ä¸ºæ­¢ï¼Œé™¤éå½“å‰çº¿ç¨‹å‘ç”Ÿä¸­æ–­æˆ–è€…selectorçš„wakeupæ–¹æ³•è¢«è°ƒç”¨ã€‚\nâ‘¡ select(long time)ï¼šè¯¥æ–¹æ³•å’Œselect()ç±»ä¼¼ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šå¯¼è‡´é˜»å¡ç›´åˆ°è‡³å°‘ä¸€ä¸ªchannelè¢«é€‰æ‹©(å³ï¼Œè¯¥channelæ³¨å†Œçš„äº‹ä»¶å‘ç”Ÿäº†)ä¸ºæ­¢ï¼Œé™¤éä¸‹é¢3ç§æƒ…å†µä»»æ„ä¸€ç§å‘ç”Ÿï¼ša) è®¾ç½®çš„è¶…æ—¶æ—¶é—´åˆ°è¾¾ï¼›b) å½“å‰çº¿ç¨‹å‘ç”Ÿä¸­æ–­ï¼›c) selectorçš„wakeupæ–¹æ³•è¢«è°ƒç”¨\nâ‘¢ selectNow()ï¼šè¯¥æ–¹æ³•ä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªchannelè¢«é€‰æ‹©ä¹Ÿä¼šç«‹å³è¿”å›ã€‚")]),e._v(" "),n("p",[e._v("æˆ‘ä»¬ä¸»è¦æ¥çœ‹çœ‹select()çš„å®ç° ï¼šint n = selector.select();")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    public int select() throws IOException {\n        return select(0);\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("æœ€ç»ˆä¼šè°ƒç”¨åˆ°EPollSelectorImplçš„doSelect")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    protected int doSelect(long timeout) throws IOException {\n        if (closed)\n            throw new ClosedSelectorException();\n        processDeregisterQueue();\n        try {\n            begin();\n            pollWrapper.poll(timeout);\n        } finally {\n            end();\n        }\n        processDeregisterQueue();\n        int numKeysUpdated = updateSelectedKeys();\n        if (pollWrapper.interrupted()) {\n            // Clear the wakeup pipe\n            pollWrapper.putEventOps(pollWrapper.interruptedIndex(), 0);\n            synchronized (interruptLock) {\n                pollWrapper.clearInterrupted();\n                IOUtil.drain(fd0);\n                interruptTriggered = false;\n            }\n        }\n        return numKeysUpdated;\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br")])]),n("p",[e._v("â‘  å…ˆå¤„ç†æ³¨é”€çš„selectionKeyé˜Ÿåˆ—\nâ‘¡ è¿›è¡Œåº•å±‚çš„epoll_waitæ“ä½œ\nâ‘¢ å†æ¬¡å¯¹æ³¨é”€çš„selectionKeyé˜Ÿåˆ—è¿›è¡Œå¤„ç†\nâ‘£ æ›´æ–°è¢«é€‰æ‹©çš„selectionKey")]),e._v(" "),n("p",[e._v("å…ˆæ¥çœ‹processDeregisterQueue():")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('    void processDeregisterQueue() throws IOException {\n        Set var1 = this.cancelledKeys();\n        synchronized(var1) {\n            if (!var1.isEmpty()) {\n                Iterator var3 = var1.iterator();\n\n                while(var3.hasNext()) {\n                    SelectionKeyImpl var4 = (SelectionKeyImpl)var3.next();\n\n                    try {\n                        this.implDereg(var4);\n                    } catch (SocketException var12) {\n                        IOException var6 = new IOException("Error deregistering key");\n                        var6.initCause(var12);\n                        throw var6;\n                    } finally {\n                        var3.remove();\n                    }\n                }\n            }\n\n        }\n    }\n\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br")])]),n("p",[e._v("ä»cancelledKeysé›†åˆä¸­ä¾æ¬¡å–å‡ºæ³¨é”€çš„SelectionKeyï¼Œæ‰§è¡Œæ³¨é”€æ“ä½œï¼Œå°†å¤„ç†åçš„SelectionKeyä»cancelledKeysé›†åˆä¸­ç§»é™¤ã€‚æ‰§è¡ŒprocessDeregisterQueue()åcancelledKeysé›†åˆä¼šä¸ºç©ºã€‚")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    protected void implDereg(SelectionKeyImpl ski) throws IOException {\n        assert (ski.getIndex() >= 0);\n        SelChImpl ch = ski.channel;\n        int fd = ch.getFDVal();\n        fdToKey.remove(Integer.valueOf(fd));\n        pollWrapper.remove(fd);\n        ski.setIndex(-1);\n        keys.remove(ski);\n        selectedKeys.remove(ski);\n        deregister((AbstractSelectionKey)ski);\n        SelectableChannel selch = ski.channel();\n        if (!selch.isOpen() && !selch.isRegistered())\n            ((SelChImpl)selch).kill();\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("p",[e._v("æ³¨é”€ä¼šå®Œæˆä¸‹é¢çš„æ“ä½œï¼š\nâ‘  å°†å·²ç»æ³¨é”€çš„selectionKeyä»fdToKey( æ–‡ä»¶æè¿°ä¸SelectionKeyImplçš„æ˜ å°„è¡¨ )ä¸­ç§»é™¤\nâ‘¡ å°†selectionKeyæ‰€ä»£è¡¨çš„channelçš„æ–‡ä»¶æè¿°ç¬¦ä»EPollArrayWrapperä¸­ç§»é™¤\nâ‘¢ å°†selectionKeyä»keysé›†åˆä¸­ç§»é™¤ï¼Œè¿™æ ·ä¸‹æ¬¡selector.select()å°±ä¸ä¼šå†å°†è¯¥selectionKeyæ³¨å†Œåˆ°epollä¸­ç›‘å¬\nâ‘£ ä¹Ÿä¼šå°†selectionKeyä»å¯¹åº”çš„channelä¸­æ³¨é”€\nâ‘¤ æœ€åå¦‚æœå¯¹åº”çš„channelå·²ç»å…³é—­å¹¶ä¸”æ²¡æœ‰æ³¨å†Œå…¶ä»–çš„selectoräº†ï¼Œåˆ™å°†è¯¥channelå…³é—­\nå®ŒæˆğŸ‘†çš„æ“ä½œåï¼Œæ³¨é”€çš„SelectionKeyå°±ä¸ä¼šå‡ºç°å…ˆåœ¨keysã€selectedKeysä»¥åŠcancelKeysè¿™3ä¸ªé›†åˆä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚")]),e._v(" "),n("p",[e._v("æ¥ç€æˆ‘ä»¬æ¥çœ‹EPollArrayWrapper.poll(timeout)ï¼š")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    int poll(long timeout) throws IOException {\n        updateRegistrations();\n        updated = epollWait(pollArrayAddress, NUM_EPOLLEVENTS, timeout, epfd);\n        for (int i=0; i<updated; i++) {\n            if (getDescriptor(i) == incomingInterruptFD) {\n                interruptedIndex = i;\n                interrupted = true;\n                break;\n            }\n        }\n        return updated;\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br")])]),n("p",[e._v("updateRegistrations()æ–¹æ³•ä¼šå°†å·²ç»æ³¨å†Œåˆ°è¯¥selectorçš„äº‹ä»¶(eventsLowæˆ–eventsHigh)é€šè¿‡è°ƒç”¨epollCtl(epfd, opcode, fd, events); æ³¨å†Œåˆ°linuxç³»ç»Ÿä¸­ã€‚\nè¿™é‡ŒepollWaitå°±ä¼šè°ƒç”¨linuxåº•å±‚çš„epoll_waitæ–¹æ³•ï¼Œå¹¶è¿”å›åœ¨epoll_waitæœŸé—´æœ‰äº‹ä»¶è§¦å‘çš„entryçš„ä¸ªæ•°")]),e._v(" "),n("p",[e._v("å†çœ‹updateSelectedKeys()ï¼š")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    private int updateSelectedKeys() {\n        int entries = pollWrapper.updated;\n        int numKeysUpdated = 0;\n        for (int i=0; i<entries; i++) {\n            int nextFD = pollWrapper.getDescriptor(i);\n            SelectionKeyImpl ski = fdToKey.get(Integer.valueOf(nextFD));\n            // ski is null in the case of an interrupt\n            if (ski != null) {\n                int rOps = pollWrapper.getEventOps(i);\n                if (selectedKeys.contains(ski)) {\n                    if (ski.channel.translateAndSetReadyOps(rOps, ski)) {\n                        numKeysUpdated++;\n                    }\n                } else {\n                    ski.channel.translateAndSetReadyOps(rOps, ski);\n                    if ((ski.nioReadyOps() & ski.nioInterestOps()) != 0) {\n                        selectedKeys.add(ski);\n                        numKeysUpdated++;\n                    }\n                }\n            }\n        }\n        return numKeysUpdated;\n    }\n\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br")])]),n("p",[e._v("è¯¥æ–¹æ³•ä¼šä»é€šè¿‡EPollArrayWrapper pollWrapper ä»¥åŠ fdToKey( æ„å»ºæ–‡ä»¶æè¿°ç¬¦-SelectorKeyImplæ˜ å°„è¡¨ )æ¥è·å–æœ‰äº‹ä»¶è§¦å‘çš„SelectionKeyImplå¯¹è±¡ï¼Œç„¶åå°†SelectionKeyImplæ”¾åˆ°selectedKeyé›†åˆ( æœ‰äº‹ä»¶è§¦å‘çš„selectionKeyé›†åˆï¼Œå¯ä»¥é€šè¿‡selector.selectedKeys()æ–¹æ³•è·å¾— )ä¸­ï¼Œå³selectedKeysã€‚å¹¶é‡æ–°è®¾ç½®SelectionKeyImplä¸­ç›¸å…³çš„readyOpså€¼ã€‚")]),e._v(" "),n("p",[e._v("ä½†æ˜¯ï¼Œè¿™é‡Œè¦æ³¨æ„ä¸¤ç‚¹ï¼š")]),e._v(" "),n("p",[e._v("â‘  å¦‚æœSelectionKeyImplå·²ç»å­˜åœ¨äºselectedKeysé›†åˆä¸­ï¼Œå¹¶ä¸”å‘ç°è§¦å‘çš„äº‹ä»¶å·²ç»å­˜åœ¨äºreadyOpsä¸­äº†ï¼Œåˆ™ä¸ä¼šä½¿numKeysUpdated++ï¼›è¿™æ ·ä¼šä½¿å¾—æˆ‘ä»¬æ— æ³•å¾—çŸ¥è¯¥äº‹ä»¶çš„å˜åŒ–ã€‚")]),e._v(" "),n("p",[e._v("ğŸ‘†è¿™ç‚¹è¯´æ˜äº†ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åœ¨æ¯æ¬¡ä»selectedKeyä¸­è·å–åˆ°Selectionkeyåï¼Œå°†å…¶ä»selectedKeyé›†åˆç§»é™¤ï¼Œå°±æ˜¯ä¸ºäº†å½“æœ‰äº‹ä»¶è§¦å‘ä½¿selectionKeyèƒ½æ­£ç¡®åˆ°æ”¾å…¥selectedKeyé›†åˆä¸­ï¼Œå¹¶æ­£ç¡®çš„é€šçŸ¥ç»™è°ƒç”¨è€…ã€‚")]),e._v(" "),n("p",[e._v("å†è€…ï¼Œå¦‚æœä¸å°†å·²ç»å¤„ç†çš„SelectionKeyä»selectedKeyé›†åˆä¸­ç§»é™¤ï¼Œé‚£ä¹ˆä¸‹æ¬¡æœ‰æ–°äº‹ä»¶åˆ°æ¥æ—¶ï¼Œåœ¨éå†selectedKeyé›†åˆæ—¶åˆä¼šéå†åˆ°è¿™ä¸ªSelectionKeyï¼Œè¿™ä¸ªæ—¶å€™å°±å¾ˆå¯èƒ½å‡ºé”™äº†ã€‚æ¯”å¦‚ï¼Œå¦‚æœæ²¡æœ‰åœ¨å¤„ç†å®ŒOP_ACCEPTäº‹ä»¶åå°†å¯¹åº”SelectionKeyä»selectedKeyé›†åˆç§»é™¤ï¼Œé‚£ä¹ˆä¸‹æ¬¡éå†selectedKeyé›†åˆæ—¶ï¼Œå¤„ç†åˆ°åˆ°è¯¥SelectionKeyï¼Œç›¸åº”çš„ServerSocketChannel.accept()å°†è¿”å›ä¸€ä¸ªç©º(null)çš„SocketChannelã€‚")]),e._v(" "),n("p",[e._v("â‘¡ å¦‚æœå‘ç°channelæ‰€å‘ç”ŸI/Oäº‹ä»¶ä¸æ˜¯å½“å‰SelectionKeyæ‰€æ„Ÿå…´è¶£ï¼Œåˆ™ä¸ä¼šå°†SelectionKeyImplæ”¾å…¥selectedKeysé›†åˆä¸­ï¼Œä¹Ÿä¸ä¼šä½¿numKeysUpdated++")]),e._v(" "),n("h3",{attrs:{id:"epollåŸç†"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#epollåŸç†"}},[e._v("#")]),e._v(" epollåŸç†")]),e._v(" "),n("p",[e._v("selectï¼Œpollï¼Œepolléƒ½æ˜¯IOå¤šè·¯å¤ç”¨çš„æœºåˆ¶ã€‚I/Oå¤šè·¯å¤ç”¨å°±æ˜¯é€šè¿‡ä¸€ç§æœºåˆ¶ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç›‘è§†å¤šä¸ªæè¿°ç¬¦ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œã€‚ä½†selectï¼Œpollï¼Œepollæœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥I/Oï¼Œå› ä¸ºä»–ä»¬éƒ½éœ€è¦åœ¨è¯»å†™äº‹ä»¶å°±ç»ªåè‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œè€Œå¼‚æ­¥I/Oåˆ™æ— éœ€è‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œå¼‚æ­¥I/Oçš„å®ç°ä¼šè´Ÿè´£æŠŠæ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚")]),e._v(" "),n("p",[e._v("epollæ˜¯Linuxä¸‹çš„ä¸€ç§IOå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆçš„å¤„ç†æ•°ä»¥ç™¾ä¸‡è®¡çš„socketå¥æŸ„ã€‚")]),e._v(" "),n("p",[e._v("åœ¨ select/pollä¸­ï¼Œè¿›ç¨‹åªæœ‰åœ¨è°ƒç”¨ä¸€å®šçš„æ–¹æ³•åï¼Œå†…æ ¸æ‰å¯¹æ‰€æœ‰ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ‰«æï¼Œè€Œepolläº‹å…ˆé€šè¿‡epoll_ctl()æ¥æ³¨å†Œä¸€ ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ—¦åŸºäºæŸä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šé‡‡ç”¨ç±»ä¼¼callbackçš„å›è°ƒæœºåˆ¶ï¼Œè¿…é€Ÿæ¿€æ´»è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“è¿›ç¨‹è°ƒç”¨epoll_wait() æ—¶ä¾¿å¾—åˆ°é€šçŸ¥ã€‚(æ­¤å¤„å»æ‰äº†éå†æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œæ˜¯é€šè¿‡ç›‘å¬å›è°ƒçš„çš„æœºåˆ¶ã€‚è¿™æ­£æ˜¯epollçš„é­…åŠ›æ‰€åœ¨ã€‚)\nå¦‚æœæ²¡æœ‰å¤§é‡çš„idle -connectionæˆ–è€…dead-connectionï¼Œepollçš„æ•ˆç‡å¹¶ä¸ä¼šæ¯”select/pollé«˜å¾ˆå¤šï¼Œä½†æ˜¯å½“é‡åˆ°å¤§é‡çš„idle- connectionï¼Œå°±ä¼šå‘ç°epollçš„æ•ˆç‡å¤§å¤§é«˜äºselect/pollã€‚")]),e._v(" "),n("p",[e._v("æ³¨æ„ï¼šlinuxä¸‹Selectoråº•å±‚æ˜¯é€šè¿‡epollæ¥å®ç°çš„ï¼Œå½“åˆ›å»ºå¥½epollå¥æŸ„åï¼Œå®ƒå°±ä¼šå ç”¨ä¸€ä¸ªfdå€¼ï¼Œåœ¨linuxä¸‹å¦‚æœæŸ¥çœ‹/proc/è¿›ç¨‹id/fd/ï¼Œæ˜¯èƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªfdçš„ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å®Œepollåï¼Œå¿…é¡»è°ƒç”¨close()å…³é—­ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´fdè¢«è€—å°½ã€‚")]),e._v(" "),n("p",[e._v("å…ˆçœ‹çœ‹ä½¿ç”¨cå°è£…çš„3ä¸ªepollç³»ç»Ÿè°ƒç”¨:")]),e._v(" "),n("ul",[n("li",[n("p",[n("strong",[e._v("int epoll_create(int size)")]),e._v("\nepoll_createå»ºç«‹ä¸€ä¸ªepollå¯¹è±¡ã€‚å‚æ•°sizeæ˜¯å†…æ ¸ä¿è¯èƒ½å¤Ÿæ­£ç¡®å¤„ç†çš„æœ€å¤§å¥æŸ„æ•°ï¼Œå¤šäºè¿™ä¸ªæœ€å¤§æ•°æ—¶å†…æ ¸å¯ä¸ä¿è¯æ•ˆæœã€‚")])]),e._v(" "),n("li",[n("p",[e._v("*"),n("em",[e._v("int epoll_ctl(int epfd, int op, int fd, struct epoll_event "),n("em",[e._v("event)")])]),e._v("\nepoll_ctlå¯ä»¥æ“ä½œepoll_createåˆ›å»ºçš„epollï¼Œå¦‚å°†socketå¥æŸ„åŠ å…¥åˆ°epollä¸­è®©å…¶ç›‘æ§ï¼Œæˆ–æŠŠepollæ­£åœ¨ç›‘æ§çš„æŸä¸ªsocketå¥æŸ„ç§»å‡ºepollã€‚")])]),e._v(" "),n("li",[n("p",[e._v("*"),n("em",[e._v("int epoll_wait(int epfd, struct epoll_event "),n("em",[e._v("events,int maxevents, int timeout)")])]),e._v("\nepoll_waitåœ¨è°ƒç”¨æ—¶ï¼Œåœ¨ç»™å®šçš„timeoutæ—¶é—´å†…ï¼Œæ‰€ç›‘æ§çš„å¥æŸ„ä¸­æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±è¿”å›ç”¨æˆ·æ€çš„è¿›ç¨‹ã€‚")]),e._v(" "),n("p",[e._v("å¤§æ¦‚çœ‹çœ‹epollå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼š")])])]),e._v(" "),n("ol",[n("li",[n("p",[e._v("epollåˆå§‹åŒ–æ—¶ï¼Œä¼šå‘å†…æ ¸æ³¨å†Œä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨è¢«ç›‘æ§çš„å¥æŸ„æ–‡ä»¶ï¼Œè°ƒç”¨epoll_createæ—¶ï¼Œä¼šåœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªfileèŠ‚ç‚¹ã€‚åŒæ—¶epollä¼šå¼€è¾Ÿè‡ªå·±çš„å†…æ ¸é«˜é€Ÿç¼“å­˜åŒºï¼Œä»¥çº¢é»‘æ ‘çš„ç»“æ„ä¿å­˜å¥æŸ„ï¼Œä»¥æ”¯æŒå¿«é€Ÿçš„æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ã€‚è¿˜ä¼šå†å»ºç«‹ä¸€ä¸ªlisté“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ã€‚")])]),e._v(" "),n("li",[n("p",[e._v("å½“æ‰§è¡Œepoll_ctlæ—¶ï¼Œé™¤äº†æŠŠsocketå¥æŸ„æ”¾åˆ°epollæ–‡ä»¶ç³»ç»Ÿé‡Œfileå¯¹è±¡å¯¹åº”çš„çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜ä¼šç»™å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå‘Šè¯‰å†…æ ¸ï¼Œå¦‚æœè¿™ä¸ªå¥æŸ„çš„ä¸­æ–­åˆ°äº†ï¼Œå°±æŠŠå®ƒæ”¾åˆ°å‡†å¤‡å°±ç»ªlisté“¾è¡¨é‡Œã€‚æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªsocketä¸Šæœ‰æ•°æ®åˆ°äº†ï¼Œå†…æ ¸åœ¨æŠŠç½‘å¡ä¸Šçš„æ•°æ®copyåˆ°å†…æ ¸ä¸­åï¼Œå°±æŠŠsocketæ’å…¥åˆ°å°±ç»ªé“¾è¡¨é‡Œã€‚")])]),e._v(" "),n("li",[n("p",[e._v("å½“epoll_waitè°ƒç”¨æ—¶ï¼Œä»…ä»…è§‚å¯Ÿå°±ç»ªé“¾è¡¨é‡Œæœ‰æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰æ•°æ®å°±è¿”å›ï¼Œå¦åˆ™å°±sleepï¼Œè¶…æ—¶æ—¶ç«‹åˆ»è¿”å›ã€‚")]),e._v(" "),n("p",[e._v("epollçš„ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š")])])]),e._v(" "),n("ul",[n("li",[e._v("LTï¼šlevel-triggerï¼Œæ°´å¹³è§¦å‘æ¨¡å¼ï¼Œåªè¦æŸä¸ªsocketå¤„äºreadable/writableçŠ¶æ€ï¼Œæ— è®ºä»€ä¹ˆæ—¶å€™è¿›è¡Œepoll_waitéƒ½ä¼šè¿”å›è¯¥socketã€‚")]),e._v(" "),n("li",[e._v("ETï¼šedge-triggerï¼Œè¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œåªæœ‰æŸä¸ªsocketä»unreadableå˜ä¸ºreadableæˆ–ä»unwritableå˜ä¸ºwritableæ—¶ï¼Œepoll_waitæ‰ä¼šè¿”å›è¯¥socketã€‚")])]),e._v(" "),n("p",[e._v("socketè¯»æ•°æ®")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://upload-images.jianshu.io/upload_images/4235178-55ea1cf846c7d84c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/540/format/webp",alt:""}})]),e._v(" "),n("p",[e._v("socketå†™æ•°æ®")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://upload-images.jianshu.io/upload_images/4235178-39c86c1d52d6abce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/585/format/webp",alt:""}})]),e._v(" "),n("p",[e._v("æœ€åé¡ºä¾¿è¯´ä¸‹åœ¨Linuxç³»ç»Ÿä¸­JDK NIOä½¿ç”¨çš„æ˜¯ LT ï¼Œè€ŒNetty epollä½¿ç”¨çš„æ˜¯ ETã€‚")]),e._v(" "),n("h2",{attrs:{id:"åè®°"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#åè®°"}},[e._v("#")]),e._v(" åè®°")]),e._v(" "),n("p",[e._v("å› ä¸ºæœ¬äººå¯¹è®¡ç®—æœºç³»ç»Ÿç»„æˆä»¥åŠCè¯­è¨€ç­‰çŸ¥è¯†æ¯”è¾ƒæ¬ ç¼ºï¼Œå› ä¸ºæ–‡ä¸­ç›¸å…³çŸ¥è¯†ç‚¹çš„è¡¨ç¤ºä¹Ÿç›¸å½“â€œè‚¤æµ…â€ï¼Œå¦‚æœ‰ä¸å¯¹ä¸å¦¥çš„åœ°æ–¹æœ›è¯»è€…æŒ‡å‡ºã€‚åŒæ—¶æˆ‘ä¹Ÿä¼šç»§ç»­åŠ å¼ºå¯¹è¯¥æ–¹é¢çŸ¥è¯†ç‚¹çš„å­¦ä¹ ~")]),e._v(" "),n("h2",{attrs:{id:"å‚è€ƒæ–‡ç« "}},[n("a",{staticClass:"header-anchor",attrs:{href:"#å‚è€ƒæ–‡ç« "}},[e._v("#")]),e._v(" å‚è€ƒæ–‡ç« ")]),e._v(" "),n("p",[n("a",{attrs:{href:"https://www.jianshu.com/p/0d497fe5484a",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://www.jianshu.com/p/0d497fe5484a"),n("OutboundLink")],1),e._v(" "),n("a",{attrs:{href:"https://link.jianshu.com/?t=http://remcarpediem.com/2017/04/02/Netty",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://remcarpediem.com/2017/04/02/Netty"),n("OutboundLink")],1),e._v("æºç -ä¸‰-I-Oæ¨¡å‹å’ŒJava-NIOåº•å±‚åŸç†/\nåœ£æ€å›­nettyè¯¾ç¨‹")])])}),[],!1,null,null,null);s.default=t.exports}}]);