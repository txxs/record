(window.webpackJsonp=window.webpackJsonp||[]).push([[765],{1159:function(t,s,a){"use strict";a.r(s);var n=a(13),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("实际生产过程中，若要求构建的过滤器针对全局路径有效，且无任何特殊需求（主要针对 Servlet 3.0 的一些异步特性支持），则完全可直接使用 Filter 接口（或继承 Spring 对 Filter 接口的包装类 OncePerRequestFilter），并使用**@Component** 将其包装为 Spring 中的普通 Bean，也可达到预期需求。")]),t._v(" "),a("p",[t._v("不过不管使用哪种方式，可能都遇到问题：业务代码重复执行多次。")]),t._v(" "),a("p",[t._v("这里以 "),a("strong",[t._v("@Component")]),t._v(" + Filter 接口实现方式呈现案例。\n创建一SB应用：\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/c456333c13e5482d90a3875ac5c6d8e2.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v("\nUserController：\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/3f732602dad946daac2ef662858d1174.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v("\nDemoFilter：\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/931f474caedf46739b60b272a07154e9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v("\n查看调用接口后的日志：\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/c2ee9c2675f84407a078fe7c93abecf6.png",alt:""}}),t._v("业务代码竟然被执行两次？？？")]),t._v(" "),a("p",[t._v("预期是 Filter 的业务执行不会影响核心业务，所以当抛异常时，还是会调用"),a("code",[t._v("chain.doFilter")]),t._v("。\n但有时，我们会忘记及时返回而误闯其它"),a("code",[t._v("chain.doFilter")]),t._v("，最终导致自定义过滤器被执行多次。")]),t._v(" "),a("p",[t._v("而检查代码时，往往不能光速看出问题，所以这是类典型错误，虽然原因很简单。\n现在我们来分析为何会执行两次，以精通 Filter 的执行。")]),t._v(" "),a("h1",{attrs:{id:"源码解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源码解析"}},[t._v("#")]),t._v(" 源码解析")]),t._v(" "),a("p",[t._v("首先我们要搞清")]),t._v(" "),a("h2",{attrs:{id:"责任链模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#责任链模式"}},[t._v("#")]),t._v(" 责任链模式")]),t._v(" "),a("p",[t._v("我们看Tomcat的Filter实现ApplicationFilterChain，采用责任链模式，像递归调用，区别在于：")]),t._v(" "),a("ul",[a("li",[t._v("递归调用，同一对象把子任务交给同一方法本身")]),t._v(" "),a("li",[t._v("责任链，一个对象把子任务交给"),a("strong",[t._v("其它对象")]),t._v("的同名方法")])]),t._v(" "),a("p",[t._v("核心在于上下文 FilterChain 在不同对象 Filter 间的传递与状态的改变，通过这种链式串联，即可对同种对象资源实现不同业务场景的处理，实现业务解耦。")]),t._v(" "),a("h3",{attrs:{id:"filterchain-结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#filterchain-结构"}},[t._v("#")]),t._v(" FilterChain 结构")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/69f2e0298d26439c9d2ca42a19adbd83.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}})]),t._v(" "),a("ol",[a("li",[t._v("请求来临时，会执行到 "),a("em",[a("strong",[t._v("StandardWrapperValve#invoke()")])]),t._v(" ，该方法会创建 ApplicationFilterChain，并通过 "),a("em",[a("strong",[t._v("ApplicationFilterChain#doFilter()")])]),t._v("  触发过滤器执行")]),t._v(" "),a("li",[a("em",[a("strong",[t._v("ApplicationFilterChain#doFilter()")])]),t._v(" 会执行其私有方法 internalDoFilter")]),t._v(" "),a("li",[t._v("在 internalDoFilter 方法中获取下一个Filter，并使用 request、response、this（当前ApplicationFilterChain 实例）作为参数来调用 doFilter()：\npublic void doFilter(ServletRequest request, ServletResponse response,\nFilterChain chain) throws IOException, ServletException")]),t._v(" "),a("li",[t._v("在 Filter 类的 doFilter() 中，执行Filter定义的动作并继续传递，获取第三个参数 ApplicationFilterChain，并执行其 doFilter()")]),t._v(" "),a("li",[t._v("此时会循环执行进入第 2 步、第 3 步、第 4 步，直到第3步中所有的 Filter 类都被执行完毕为止")]),t._v(" "),a("li",[t._v("所有的Filter过滤器都被执行完毕后，会执行 servlet.service(request, response) 方法，最终调用对应的 Controller 层方法")])]),t._v(" "),a("p",[t._v("现在，让我们先看负责请求处理的触发时机：")]),t._v(" "),a("h3",{attrs:{id:"standardwrappervalve-invoke"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#standardwrappervalve-invoke"}},[t._v("#")]),t._v(" StandardWrapperValve#invoke()")]),t._v(" "),a("p",[t._v("FilterChain 在何处被创建，又是在何处进行初始化调用，从而激活责任链开始链式调用？")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("invoke")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Request")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Response")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IOException")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServletException")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建filterChain ")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApplicationFilterChain")]),t._v(" filterChain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApplicationFilterFactory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createFilterChain")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wrapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" servlet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("servlet "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filterChain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Swallow output if needed")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSwallowOutput")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n             "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n             "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行责任链")]),t._v("\n             filterChain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("doFilter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                            response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResponse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n             "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br")])]),a("p",[t._v("那FilterChain为何能被链式调用，调用细节如何？查阅：")]),t._v(" "),a("h3",{attrs:{id:"applicationfilterfactory-createfilterchain"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#applicationfilterfactory-createfilterchain"}},[t._v("#")]),t._v(" ApplicationFilterFactory.createFilterChain()")]),t._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApplicationFilterChain")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createFilterChain")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ServletRequest")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Wrapper")]),t._v(" wrapper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Servlet")]),t._v(" servlet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApplicationFilterChain")]),t._v(" filterChain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Request")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建FilterChain")]),t._v("\n        filterChain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApplicationFilterChain")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Add the relevant path-mapped filters to this filter chain")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" filterMaps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApplicationFilterConfig")]),t._v(" filterConfig "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ApplicationFilterConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("findFilterConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filterMaps"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getFilterName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filterConfig "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("continue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 增加filterConfig到Chain")]),t._v("\n        filterChain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addFilter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filterConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" filterChain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br")])]),a("p",[t._v("它创建 FilterChain，并将所有 Filter 逐一添加到 FilterChain 中。")]),t._v(" "),a("p",[t._v("继续查看")]),t._v(" "),a("h3",{attrs:{id:"applicationfilterchain"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#applicationfilterchain"}},[t._v("#")]),t._v(" ApplicationFilterChain")]),t._v(" "),a("p",[a("strong",[t._v("javax.servlet.FilterChain")]),t._v(" 的实现类\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/a086671f1117459e820cbb768553fe26.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v("\n用于管理特定请求的一组过滤器的执行。 当所有定义的过滤器都执行完毕后，对 "),a("em",[a("strong",[t._v("doFilter()")])]),t._v(" 的下一次调用将执行 "),a("em",[a("strong",[t._v("servlet#service()")])]),t._v(" 本身。")]),t._v(" "),a("h4",{attrs:{id:"实例变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实例变量"}},[t._v("#")]),t._v(" 实例变量")]),t._v(" "),a("p",[t._v("过滤器集\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/9dafeaf064244ad980dee5e22c61ce8d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v("过滤器链中当前位置\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/a82237385d1141e581a28cc736521cdd.png",alt:""}}),t._v("链中当前的过滤器数\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/6532e64173a04b31a8bb842e9aa767e7.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"addfilter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#addfilter"}},[t._v("#")]),t._v(" addFilter"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/9a120216a76f46dd8053bfa8c6f3a059.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}})]),t._v(" "),a("p",[t._v("每个被初始化的 Filter 都会通过 "),a("em",[a("strong",[t._v("filterChain.addFilter()")])]),t._v(" ，加入Filters，并同时更新n，使其等于 Filters数组长度。")]),t._v(" "),a("p",[t._v("至此，Spring 完成对 FilterChain 创建准备工作。")]),t._v(" "),a("h4",{attrs:{id:"dofilter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dofilter"}},[t._v("#")]),t._v(" doFilter()")]),t._v(" "),a("p",[t._v("调用此链中的下一个过滤器，传递指定请求、响应。 若此链无更多过滤器，则调用 "),a("em",[a("strong",[t._v("servlet#service()")])]),t._v(" "),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/fb6fb766642040749904839912e9b6af.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v("\n被委派到当前类的私有方法")]),t._v(" "),a("h4",{attrs:{id:"internaldofilter-过滤器逻辑的核心"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#internaldofilter-过滤器逻辑的核心"}},[t._v("#")]),t._v(" internalDoFilter（过滤器逻辑的核心）")]),t._v(" "),a("p",[t._v("每被调用一次，pos 变量值自增 1，即从类成员变量 Filters 中取下一个 Filter：\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/6d2e361f3d344aeba4c2dd6eb93f7328.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v(" "),a("em",[a("strong",[t._v("filter.doFilter(request, response, this)")])]),t._v(" 会调用过滤器实现的 doFilter()，第三个参数为 this，即当前ApplicationFilterChain实例 ，这意味着用户需要在过滤器中显式调用一次 "),a("em",[a("strong",[t._v("javax.servlet.FilterChain#doFilter")])]),t._v("，才能完成整个链路。")]),t._v(" "),a("p",[t._v("当"),a("code",[t._v("pos < n")]),t._v("，说明已执行完所有过滤器，才调用 "),a("em",[a("strong",[t._v("servlet.service(request, response)")])]),t._v(" 执行真正业务。从 "),a("em",[a("strong",[t._v("internalDoFilter()")])]),t._v(" 执行到 "),a("em",[a("strong",[t._v("Controller#saveUser()")])]),t._v(" 。\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/0011ff410ca545e29d0a0cc736212663.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}})]),t._v(" "),a("p",[t._v("回到案例，"),a("em",[a("strong",[t._v("DemoFilter#doFilter()")])]),t._v(" 捕获异常的部分执行了一次，随后在 try 外面又执行一次，因而当抛出异常时，doFilter() 会被执行两次，相应的 "),a("em",[a("strong",[t._v("servlet.service(request, response)")])]),t._v(" 方法及对应的 Controller 处理方法也被执行两次。")]),t._v(" "),a("h1",{attrs:{id:"修正"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修正"}},[t._v("#")]),t._v(" 修正")]),t._v(" "),a("p",[t._v("只需除去重复的 "),a("em",[a("strong",[t._v("filterChain.doFilter(request, response)")])]),t._v(" ：\n"),a("img",{attrs:{src:"https://img-blog.csdnimg.cn/1773dfaf02d84824b5bcfe8276876c6f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBASmF2YUVkZ2Uu,size_20,color_FFFFFF,t_70,g_se,x_16",alt:""}}),t._v("\n使用过滤器时，切忌多次调用 "),a("em",[a("strong",[t._v("FilterChain#doFilter()")])]),t._v(" 。")])])}),[],!1,null,null,null);s.default=e.exports}}]);