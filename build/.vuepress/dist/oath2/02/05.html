<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实战案例：使用 Spring Security 搭建一套基于 JWT 的 OAuth 2.0 架构 | Record</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/record/favicon.ico">
    <link rel="manifest" href="/record/manifest.json">
    <meta name="description" content="用来记录工作和学习过程中的笔记，汇总成册方便查阅，类容涵盖各类技术，如：Java、Git、ElasticSearch、MyCat、设计模式、Gradle、Vue - mrcode.cn">
    
    <link rel="preload" href="/record/assets/css/0.styles.5e60bcf1.css" as="style"><link rel="preload" href="/record/assets/js/app.884f2913.js" as="script"><link rel="preload" href="/record/assets/js/2.dbe61d54.js" as="script"><link rel="preload" href="/record/assets/js/526.57bd75de.js" as="script"><link rel="preload" href="/record/assets/js/6.8f5ad0bb.js" as="script"><link rel="prefetch" href="/record/assets/js/10.51006067.js"><link rel="prefetch" href="/record/assets/js/100.8de70c8c.js"><link rel="prefetch" href="/record/assets/js/101.ef11adba.js"><link rel="prefetch" href="/record/assets/js/102.0bc41d6f.js"><link rel="prefetch" href="/record/assets/js/103.c8875683.js"><link rel="prefetch" href="/record/assets/js/104.56e7f146.js"><link rel="prefetch" href="/record/assets/js/105.e10fa0f8.js"><link rel="prefetch" href="/record/assets/js/106.9fff90d9.js"><link rel="prefetch" href="/record/assets/js/107.72f57e66.js"><link rel="prefetch" href="/record/assets/js/108.561b265a.js"><link rel="prefetch" href="/record/assets/js/109.9bd5e18b.js"><link rel="prefetch" href="/record/assets/js/11.6740f8d1.js"><link rel="prefetch" href="/record/assets/js/110.782dbb33.js"><link rel="prefetch" href="/record/assets/js/111.af401dbc.js"><link rel="prefetch" href="/record/assets/js/112.e34fc042.js"><link rel="prefetch" href="/record/assets/js/113.e22da772.js"><link rel="prefetch" href="/record/assets/js/114.25859412.js"><link rel="prefetch" href="/record/assets/js/115.9ce208df.js"><link rel="prefetch" href="/record/assets/js/116.f2e071f8.js"><link rel="prefetch" href="/record/assets/js/117.9f8e11fb.js"><link rel="prefetch" href="/record/assets/js/118.6b9b269a.js"><link rel="prefetch" href="/record/assets/js/119.b7847984.js"><link rel="prefetch" href="/record/assets/js/12.89e5f367.js"><link rel="prefetch" href="/record/assets/js/120.020c4d78.js"><link rel="prefetch" href="/record/assets/js/121.91bd51ae.js"><link rel="prefetch" href="/record/assets/js/122.b118c672.js"><link rel="prefetch" href="/record/assets/js/123.f824bf36.js"><link rel="prefetch" href="/record/assets/js/124.2908df6f.js"><link rel="prefetch" href="/record/assets/js/125.613856af.js"><link rel="prefetch" href="/record/assets/js/126.7bbbfef2.js"><link rel="prefetch" href="/record/assets/js/127.2f0bebca.js"><link rel="prefetch" href="/record/assets/js/128.02f7de4a.js"><link rel="prefetch" href="/record/assets/js/129.c4bf9523.js"><link rel="prefetch" href="/record/assets/js/13.707acfa5.js"><link rel="prefetch" href="/record/assets/js/130.4ab10533.js"><link rel="prefetch" href="/record/assets/js/131.33458563.js"><link rel="prefetch" href="/record/assets/js/132.fb62ccfd.js"><link rel="prefetch" href="/record/assets/js/133.24ee9aff.js"><link rel="prefetch" href="/record/assets/js/134.376a7a35.js"><link rel="prefetch" href="/record/assets/js/135.8f1d76c3.js"><link rel="prefetch" href="/record/assets/js/136.2750519c.js"><link rel="prefetch" href="/record/assets/js/137.5c6c3cda.js"><link rel="prefetch" href="/record/assets/js/138.7498231d.js"><link rel="prefetch" href="/record/assets/js/139.bcd3abf6.js"><link rel="prefetch" href="/record/assets/js/14.b9add591.js"><link rel="prefetch" href="/record/assets/js/140.40db589f.js"><link rel="prefetch" href="/record/assets/js/141.5d3e2228.js"><link rel="prefetch" href="/record/assets/js/142.4ba3fddd.js"><link rel="prefetch" href="/record/assets/js/143.3aac639e.js"><link rel="prefetch" href="/record/assets/js/144.0ed1dcfa.js"><link rel="prefetch" href="/record/assets/js/145.25e0924d.js"><link rel="prefetch" href="/record/assets/js/146.04b2a091.js"><link rel="prefetch" href="/record/assets/js/147.6e88f7c1.js"><link rel="prefetch" href="/record/assets/js/148.bce17640.js"><link rel="prefetch" href="/record/assets/js/149.637f7c95.js"><link rel="prefetch" href="/record/assets/js/15.9b6f18c1.js"><link rel="prefetch" href="/record/assets/js/150.99fd4f83.js"><link rel="prefetch" href="/record/assets/js/151.e497e836.js"><link rel="prefetch" href="/record/assets/js/152.cc95121b.js"><link rel="prefetch" href="/record/assets/js/153.4b3a18a0.js"><link rel="prefetch" href="/record/assets/js/154.cca33407.js"><link rel="prefetch" href="/record/assets/js/155.e3e64a0f.js"><link rel="prefetch" href="/record/assets/js/156.442b6aeb.js"><link rel="prefetch" href="/record/assets/js/157.e3b3127f.js"><link rel="prefetch" href="/record/assets/js/158.f5741b17.js"><link rel="prefetch" href="/record/assets/js/159.dc8d2f10.js"><link rel="prefetch" href="/record/assets/js/16.9648490b.js"><link rel="prefetch" href="/record/assets/js/160.9c168148.js"><link rel="prefetch" href="/record/assets/js/161.55bad0c3.js"><link rel="prefetch" href="/record/assets/js/162.58bbad49.js"><link rel="prefetch" href="/record/assets/js/163.be587a22.js"><link rel="prefetch" href="/record/assets/js/164.4f8cc8af.js"><link rel="prefetch" href="/record/assets/js/165.bcf5312d.js"><link rel="prefetch" href="/record/assets/js/166.ab5632f4.js"><link rel="prefetch" href="/record/assets/js/167.d2234613.js"><link rel="prefetch" href="/record/assets/js/168.f1e9f6ef.js"><link rel="prefetch" href="/record/assets/js/169.c165cad2.js"><link rel="prefetch" href="/record/assets/js/17.35729a1d.js"><link rel="prefetch" href="/record/assets/js/170.ac5b9089.js"><link rel="prefetch" href="/record/assets/js/171.88be8635.js"><link rel="prefetch" href="/record/assets/js/172.eb70c42d.js"><link rel="prefetch" href="/record/assets/js/173.79fa5cac.js"><link rel="prefetch" href="/record/assets/js/174.8eea4d8d.js"><link rel="prefetch" href="/record/assets/js/175.46465d19.js"><link rel="prefetch" href="/record/assets/js/176.af5b133a.js"><link rel="prefetch" href="/record/assets/js/177.94af0037.js"><link rel="prefetch" href="/record/assets/js/178.53d535ec.js"><link rel="prefetch" href="/record/assets/js/179.da81be9d.js"><link rel="prefetch" href="/record/assets/js/18.6e9a5d53.js"><link rel="prefetch" href="/record/assets/js/180.c2035c95.js"><link rel="prefetch" href="/record/assets/js/181.c5d3147b.js"><link rel="prefetch" href="/record/assets/js/182.255a510c.js"><link rel="prefetch" href="/record/assets/js/183.4f4a8418.js"><link rel="prefetch" href="/record/assets/js/184.62fba890.js"><link rel="prefetch" href="/record/assets/js/185.0110cde6.js"><link rel="prefetch" href="/record/assets/js/186.3118c4ce.js"><link rel="prefetch" href="/record/assets/js/187.f48eea54.js"><link rel="prefetch" href="/record/assets/js/188.a581ff85.js"><link rel="prefetch" href="/record/assets/js/189.cccfb453.js"><link rel="prefetch" href="/record/assets/js/19.31cdf1d8.js"><link rel="prefetch" href="/record/assets/js/190.9c55c217.js"><link rel="prefetch" href="/record/assets/js/191.914bf857.js"><link rel="prefetch" href="/record/assets/js/192.37f62519.js"><link rel="prefetch" href="/record/assets/js/193.23928131.js"><link rel="prefetch" href="/record/assets/js/194.a8a7345f.js"><link rel="prefetch" href="/record/assets/js/195.a5322624.js"><link rel="prefetch" href="/record/assets/js/196.4a8f928b.js"><link rel="prefetch" href="/record/assets/js/197.6b19e2ba.js"><link rel="prefetch" href="/record/assets/js/198.7dffd012.js"><link rel="prefetch" href="/record/assets/js/199.0d99d717.js"><link rel="prefetch" href="/record/assets/js/20.a1819a93.js"><link rel="prefetch" href="/record/assets/js/200.a0e8ef3b.js"><link rel="prefetch" href="/record/assets/js/201.2a0ba5f1.js"><link rel="prefetch" href="/record/assets/js/202.ffc44ff6.js"><link rel="prefetch" href="/record/assets/js/203.89cd9423.js"><link rel="prefetch" href="/record/assets/js/204.e6ce0286.js"><link rel="prefetch" href="/record/assets/js/205.2021ef0c.js"><link rel="prefetch" href="/record/assets/js/206.580005a3.js"><link rel="prefetch" href="/record/assets/js/207.716d8bb0.js"><link rel="prefetch" href="/record/assets/js/208.9d08e3df.js"><link rel="prefetch" href="/record/assets/js/209.08ec3b46.js"><link rel="prefetch" href="/record/assets/js/21.88fbcc9d.js"><link rel="prefetch" href="/record/assets/js/210.2464b060.js"><link rel="prefetch" href="/record/assets/js/211.b8545bdd.js"><link rel="prefetch" href="/record/assets/js/212.c5a2869f.js"><link rel="prefetch" href="/record/assets/js/213.07862193.js"><link rel="prefetch" href="/record/assets/js/214.68c4f2e7.js"><link rel="prefetch" href="/record/assets/js/215.33ed5930.js"><link rel="prefetch" href="/record/assets/js/216.3365c958.js"><link rel="prefetch" href="/record/assets/js/217.3b5de5a4.js"><link rel="prefetch" href="/record/assets/js/218.51792430.js"><link rel="prefetch" href="/record/assets/js/219.39095014.js"><link rel="prefetch" href="/record/assets/js/22.ab271965.js"><link rel="prefetch" href="/record/assets/js/220.ce053e22.js"><link rel="prefetch" href="/record/assets/js/221.50b27b74.js"><link rel="prefetch" href="/record/assets/js/222.07bbe38b.js"><link rel="prefetch" href="/record/assets/js/223.b9e84a4b.js"><link rel="prefetch" href="/record/assets/js/224.077647aa.js"><link rel="prefetch" href="/record/assets/js/225.c06e02a8.js"><link rel="prefetch" href="/record/assets/js/226.7b4e16b5.js"><link rel="prefetch" href="/record/assets/js/227.a00b7db8.js"><link rel="prefetch" href="/record/assets/js/228.243ee746.js"><link rel="prefetch" href="/record/assets/js/229.e70a0ad6.js"><link rel="prefetch" href="/record/assets/js/23.28d5b738.js"><link rel="prefetch" href="/record/assets/js/230.4088a146.js"><link rel="prefetch" href="/record/assets/js/231.a38c471f.js"><link rel="prefetch" href="/record/assets/js/232.c53a4c60.js"><link rel="prefetch" href="/record/assets/js/233.8bdd18e0.js"><link rel="prefetch" href="/record/assets/js/234.00ccfbca.js"><link rel="prefetch" href="/record/assets/js/235.bd540e41.js"><link rel="prefetch" href="/record/assets/js/236.8c453598.js"><link rel="prefetch" href="/record/assets/js/237.ba5bcab3.js"><link rel="prefetch" href="/record/assets/js/238.7ee1e080.js"><link rel="prefetch" href="/record/assets/js/239.153cd62c.js"><link rel="prefetch" href="/record/assets/js/24.38521026.js"><link rel="prefetch" href="/record/assets/js/240.cf815dbd.js"><link rel="prefetch" href="/record/assets/js/241.8fc3911c.js"><link rel="prefetch" href="/record/assets/js/242.f09a56c7.js"><link rel="prefetch" href="/record/assets/js/243.d9d17e8a.js"><link rel="prefetch" href="/record/assets/js/244.a6bd111c.js"><link rel="prefetch" href="/record/assets/js/245.50ac1857.js"><link rel="prefetch" href="/record/assets/js/246.9051d686.js"><link rel="prefetch" href="/record/assets/js/247.a8c5b51d.js"><link rel="prefetch" href="/record/assets/js/248.aca3c667.js"><link rel="prefetch" href="/record/assets/js/249.ae910a26.js"><link rel="prefetch" href="/record/assets/js/25.a37fd7b9.js"><link rel="prefetch" href="/record/assets/js/250.8398cbbf.js"><link rel="prefetch" href="/record/assets/js/251.b49442ff.js"><link rel="prefetch" href="/record/assets/js/252.98aa0ec4.js"><link rel="prefetch" href="/record/assets/js/253.ffc0f2b5.js"><link rel="prefetch" href="/record/assets/js/254.d141eeba.js"><link rel="prefetch" href="/record/assets/js/255.1e0f9f8b.js"><link rel="prefetch" href="/record/assets/js/256.31328a9c.js"><link rel="prefetch" href="/record/assets/js/257.e229a6a5.js"><link rel="prefetch" href="/record/assets/js/258.dd1df754.js"><link rel="prefetch" href="/record/assets/js/259.08ea3146.js"><link rel="prefetch" href="/record/assets/js/26.ecfb765f.js"><link rel="prefetch" href="/record/assets/js/260.31143d81.js"><link rel="prefetch" href="/record/assets/js/261.0873e938.js"><link rel="prefetch" href="/record/assets/js/262.00e0da6f.js"><link rel="prefetch" href="/record/assets/js/263.923bef9a.js"><link rel="prefetch" href="/record/assets/js/264.4157e425.js"><link rel="prefetch" href="/record/assets/js/265.5381c108.js"><link rel="prefetch" href="/record/assets/js/266.57bd0c1b.js"><link rel="prefetch" href="/record/assets/js/267.56690f4e.js"><link rel="prefetch" href="/record/assets/js/268.26640460.js"><link rel="prefetch" href="/record/assets/js/269.7b059979.js"><link rel="prefetch" href="/record/assets/js/27.95483cd2.js"><link rel="prefetch" href="/record/assets/js/270.35e2b3dd.js"><link rel="prefetch" href="/record/assets/js/271.1459d919.js"><link rel="prefetch" href="/record/assets/js/272.45c09583.js"><link rel="prefetch" href="/record/assets/js/273.0971a21d.js"><link rel="prefetch" href="/record/assets/js/274.def6a715.js"><link rel="prefetch" href="/record/assets/js/275.43cd7811.js"><link rel="prefetch" href="/record/assets/js/276.396b98ce.js"><link rel="prefetch" href="/record/assets/js/277.4a9fb8c1.js"><link rel="prefetch" href="/record/assets/js/278.ecc9c033.js"><link rel="prefetch" href="/record/assets/js/279.f2c579db.js"><link rel="prefetch" href="/record/assets/js/28.8c97a78c.js"><link rel="prefetch" href="/record/assets/js/280.b4e9bcfb.js"><link rel="prefetch" href="/record/assets/js/281.2d1af1ef.js"><link rel="prefetch" href="/record/assets/js/282.44479912.js"><link rel="prefetch" href="/record/assets/js/283.7aab7086.js"><link rel="prefetch" href="/record/assets/js/284.c11b7654.js"><link rel="prefetch" href="/record/assets/js/285.ad65c9f0.js"><link rel="prefetch" href="/record/assets/js/286.eefa4e3a.js"><link rel="prefetch" href="/record/assets/js/287.569b7273.js"><link rel="prefetch" href="/record/assets/js/288.7dd81e81.js"><link rel="prefetch" href="/record/assets/js/289.20d22870.js"><link rel="prefetch" href="/record/assets/js/29.7292b4f2.js"><link rel="prefetch" href="/record/assets/js/290.91342350.js"><link rel="prefetch" href="/record/assets/js/291.2b0863c3.js"><link rel="prefetch" href="/record/assets/js/292.fc25ed94.js"><link rel="prefetch" href="/record/assets/js/293.9e4c6853.js"><link rel="prefetch" href="/record/assets/js/294.e63f9a36.js"><link rel="prefetch" href="/record/assets/js/295.27b4fb9f.js"><link rel="prefetch" href="/record/assets/js/296.7f5bffa7.js"><link rel="prefetch" href="/record/assets/js/297.d09e373b.js"><link rel="prefetch" href="/record/assets/js/298.185d2401.js"><link rel="prefetch" href="/record/assets/js/299.7ad73b90.js"><link rel="prefetch" href="/record/assets/js/3.a5ee11d9.js"><link rel="prefetch" href="/record/assets/js/30.91263eb3.js"><link rel="prefetch" href="/record/assets/js/300.352a9ee5.js"><link rel="prefetch" href="/record/assets/js/301.5d28ce79.js"><link rel="prefetch" href="/record/assets/js/302.a9dfe7b6.js"><link rel="prefetch" href="/record/assets/js/303.be38ebfe.js"><link rel="prefetch" href="/record/assets/js/304.f1a680c2.js"><link rel="prefetch" href="/record/assets/js/305.d9e8a9f2.js"><link rel="prefetch" href="/record/assets/js/306.1e19a4b3.js"><link rel="prefetch" href="/record/assets/js/307.1c8271c1.js"><link rel="prefetch" href="/record/assets/js/308.3b8932a7.js"><link rel="prefetch" href="/record/assets/js/309.e6154d71.js"><link rel="prefetch" href="/record/assets/js/31.2f921dd5.js"><link rel="prefetch" href="/record/assets/js/310.0c23d258.js"><link rel="prefetch" href="/record/assets/js/311.58a1321f.js"><link rel="prefetch" href="/record/assets/js/312.f13e5ac0.js"><link rel="prefetch" href="/record/assets/js/313.2cd9d0e7.js"><link rel="prefetch" href="/record/assets/js/314.710808fb.js"><link rel="prefetch" href="/record/assets/js/315.72577750.js"><link rel="prefetch" href="/record/assets/js/316.89ba86ab.js"><link rel="prefetch" href="/record/assets/js/317.b931fa61.js"><link rel="prefetch" href="/record/assets/js/318.2bdd1dc2.js"><link rel="prefetch" href="/record/assets/js/319.c1680fa8.js"><link rel="prefetch" href="/record/assets/js/32.02ef0ccd.js"><link rel="prefetch" href="/record/assets/js/320.902a0143.js"><link rel="prefetch" href="/record/assets/js/321.1b3807b7.js"><link rel="prefetch" href="/record/assets/js/322.855ce6bc.js"><link rel="prefetch" href="/record/assets/js/323.20d43427.js"><link rel="prefetch" href="/record/assets/js/324.0817aaf2.js"><link rel="prefetch" href="/record/assets/js/325.ab1a9f9e.js"><link rel="prefetch" href="/record/assets/js/326.1675b568.js"><link rel="prefetch" href="/record/assets/js/327.6b2fc91e.js"><link rel="prefetch" href="/record/assets/js/328.cefb4cf5.js"><link rel="prefetch" href="/record/assets/js/329.5fe9eaf2.js"><link rel="prefetch" href="/record/assets/js/33.60228a30.js"><link rel="prefetch" href="/record/assets/js/330.6e7eb7ca.js"><link rel="prefetch" href="/record/assets/js/331.c77bff74.js"><link rel="prefetch" href="/record/assets/js/332.aa83d05c.js"><link rel="prefetch" href="/record/assets/js/333.5d04115e.js"><link rel="prefetch" href="/record/assets/js/334.b260f916.js"><link rel="prefetch" href="/record/assets/js/335.37804a8e.js"><link rel="prefetch" href="/record/assets/js/336.fd77a3cd.js"><link rel="prefetch" href="/record/assets/js/337.a3982038.js"><link rel="prefetch" href="/record/assets/js/338.f348e3a5.js"><link rel="prefetch" href="/record/assets/js/339.94e82523.js"><link rel="prefetch" href="/record/assets/js/34.c954a74f.js"><link rel="prefetch" href="/record/assets/js/340.772d8242.js"><link rel="prefetch" href="/record/assets/js/341.b040d94a.js"><link rel="prefetch" href="/record/assets/js/342.23ca1718.js"><link rel="prefetch" href="/record/assets/js/343.f001d46d.js"><link rel="prefetch" href="/record/assets/js/344.4e5dc9b5.js"><link rel="prefetch" href="/record/assets/js/345.e80591b6.js"><link rel="prefetch" href="/record/assets/js/346.f0279ac9.js"><link rel="prefetch" href="/record/assets/js/347.daf9e94d.js"><link rel="prefetch" href="/record/assets/js/348.862c80f7.js"><link rel="prefetch" href="/record/assets/js/349.5ecee082.js"><link rel="prefetch" href="/record/assets/js/35.f939233c.js"><link rel="prefetch" href="/record/assets/js/350.01153a72.js"><link rel="prefetch" href="/record/assets/js/351.c19de25d.js"><link rel="prefetch" href="/record/assets/js/352.b96e37ae.js"><link rel="prefetch" href="/record/assets/js/353.560193a7.js"><link rel="prefetch" href="/record/assets/js/354.6c3503a1.js"><link rel="prefetch" href="/record/assets/js/355.76f27659.js"><link rel="prefetch" href="/record/assets/js/356.816ce505.js"><link rel="prefetch" href="/record/assets/js/357.d87bde9c.js"><link rel="prefetch" href="/record/assets/js/358.19fc355b.js"><link rel="prefetch" href="/record/assets/js/359.9e609e85.js"><link rel="prefetch" href="/record/assets/js/36.ff65fbcb.js"><link rel="prefetch" href="/record/assets/js/360.6334c4ed.js"><link rel="prefetch" href="/record/assets/js/361.4f4369fb.js"><link rel="prefetch" href="/record/assets/js/362.0d920bec.js"><link rel="prefetch" href="/record/assets/js/363.c59af495.js"><link rel="prefetch" href="/record/assets/js/364.71057a20.js"><link rel="prefetch" href="/record/assets/js/365.f2e8c8a2.js"><link rel="prefetch" href="/record/assets/js/366.043b59f0.js"><link rel="prefetch" href="/record/assets/js/367.dce0dbdf.js"><link rel="prefetch" href="/record/assets/js/368.761aca6d.js"><link rel="prefetch" href="/record/assets/js/369.04df3716.js"><link rel="prefetch" href="/record/assets/js/37.6836bbd3.js"><link rel="prefetch" href="/record/assets/js/370.b17f5250.js"><link rel="prefetch" href="/record/assets/js/371.140a1a3a.js"><link rel="prefetch" href="/record/assets/js/372.48ca2209.js"><link rel="prefetch" href="/record/assets/js/373.bc923231.js"><link rel="prefetch" href="/record/assets/js/374.83e36ed6.js"><link rel="prefetch" href="/record/assets/js/375.4604b529.js"><link rel="prefetch" href="/record/assets/js/376.042c05b4.js"><link rel="prefetch" href="/record/assets/js/377.8eb50c78.js"><link rel="prefetch" href="/record/assets/js/378.7e249428.js"><link rel="prefetch" href="/record/assets/js/379.14cfab5b.js"><link rel="prefetch" href="/record/assets/js/38.52c0efa1.js"><link rel="prefetch" href="/record/assets/js/380.7240e9a8.js"><link rel="prefetch" href="/record/assets/js/381.726f9e76.js"><link rel="prefetch" href="/record/assets/js/382.6e7cb57d.js"><link rel="prefetch" href="/record/assets/js/383.433afc8f.js"><link rel="prefetch" href="/record/assets/js/384.be1693c2.js"><link rel="prefetch" href="/record/assets/js/385.f1452720.js"><link rel="prefetch" href="/record/assets/js/386.3fd8fbf6.js"><link rel="prefetch" href="/record/assets/js/387.d82471ec.js"><link rel="prefetch" href="/record/assets/js/388.9eff07a7.js"><link rel="prefetch" href="/record/assets/js/389.fe881473.js"><link rel="prefetch" href="/record/assets/js/39.ff771496.js"><link rel="prefetch" href="/record/assets/js/390.bda4ed76.js"><link rel="prefetch" href="/record/assets/js/391.1da0d5d0.js"><link rel="prefetch" href="/record/assets/js/392.7516eede.js"><link rel="prefetch" href="/record/assets/js/393.35110b44.js"><link rel="prefetch" href="/record/assets/js/394.b1a55884.js"><link rel="prefetch" href="/record/assets/js/395.330f6bc8.js"><link rel="prefetch" href="/record/assets/js/396.782512e2.js"><link rel="prefetch" href="/record/assets/js/397.299049b1.js"><link rel="prefetch" href="/record/assets/js/398.3ca49ab9.js"><link rel="prefetch" href="/record/assets/js/399.a9e4d34e.js"><link rel="prefetch" href="/record/assets/js/4.c85cacae.js"><link rel="prefetch" href="/record/assets/js/40.aee569e8.js"><link rel="prefetch" href="/record/assets/js/400.54245ee2.js"><link rel="prefetch" href="/record/assets/js/401.49f0542e.js"><link rel="prefetch" href="/record/assets/js/402.d360433b.js"><link rel="prefetch" href="/record/assets/js/403.7a5b7030.js"><link rel="prefetch" href="/record/assets/js/404.fc4abb85.js"><link rel="prefetch" href="/record/assets/js/405.e21505f4.js"><link rel="prefetch" href="/record/assets/js/406.422842bf.js"><link rel="prefetch" href="/record/assets/js/407.7eae4e34.js"><link rel="prefetch" href="/record/assets/js/408.21754b26.js"><link rel="prefetch" href="/record/assets/js/409.f67361db.js"><link rel="prefetch" href="/record/assets/js/41.e6446dc9.js"><link rel="prefetch" href="/record/assets/js/410.21ab1786.js"><link rel="prefetch" href="/record/assets/js/411.7a43ee19.js"><link rel="prefetch" href="/record/assets/js/412.692954d1.js"><link rel="prefetch" href="/record/assets/js/413.d7cfb8e8.js"><link rel="prefetch" href="/record/assets/js/414.beb346e3.js"><link rel="prefetch" href="/record/assets/js/415.cbc8f7b6.js"><link rel="prefetch" href="/record/assets/js/416.3b120f19.js"><link rel="prefetch" href="/record/assets/js/417.3b6ace83.js"><link rel="prefetch" href="/record/assets/js/418.687613d7.js"><link rel="prefetch" href="/record/assets/js/419.e2b43055.js"><link rel="prefetch" href="/record/assets/js/42.2335c6ab.js"><link rel="prefetch" href="/record/assets/js/420.2d6fe6f6.js"><link rel="prefetch" href="/record/assets/js/421.a0eabcfe.js"><link rel="prefetch" href="/record/assets/js/422.e5c36a39.js"><link rel="prefetch" href="/record/assets/js/423.ab31f942.js"><link rel="prefetch" href="/record/assets/js/424.1be37940.js"><link rel="prefetch" href="/record/assets/js/425.2e8736b5.js"><link rel="prefetch" href="/record/assets/js/426.c77ba28b.js"><link rel="prefetch" href="/record/assets/js/427.b1523248.js"><link rel="prefetch" href="/record/assets/js/428.39cc1a2e.js"><link rel="prefetch" href="/record/assets/js/429.31e27db3.js"><link rel="prefetch" href="/record/assets/js/43.1a32d015.js"><link rel="prefetch" href="/record/assets/js/430.e20d6a2e.js"><link rel="prefetch" href="/record/assets/js/431.b4a1043f.js"><link rel="prefetch" href="/record/assets/js/432.8cda5bd4.js"><link rel="prefetch" href="/record/assets/js/433.ce884367.js"><link rel="prefetch" href="/record/assets/js/434.3cb105bf.js"><link rel="prefetch" href="/record/assets/js/435.6716a521.js"><link rel="prefetch" href="/record/assets/js/436.795f9b3d.js"><link rel="prefetch" href="/record/assets/js/437.67e123b5.js"><link rel="prefetch" href="/record/assets/js/438.c33b682c.js"><link rel="prefetch" href="/record/assets/js/439.f73c7a01.js"><link rel="prefetch" href="/record/assets/js/44.dcf61efd.js"><link rel="prefetch" href="/record/assets/js/440.b3b4ad47.js"><link rel="prefetch" href="/record/assets/js/441.42f7417a.js"><link rel="prefetch" href="/record/assets/js/442.3ca10403.js"><link rel="prefetch" href="/record/assets/js/443.54cf0633.js"><link rel="prefetch" href="/record/assets/js/444.645ac497.js"><link rel="prefetch" href="/record/assets/js/445.b74c0062.js"><link rel="prefetch" href="/record/assets/js/446.2ec494f4.js"><link rel="prefetch" href="/record/assets/js/447.480eb8e2.js"><link rel="prefetch" href="/record/assets/js/448.0e15abd9.js"><link rel="prefetch" href="/record/assets/js/449.63677db0.js"><link rel="prefetch" href="/record/assets/js/45.b3842e1a.js"><link rel="prefetch" href="/record/assets/js/450.b6cf6b0c.js"><link rel="prefetch" href="/record/assets/js/451.7ef05835.js"><link rel="prefetch" href="/record/assets/js/452.bfba487f.js"><link rel="prefetch" href="/record/assets/js/453.976bb6ab.js"><link rel="prefetch" href="/record/assets/js/454.96c9c43b.js"><link rel="prefetch" href="/record/assets/js/455.8159984a.js"><link rel="prefetch" href="/record/assets/js/456.1a0b10f7.js"><link rel="prefetch" href="/record/assets/js/457.371a034a.js"><link rel="prefetch" href="/record/assets/js/458.a317319b.js"><link rel="prefetch" href="/record/assets/js/459.cca303b3.js"><link rel="prefetch" href="/record/assets/js/46.bae792ab.js"><link rel="prefetch" href="/record/assets/js/460.c7e795b7.js"><link rel="prefetch" href="/record/assets/js/461.c5c9d2ed.js"><link rel="prefetch" href="/record/assets/js/462.aa605459.js"><link rel="prefetch" href="/record/assets/js/463.43bff237.js"><link rel="prefetch" href="/record/assets/js/464.58d25ba8.js"><link rel="prefetch" href="/record/assets/js/465.0f4b0313.js"><link rel="prefetch" href="/record/assets/js/466.861a1636.js"><link rel="prefetch" href="/record/assets/js/467.0867bf9a.js"><link rel="prefetch" href="/record/assets/js/468.6fd653ad.js"><link rel="prefetch" href="/record/assets/js/469.30b837bf.js"><link rel="prefetch" href="/record/assets/js/47.65a5c33e.js"><link rel="prefetch" href="/record/assets/js/470.0c7a647a.js"><link rel="prefetch" href="/record/assets/js/471.a46db827.js"><link rel="prefetch" href="/record/assets/js/472.b51bf6b3.js"><link rel="prefetch" href="/record/assets/js/473.5e7668f6.js"><link rel="prefetch" href="/record/assets/js/474.7af678c8.js"><link rel="prefetch" href="/record/assets/js/475.73023797.js"><link rel="prefetch" href="/record/assets/js/476.3a9ad9b6.js"><link rel="prefetch" href="/record/assets/js/477.c9125437.js"><link rel="prefetch" href="/record/assets/js/478.5f3aba26.js"><link rel="prefetch" href="/record/assets/js/479.41a1b3bb.js"><link rel="prefetch" href="/record/assets/js/48.320525b7.js"><link rel="prefetch" href="/record/assets/js/480.07ea58bc.js"><link rel="prefetch" href="/record/assets/js/481.01b32215.js"><link rel="prefetch" href="/record/assets/js/482.0100b63d.js"><link rel="prefetch" href="/record/assets/js/483.119fe668.js"><link rel="prefetch" href="/record/assets/js/484.715b22f8.js"><link rel="prefetch" href="/record/assets/js/485.7eb7dbba.js"><link rel="prefetch" href="/record/assets/js/486.f1a92841.js"><link rel="prefetch" href="/record/assets/js/487.6a2a0dec.js"><link rel="prefetch" href="/record/assets/js/488.8014f1c9.js"><link rel="prefetch" href="/record/assets/js/489.00ce947d.js"><link rel="prefetch" href="/record/assets/js/49.fe4b91fe.js"><link rel="prefetch" href="/record/assets/js/490.7db27a6c.js"><link rel="prefetch" href="/record/assets/js/491.e0247c76.js"><link rel="prefetch" href="/record/assets/js/492.539334b2.js"><link rel="prefetch" href="/record/assets/js/493.3325d6f1.js"><link rel="prefetch" href="/record/assets/js/494.409fc041.js"><link rel="prefetch" href="/record/assets/js/495.ab054017.js"><link rel="prefetch" href="/record/assets/js/496.6b0d4a14.js"><link rel="prefetch" href="/record/assets/js/497.baf18bec.js"><link rel="prefetch" href="/record/assets/js/498.bd7e3b9e.js"><link rel="prefetch" href="/record/assets/js/499.c1eeedad.js"><link rel="prefetch" href="/record/assets/js/5.f23c2eac.js"><link rel="prefetch" href="/record/assets/js/50.d5225af6.js"><link rel="prefetch" href="/record/assets/js/500.8edb550e.js"><link rel="prefetch" href="/record/assets/js/501.1b0f595d.js"><link rel="prefetch" href="/record/assets/js/502.ff1cd774.js"><link rel="prefetch" href="/record/assets/js/503.782a7432.js"><link rel="prefetch" href="/record/assets/js/504.996bba64.js"><link rel="prefetch" href="/record/assets/js/505.8f5e0475.js"><link rel="prefetch" href="/record/assets/js/506.fed6264e.js"><link rel="prefetch" href="/record/assets/js/507.1e43f1d5.js"><link rel="prefetch" href="/record/assets/js/508.bfd7e602.js"><link rel="prefetch" href="/record/assets/js/509.b3a318c3.js"><link rel="prefetch" href="/record/assets/js/51.3b39452e.js"><link rel="prefetch" href="/record/assets/js/510.d68358fb.js"><link rel="prefetch" href="/record/assets/js/511.c6f22d54.js"><link rel="prefetch" href="/record/assets/js/512.aaeb43ac.js"><link rel="prefetch" href="/record/assets/js/513.a009cc90.js"><link rel="prefetch" href="/record/assets/js/514.9c80a59c.js"><link rel="prefetch" href="/record/assets/js/515.4c77dbb1.js"><link rel="prefetch" href="/record/assets/js/516.e8a5c3f3.js"><link rel="prefetch" href="/record/assets/js/517.d7e41ea1.js"><link rel="prefetch" href="/record/assets/js/518.02f74204.js"><link rel="prefetch" href="/record/assets/js/519.8693aefe.js"><link rel="prefetch" href="/record/assets/js/52.42bdb4a6.js"><link rel="prefetch" href="/record/assets/js/520.de4568eb.js"><link rel="prefetch" href="/record/assets/js/521.1d62b0e7.js"><link rel="prefetch" href="/record/assets/js/522.99660550.js"><link rel="prefetch" href="/record/assets/js/523.1432f5d8.js"><link rel="prefetch" href="/record/assets/js/524.3b3c9cdb.js"><link rel="prefetch" href="/record/assets/js/525.63176b5c.js"><link rel="prefetch" href="/record/assets/js/527.a56602a2.js"><link rel="prefetch" href="/record/assets/js/528.4504ed98.js"><link rel="prefetch" href="/record/assets/js/529.00a0b899.js"><link rel="prefetch" href="/record/assets/js/53.ac5bf03c.js"><link rel="prefetch" href="/record/assets/js/530.8606edee.js"><link rel="prefetch" href="/record/assets/js/531.584516a4.js"><link rel="prefetch" href="/record/assets/js/532.9cd18e8d.js"><link rel="prefetch" href="/record/assets/js/533.cf03d406.js"><link rel="prefetch" href="/record/assets/js/54.70af706f.js"><link rel="prefetch" href="/record/assets/js/55.364a2624.js"><link rel="prefetch" href="/record/assets/js/56.5187e578.js"><link rel="prefetch" href="/record/assets/js/57.f162a79d.js"><link rel="prefetch" href="/record/assets/js/58.fd57cae2.js"><link rel="prefetch" href="/record/assets/js/59.0ee08e7f.js"><link rel="prefetch" href="/record/assets/js/60.44b41a12.js"><link rel="prefetch" href="/record/assets/js/61.78900374.js"><link rel="prefetch" href="/record/assets/js/62.11583dcb.js"><link rel="prefetch" href="/record/assets/js/63.69731836.js"><link rel="prefetch" href="/record/assets/js/64.f1ff908a.js"><link rel="prefetch" href="/record/assets/js/65.126ac90e.js"><link rel="prefetch" href="/record/assets/js/66.a0e6b069.js"><link rel="prefetch" href="/record/assets/js/67.2fdafb21.js"><link rel="prefetch" href="/record/assets/js/68.a8346e59.js"><link rel="prefetch" href="/record/assets/js/69.37f5597f.js"><link rel="prefetch" href="/record/assets/js/7.2272a75c.js"><link rel="prefetch" href="/record/assets/js/70.c3018137.js"><link rel="prefetch" href="/record/assets/js/71.bdcf6000.js"><link rel="prefetch" href="/record/assets/js/72.e8c74f62.js"><link rel="prefetch" href="/record/assets/js/73.92164ec7.js"><link rel="prefetch" href="/record/assets/js/74.5828f271.js"><link rel="prefetch" href="/record/assets/js/75.7552735a.js"><link rel="prefetch" href="/record/assets/js/76.5fc8538f.js"><link rel="prefetch" href="/record/assets/js/77.59b20eee.js"><link rel="prefetch" href="/record/assets/js/78.0e9fac5d.js"><link rel="prefetch" href="/record/assets/js/79.10b760fb.js"><link rel="prefetch" href="/record/assets/js/8.b668ec07.js"><link rel="prefetch" href="/record/assets/js/80.c45a3320.js"><link rel="prefetch" href="/record/assets/js/81.d921c841.js"><link rel="prefetch" href="/record/assets/js/82.9d32c216.js"><link rel="prefetch" href="/record/assets/js/83.908bf51d.js"><link rel="prefetch" href="/record/assets/js/84.c2fd72f2.js"><link rel="prefetch" href="/record/assets/js/85.67f92959.js"><link rel="prefetch" href="/record/assets/js/86.f063e421.js"><link rel="prefetch" href="/record/assets/js/87.71ff296f.js"><link rel="prefetch" href="/record/assets/js/88.7347a294.js"><link rel="prefetch" href="/record/assets/js/89.bbb34629.js"><link rel="prefetch" href="/record/assets/js/9.c27b7562.js"><link rel="prefetch" href="/record/assets/js/90.82fbe680.js"><link rel="prefetch" href="/record/assets/js/91.55520edc.js"><link rel="prefetch" href="/record/assets/js/92.ffa4433c.js"><link rel="prefetch" href="/record/assets/js/93.294635b2.js"><link rel="prefetch" href="/record/assets/js/94.977697e5.js"><link rel="prefetch" href="/record/assets/js/95.34651526.js"><link rel="prefetch" href="/record/assets/js/96.38d281a8.js"><link rel="prefetch" href="/record/assets/js/97.02eb1c1a.js"><link rel="prefetch" href="/record/assets/js/98.52012e5e.js"><link rel="prefetch" href="/record/assets/js/99.a2e3862b.js">
    <link rel="stylesheet" href="/record/assets/css/0.styles.5e60bcf1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/record/" class="home-link router-link-active"><img src="/record/mlogo.svg" alt="Record" class="logo"> <span class="site-name can-hide">Record</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://blog.csdn.net/maoyeqiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客（csdn）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计模式" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="设计模式" class="mobile-dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/record/imocc/design_pattern/" class="nav-link">
  设计模式（慕课）
</a></li><li class="dropdown-item"><!----> <a href="/record/design_pattern/" class="nav-link">
  研磨设计模式（李兴华）
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Elasticsearch" class="dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow down"></span></button> <button type="button" aria-label="Elasticsearch" class="mobile-dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/record/elasticsearch-core/" class="nav-link">
  核心知识篇
</a></li><li class="dropdown-item"><!----> <a href="/record/elasticsearch-senior/" class="nav-link">
  高级知识篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="dropdown-title"><span class="title">缓存架构-亿级流量电商详情页系统实战</span> <span class="arrow down"></span></button> <button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="mobile-dropdown-title"><span class="title">缓存架构-亿级流量电商详情页系统实战</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          综合性导航
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/cache-pdp/" class="nav-link">
  全目录导航
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/001-introduce.html" class="nav-link">
  第一版（001 ~ 123 章）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/124.html" class="nav-link">
  第二版（124 ~ 195 章）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/121.html" class="nav-link">
  课程总结（难题与解决方案）
</a></li></ul></li><li class="dropdown-item"><h4>
          精彩知识精选
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/cache-pdp/redis/007.html" class="nav-link">
  Redis 篇（redis 企业级集群架构）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/035.html" class="nav-link">
  多级缓存架构设计
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/040.html" class="nav-link">
  数据库 + 缓存双写一致性解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/045.html" class="nav-link">
  缓存维度化拆分解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/051.html" class="nav-link">
  缓存命中率提升解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/057.html" class="nav-link">
  缓存并发重建冲突解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/069.html" class="nav-link">
  缓存预热解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/077.html" class="nav-link">
  热点缓存自动降级方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/110.html" class="nav-link">
  缓存雪崩解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/117.html" class="nav-link">
  缓存穿透解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/119.html" class="nav-link">
  缓存失效解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/hystrix/084.html" class="nav-link">
  高可用分布式系统架构设计（hystrix 篇）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/047.html" class="nav-link">
  spring boot 整合 ehcache
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/storm/062.html" class="nav-link">
  史上最通俗易懂 Storm 教程
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/record/introduce/" class="nav-link">
  本笔记介绍
</a></li><li class="dropdown-item"><!----> <a href="https://zq99299.github.io/linux-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux 基础篇
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/record/spring-cloud-tutorial/" class="nav-link">
  Spring Cloud
</a></li><li class="dropdown-item"><!----> <a href="/record/css-zxx/" class="nav-link">
  CSS 深入理解（张鑫旭）
</a></li><li class="dropdown-item"><!----> <a href="/record/regular/" class="nav-link">
  正则入门
</a></li><li class="dropdown-item"><h4>
          思路拓展
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/back-end-storage/" class="nav-link">
  后端存储实战
</a></li><li class="dropdown-subitem"><a href="/record/middle-office/" class="nav-link">
  说透中台
</a></li><li class="dropdown-subitem"><a href="/record/oath2/" class="nav-link router-link-active">
  Oath 2.0 实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Git
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/git/" class="nav-link">
  Git 零散知识
</a></li><li class="dropdown-subitem"><a href="/record/git-scm/" class="nav-link">
  Git 系统学习笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          Mycat
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/mycat/" class="nav-link">
  Mycat 1
</a></li><li class="dropdown-subitem"><a href="/record/mycat2/" class="nav-link">
  Mycat 2
</a></li></ul></li><li class="dropdown-item"><h4>
          笔记精选汇总
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://blog.csdn.net/maoyeqiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub 站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/txxs/record" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://blog.csdn.net/maoyeqiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客（csdn）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="设计模式" class="dropdown-title"><span class="title">设计模式</span> <span class="arrow down"></span></button> <button type="button" aria-label="设计模式" class="mobile-dropdown-title"><span class="title">设计模式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/record/imocc/design_pattern/" class="nav-link">
  设计模式（慕课）
</a></li><li class="dropdown-item"><!----> <a href="/record/design_pattern/" class="nav-link">
  研磨设计模式（李兴华）
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Elasticsearch" class="dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow down"></span></button> <button type="button" aria-label="Elasticsearch" class="mobile-dropdown-title"><span class="title">Elasticsearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/record/elasticsearch-core/" class="nav-link">
  核心知识篇
</a></li><li class="dropdown-item"><!----> <a href="/record/elasticsearch-senior/" class="nav-link">
  高级知识篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="dropdown-title"><span class="title">缓存架构-亿级流量电商详情页系统实战</span> <span class="arrow down"></span></button> <button type="button" aria-label="缓存架构-亿级流量电商详情页系统实战" class="mobile-dropdown-title"><span class="title">缓存架构-亿级流量电商详情页系统实战</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          综合性导航
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/cache-pdp/" class="nav-link">
  全目录导航
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/001-introduce.html" class="nav-link">
  第一版（001 ~ 123 章）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/124.html" class="nav-link">
  第二版（124 ~ 195 章）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/121.html" class="nav-link">
  课程总结（难题与解决方案）
</a></li></ul></li><li class="dropdown-item"><h4>
          精彩知识精选
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/cache-pdp/redis/007.html" class="nav-link">
  Redis 篇（redis 企业级集群架构）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/035.html" class="nav-link">
  多级缓存架构设计
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/040.html" class="nav-link">
  数据库 + 缓存双写一致性解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/045.html" class="nav-link">
  缓存维度化拆分解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/051.html" class="nav-link">
  缓存命中率提升解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/057.html" class="nav-link">
  缓存并发重建冲突解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/069.html" class="nav-link">
  缓存预热解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/077.html" class="nav-link">
  热点缓存自动降级方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/110.html" class="nav-link">
  缓存雪崩解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/117.html" class="nav-link">
  缓存穿透解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/119.html" class="nav-link">
  缓存失效解决方案
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/hystrix/084.html" class="nav-link">
  高可用分布式系统架构设计（hystrix 篇）
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/047.html" class="nav-link">
  spring boot 整合 ehcache
</a></li><li class="dropdown-subitem"><a href="/record/cache-pdp/storm/062.html" class="nav-link">
  史上最通俗易懂 Storm 教程
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/record/introduce/" class="nav-link">
  本笔记介绍
</a></li><li class="dropdown-item"><!----> <a href="https://zq99299.github.io/linux-tutorial/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Linux 基础篇
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="/record/spring-cloud-tutorial/" class="nav-link">
  Spring Cloud
</a></li><li class="dropdown-item"><!----> <a href="/record/css-zxx/" class="nav-link">
  CSS 深入理解（张鑫旭）
</a></li><li class="dropdown-item"><!----> <a href="/record/regular/" class="nav-link">
  正则入门
</a></li><li class="dropdown-item"><h4>
          思路拓展
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/back-end-storage/" class="nav-link">
  后端存储实战
</a></li><li class="dropdown-subitem"><a href="/record/middle-office/" class="nav-link">
  说透中台
</a></li><li class="dropdown-subitem"><a href="/record/oath2/" class="nav-link router-link-active">
  Oath 2.0 实战
</a></li></ul></li><li class="dropdown-item"><h4>
          Git
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/git/" class="nav-link">
  Git 零散知识
</a></li><li class="dropdown-subitem"><a href="/record/git-scm/" class="nav-link">
  Git 系统学习笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          Mycat
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/record/mycat/" class="nav-link">
  Mycat 1
</a></li><li class="dropdown-subitem"><a href="/record/mycat2/" class="nav-link">
  Mycat 2
</a></li></ul></li><li class="dropdown-item"><h4>
          笔记精选汇总
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://blog.csdn.net/maoyeqiu" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub 站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <a href="https://github.com/txxs/record" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/record/oath2/" aria-current="page" class="sidebar-link">OAuth 2.0 实战</a></li><li><a href="/record/oath2/00/" class="sidebar-link">为什么要学 OAuth 2.0？</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>进阶篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/record/oath2/02/" aria-current="page" class="sidebar-link">进阶篇</a></li><li><a href="/record/oath2/02/01.html" class="sidebar-link">如何在移动 App 中使用 OAuth 2.0？</a></li><li><a href="/record/oath2/02/02.html" class="sidebar-link">实践 OAuth 2.0 时，使用不当可能会导致哪些安全漏洞？</a></li><li><a href="/record/oath2/02/03.html" class="sidebar-link">实战：利用 OAuth 2.0 实现一个 OpenID Connect 用户身份认证协议</a></li><li><a href="/record/oath2/02/04.html" class="sidebar-link">串讲：OAuth 2.0 的工作流程与安全问题</a></li><li><a href="/record/oath2/02/05.html" aria-current="page" class="active sidebar-link">实战案例：使用 Spring Security 搭建一套基于 JWT 的 OAuth 2.0 架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#项目准备工作" class="sidebar-link">项目准备工作</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#搭建授权服务器" class="sidebar-link">搭建授权服务器</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#搭建受保护资源服务器" class="sidebar-link">搭建受保护资源服务器</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#初始化数据配置" class="sidebar-link">初始化数据配置</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#演示三种授权许可类型" class="sidebar-link">演示三种授权许可类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#资源拥有者凭据许可类型" class="sidebar-link">资源拥有者凭据许可类型</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#客户端授权许可类型" class="sidebar-link">客户端授权许可类型</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#授权码许可类型" class="sidebar-link">授权码许可类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#演示权限控制" class="sidebar-link">演示权限控制</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#搭建客户端程序" class="sidebar-link">搭建客户端程序</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#演示单点登录" class="sidebar-link">演示单点登录</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#演示客户端请求资源服务器资源" class="sidebar-link">演示客户端请求资源服务器资源</a></li><li class="sidebar-sub-header"><a href="/record/oath2/02/05.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/record/oath2/02/06.html" class="sidebar-link">架构案例：基于 OAuth 2.0/JWT 的微服务参考架构</a></li><li><a href="/record/oath2/02/07.html" class="sidebar-link">各大开放平台是如何使用 OAuth 2.0 的？</a></li><li><a href="/record/oath2/02/08.html" class="sidebar-link">查漏补缺：OAuth 2.0 常见问题答疑</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实战案例-使用-spring-security-搭建一套基于-jwt-的-oauth-2-0-架构"><a href="#实战案例-使用-spring-security-搭建一套基于-jwt-的-oauth-2-0-架构" class="header-anchor">#</a> 实战案例：使用 Spring Security 搭建一套基于 JWT 的 OAuth 2.0 架构</h1> <p>如果你熟悉  Spring Security 的话，肯定知道它因为功能多、组件抽象程度高、配置方式多样，导致了强大且复杂的特性。也因此，Spring Security 的学习成本几乎是 Spring 家族中最高的。但不仅于此，在结合实际的复杂业务场景使用 Spring Security 时，我们还要去理解一些组件的工作原理和流程，不然需要自定义和扩展框架的时候就会手足无措。这就让使用 Spring Security 的门槛更高了。</p> <p>因此，在决定使用 Spring Security 搭建整套安全体系（授权、认证、权限、审计）之前，我们还需要考虑的是：将来我们的业务会多复杂，徒手写一套安全体系来得划算，还是使用 Spring Security 更好？这也是本课程前面并没有使用 Spring Security 来演示 OAuth 2.0 流程的原因之一。</p> <p>反过来说，如果你的应用已经使用了 Spring Security 来做鉴权、认证和权限管理的话，那么仍然使用 Spring Security 来实现 OAuth 的成本是很低的。而且，在学习了 OAuth 2.0 的流程打下扎实的基础之后，我们再使用 Spring Security 来配置 OAuth 2.0 就不会那么迷茫了。这也是我在工作中使用 Spring Security 来实现 OAuth 2.0 的直观感受。</p> <p>所以，我就结合自己的实践和积累，带你使用 Spring Security 来一步一步地搭建一套基于 JWT 的 OAuth 2.0 授权体系。这些内容会涉及 OAuth 2.0 的三角色（客户端、授权服务、受保护资源），以及资源拥有者凭据许可、客户端凭据许可和授权码许可这三种常用的授权许可类型（隐式许可类型，不太安全也不太常用）。同时，我还会演示 OAuth 2.0 的权限控制，以及使用 OAuth 2.0 实现 SSO 单点登录体系。</p> <p>这样一来，今天这一讲涉及到的流程就会比较多，内容也会很长。不过不用担心，我会手把手带你从零开始，完成整个程序的搭建，并给出所有流程的演示。</p> <h2 id="项目准备工作"><a href="#项目准备工作" class="header-anchor">#</a> 项目准备工作</h2> <p>实战之前，我们先来搭建项目父依赖和初始化数据库结构，为后面具体的编码做准备。</p> <p>首先，我们来创建一个父 POM（笔者这里使用 gradle 来搭建），内含三个模块：</p> <ul><li><p>springsecurity101-cloud-oauth2-client，用来扮演客户端角色；</p></li> <li><p>springsecurity101-cloud-oauth2-server，用来扮演授权服务器角色；</p></li> <li><p>springsecurity101-cloud-oauth2-userservice，是用户服务，用来扮演资源提供者角色。</p></li></ul> <p>然后，我们来创建一个 oauth 数据库，初始化将来会用到的 5 个表。</p> <ul><li><p>authorities 表：记录账号的权限，需要我们在后面配置。</p></li> <li><p>oauth_approvals 表：记录授权批准的状态。</p></li> <li><p>oauth_client_details 表：记录 OAuth 的客户端，需要我们在后面做配置。</p></li> <li><p>oauth_code 表：记录授权码。</p></li> <li><p>users 表：记录账号，需要我们在后面做初始化。</p></li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for authorities</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>authorities<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>authorities<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authority<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>ix_auth_username<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>authority<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>fk_authorities_users<span class="token punctuation">`</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_approvals</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>oauth_approvals<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_approvals<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>userId<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>clientId<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>partnerKey<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>scope<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>expiresAt<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lastModifiedAt<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_client_details</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token comment">-- client_id 长度过长，255 -&gt; 128</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>client_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>resource_ids<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>scope<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authorized_grant_types<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>web_server_redirect_uri<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authorities<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>additional_information<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>autoapprove<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_code</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>code<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authentication<span class="token punctuation">`</span> <span class="token keyword">blob</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for users</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>enabled<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>这 5 个表是 Spring Security OAuth 需要用到的存储表，我们不要去修改既有的表结构。这里可以看到，我们并没有在数据库中创建相应的表，来存放访问令牌和刷新令牌。这是因为，我们之后的实现会使用 JWT 来传输令牌信息，以便进行本地校验，所以并不一定要将其存放到数据库中。基本上所有的这些表都是可以自己扩展的，只需要继承实现 Spring 的一些既有类即可，这里不做展开。</p> <p>接下来，我们开始搭建授权服务器和受保护资源服务器。</p> <h2 id="搭建授权服务器"><a href="#搭建授权服务器" class="header-anchor">#</a> 搭建授权服务器</h2> <p>build.gradle</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>plugins <span class="token punctuation">{</span>
    id <span class="token string">'org.springframework.boot'</span> version <span class="token string">'2.4.1'</span>
    id <span class="token string">'io.spring.dependency-management'</span> version <span class="token string">'1.0.10.RELEASE'</span>
    id <span class="token string">'java'</span>
<span class="token punctuation">}</span>

group <span class="token operator">=</span> <span class="token string">'cn.mrcode.cloudoath2.server'</span>
version <span class="token operator">=</span> <span class="token string">'0.0.1-SNAPSHOT'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token string">'1.8'</span>

repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    maven <span class="token punctuation">{</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ext <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;2020.0.0-RC1&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-data-jdbc'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-thymeleaf'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-starter-oauth2'</span>
    testImplementation <span class="token string">'org.springframework.boot:spring-boot-starter-test'</span>

    implementation <span class="token string">'mysql:mysql-connector-java'</span>
    <span class="token comment">// ~ lombok 编译等支持==========================</span>
    <span class="token function">compileOnly</span><span class="token punctuation">(</span><span class="token string">'org.projectlombok:lombok'</span><span class="token punctuation">)</span>
    <span class="token function">annotationProcessor</span><span class="token punctuation">(</span><span class="token string">'org.projectlombok:lombok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencyManagement <span class="token punctuation">{</span>
    imports <span class="token punctuation">{</span>
        mavenBom <span class="token string gstring">&quot;org.springframework.cloud:spring-cloud-dependencies:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>springCloudVersion<span class="token punctuation">}</span></span>&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

test <span class="token punctuation">{</span>
    <span class="token function">useJUnitPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>这里，我们使用了 Spring Cloud 的 spring-cloud-starter-oauth2 组件，而不是直接使用的 Spring Security，因为前者做了一些自动化配置的工作，使用起来会更方便。</p> <p>此外，我们还在 POM 中加入了数据访问、Web 等依赖，因为我们的受保护资源服务器需要使用数据库来保存客户端的信息、用户信息等数据，同时也会引入 thymeleaf 模板引擎依赖，来稍稍美化一下登录页面。</p> <p>然后创建一个配置文件 application.yml 实现程序配置：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>server
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>6657/oauth<span class="token punctuation">?</span>useSSL=false
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> kIo9u7Oi0eg
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到，我们配置了 oauth 数据库的连接字符串，定义了授权服务器的监听端口是 8080。</p> <p>最后，使用 keytool 工具生成密钥对，把密钥文件 jks 保存到资源目录下，并要导出一个公钥留作以后使用。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 运行下面的命令生成私钥，姓名国家啥的可以不填</span>
$ keytool -genkey -alias oath2-jwt -keyalg RSA -keysize <span class="token number">1024</span> -keystore jwt.jks -validity <span class="token number">365</span> -keypass <span class="token number">123456</span> -storepass <span class="token number">123456</span>
<span class="token comment"># -alias 选项为别名，-keypass 和 -storepass 为密码选项，-validity 为配置 jks 文件的过期时间（单位：天）。</span>
<span class="token comment"># 完成之后，要求转移到新的标准</span>
$ keytool -importkeystore -srckeystore jwt.jks -destkeystore jwt.jks -deststoretype pkcs12

<span class="token comment"># 获取的 jks 文件作为私钥，是如何解密JWT的呢？这时就需要使用 jks 文件的公钥。获取jks文件的公钥命令如下：</span>
$ keytool -list -rfc --keystore jwt.jks <span class="token operator">|</span> openssl x509 -inform pem -pubkey
<span class="token comment"># 输入密码后：123456 ，将生产下面的</span>
-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCM0iHtBw+Kbmynd34MS1g8DvcQ
hhDNacxRepPKmzMs524UX1bLeMlM6A4TE1Gp106nz5xRGPB4AVHq7BFe25H/xdT3
SpoSvfnkb9SgfPX7Y+PuNLxhGxUt8qNgzHEjsJomxEiYGsYIaxScFuGK6uXhPi4d
c4csrdiaAelTIAASRQIDAQAB
-----END PUBLIC KEY-----
-----BEGIN CERTIFICATE-----
MIICcjCCAdugAwIBAgIEG0oUDzANBgkqhkiG9w0BAQsFADBsMRAwDgYDVQQGEwdV
bmtub3duMRAwDgYDVQQIEwdVbmtub3duMRAwDgYDVQQHEwdVbmtub3duMRAwDgYD
VQQKEwdVbmtub3duMRAwDgYDVQQLEwdVbmtub3duMRAwDgYDVQQDEwdVbmtub3du
MB4XDTIwMTIxODA2MjIwMloXDTIxMTIxODA2MjIwMlowbDEQMA4GA1UEBhMHVW5r
bm93bjEQMA4GA1UECBMHVW5rbm93bjEQMA4GA1UEBxMHVW5rbm93bjEQMA4GA1UE
ChMHVW5rbm93bjEQMA4GA1UECxMHVW5rbm93bjEQMA4GA1UEAxMHVW5rbm93bjCB
nzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAjNIh7QcPim5sp3d+DEtYPA73EIYQ
zWnMUXqTypszLOduFF9Wy3jJTOgOExNRqddOp8+cURjweAFR6uwRXtuR/8XU90qa
Er355G/UoHz1+2Pj7jS8YRsVLfKjYMxxI7CaJsRImBrGCGsUnBbhiurl4T4uHXOH
LK3YmgHpUyAAEkUCAwEAAaMhMB8wHQYDVR0OBBYEFLB6k0kr0YK9fgG2qJ7fK+MQ
+984MA0GCSqGSIb3DQEBCwUAA4GBAEdv2UMAzqVDXvnIbBnP+kUafemA2rxxT+jg
9d/sVMcqrLgvGXv555U1OWGoSMKe1t3exiXvoYSaOzQUeTjyqxAXycb12N07CqB8
+XV1a+AA6vnksdB8HqfsUUAMWUnYPZPmI3FEEs2g2/PhHt1ItkH6LUAknSMqqe/t
58VPFwUO
-----END CERTIFICATE-----
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>以上完成了项目框架搭建工作，接下来，我们正式开始编码。</p> <p>第一步，创建一个最核心的类用于配置授权服务器。我把每段代码的作用放在了注释里，你可以直接看下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">ClientDetailsServiceConfigurer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerConfigurerAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableAuthorizationServer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerSecurityConfigurer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>approval<span class="token punctuation">.</span></span><span class="token class-name">JdbcApprovalStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>code<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationCodeServices</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>code<span class="token punctuation">.</span></span><span class="token class-name">JdbcAuthorizationCodeServices</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenEnhancer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">KeyStoreKeyFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ViewControllerRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span> <span class="token comment">//开启授权服务器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

    <span class="token comment">/**
     * &lt;pre&gt;
     *  我们配置了使用数据库来维护客户端信息。虽然在各种 Demo 中我们经常看到的是在内存中维护客户端信息， 通过配置直接写死在这里。
     *
     *  但是，对于实际的应用我们一般都会用数据库来维护这个信息，甚至还会建立一套工作流来允许客户端自己申请 ClientID，实现 OAuth 客户端接入的审批。
     * &lt;/pre&gt;
     *
     * @param clients
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">jdbc</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 这里干了两件事儿。
     * &lt;pre&gt;
     *   首先，打开了验证 Token 的访问权限（以便之后我们演示）。
     *   然后，允许 ClientSecret 明文方式保存，并且可以通过表单提交（而不仅仅是 BasicAuth方式提交），之后会演示到这个。
     * &lt;/pre&gt;
     *
     * @param security
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        security<span class="token punctuation">.</span><span class="token function">checkTokenAccess</span><span class="token punctuation">(</span><span class="token string">&quot;permitAll()&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">allowFormAuthenticationForClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;pre&gt;
     * 干了以下4件事儿：
     * 1. 配置我们的令牌存放方式为 JWT方式，而不是内存、数据库或 Redis方式。
     *      JWT 是 Json Web Token 的缩写，也就是使用 JSON 数据格式包装的令牌，由 .号把整个 JWT分隔为头、数据体、签名三部分。
     *      JWT保存 Token 虽然易于使用但是不是那么安全，一般用于内部，且需要走 HTTPS 并配置比较短的失效时间。
     * 2. 配置 JWT Token 的非对称加密来进行签名
     * 3. 配置一个自定义的 Token 增强器，把更多信息放入 Token 中
     * 4. 配置使用 JDBC 数据库方式来保存用户的授权批准记录
     * &lt;/pre&gt;
     *
     * @param endpoints
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span>
                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        endpoints<span class="token punctuation">.</span><span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用 JDBC 数据库方式来保存授权码
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationCodeServices</span> <span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcAuthorizationCodeServices</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用 JWT 存储
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用 JDBC 数据库方式来保存用户的授权批准记录
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcApprovalStore</span> <span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcApprovalStore</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 自定义的Token增强器，把更多信息放入Token中
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenEnhancer</span> <span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置 JWT 使用非对称加密方式来验证
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 生成的 jks 文件 和 密码</span>
        <span class="token class-name">KeyStoreKeyFactory</span> keyStoreKeyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyStoreKeyFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;jwt.jks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setKeyPair</span><span class="token punctuation">(</span>keyStoreKeyFactory<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;oath2-jwt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 生成时候的别名</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置登录页面的视图信息（其实可以独立一个配置类，这样会更规范）
     */</span>
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br></div></div><p>第二步，还记得吗，刚才在第一步的代码中我们还用到了一个自定义的 Token 增强器，把用户信息嵌入到 JWT Token 中去（如果使用的是客户端凭据许可类型，这段代码无效，因为和用户没关系）。</p> <p>这是一个常见需求。因为，默认情况下 Token 中只会有用户名这样的基本信息，我们往往需要把关于用户的更多信息返回给客户端（在实际应用中，你可能会从数据库或外部服务查询更多的用户信息加入到 JWT Token 中去）。这个时候，我们就可以自定义增强器来丰富 Token 的内容：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AccessToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenEnhancer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTokenEnhancer</span> <span class="token keyword">implements</span> <span class="token class-name">TokenEnhancer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Authentication</span> userAuthentication <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getUserAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userAuthentication <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> principal <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getUserAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//把用户标识嵌入 JWT Token 中去(Key 是 userDetails)</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> additionalInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            additionalInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userDetails&quot;</span><span class="token punctuation">,</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">)</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>additionalInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>第三步，实现安全方面的配置。你可以直接看下代码注释，来了解关键代码的作用。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>server</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManagerBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置用户账户的认证方式。
     * &lt;pre&gt;
     * 显然，我们把用户存在了数据库中希望配置 JDBC 的方式。
     * 此外，我们还配置了使用 BCryptPasswordEncoder 哈希来保存用户的密码（生产环境中，用户密码肯定不能是明文保存的）
     * &lt;/pre&gt;
     *
     * @param auth
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        auth<span class="token punctuation">.</span><span class="token function">jdbcAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &lt;pre&gt;
     * 开放 /login 和 /oauth/authorize 两个路径的匿名访问。
     * 前者用于登录，后者用于换授权码，这两个端点访问的时机都在登录之前。
     * 设置 /login 使用表单验证进行登录。
     *
     * &lt;/pre&gt;
     *
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/oauth/authorize&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>第四步，在资源目录下创建一个 templates 文件夹，然后创建一个 login.html 登录页：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>登录页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-height-1-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-vertical-align uk-text-center uk-height-1-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-vertical-align-middle<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">width</span><span class="token punctuation">:</span> 250px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Login Form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-text-danger<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${param.error}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            用户名或密码错误...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-panel uk-panel-box uk-form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/login}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-form-large<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Username<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reader<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-form-large<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Password<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span>
                       <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reader<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-button uk-button-primary uk-button-large<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Login
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>至此，授权服务器的编码工作就完成了。</p> <h2 id="搭建受保护资源服务器"><a href="#搭建受保护资源服务器" class="header-anchor">#</a> 搭建受保护资源服务器</h2> <p>接下来，我们搭建一个用户服务模拟资源提供者（受保护资源服务器）。我们先看看项目初始化工作。</p> <p>这次创建的 POM 没有什么特殊，依赖了 spring-cloud-starter-oauth2：</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>plugins <span class="token punctuation">{</span>
    id <span class="token string">'org.springframework.boot'</span> version <span class="token string">'2.4.1'</span>
    id <span class="token string">'io.spring.dependency-management'</span> version <span class="token string">'1.0.10.RELEASE'</span>
    id <span class="token string">'java'</span>
<span class="token punctuation">}</span>

group <span class="token operator">=</span> <span class="token string">'cn.mrcode.cloudoath2.server'</span>
version <span class="token operator">=</span> <span class="token string">'0.0.1-SNAPSHOT'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token string">'1.8'</span>

repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    maven <span class="token punctuation">{</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ext <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;2020.0.0-RC1&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-starter-oauth2'</span>
<span class="token punctuation">}</span>

dependencyManagement <span class="token punctuation">{</span>
    imports <span class="token punctuation">{</span>
        mavenBom <span class="token string gstring">&quot;org.springframework.cloud:spring-cloud-dependencies:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>springCloudVersion<span class="token punctuation">}</span></span>&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

test <span class="token punctuation">{</span>
    <span class="token function">useJUnitPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>配置文件非常简单，只是声明了资源服务端口为 8081：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>同时，还要记得把我们之前在项目准备工作时生成的密钥对的公钥命名为 public.cert，并放到资源文件下。这样，资源服务器可以本地校验 JWT 的合法性。内容大概是这样的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-----BEGIN PUBLIC KEY-----
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCM0iHtBw+Kbmynd34MS1g8DvcQ
hhDNacxRepPKmzMs524UX1bLeMlM6A4TE1Gp106nz5xRGPB4AVHq7BFe25H/xdT3
SpoSvfnkb9SgfPX7Y+PuNLxhGxUt8qNgzHEjsJomxEiYGsYIaxScFuGK6uXhPi4d
c4csrdiaAelTIAASRQIDAQAB
-----END PUBLIC KEY-----
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>好了，让我们正式开始编码吧。</p> <p>第一步，创建一个可以匿名访问的接口 <code>GET /hello</code>，用来测试无需登录就可以访问的服务端资源：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>userservice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>第二步，创建三个需要登录 + 授权才能访问到的接口。我们通过 <code>@PreAuthorize</code>  在方法执行前进行权限控制：</p> <ol><li><p><code>GET /user/name</code> 接口，读权限或写权限可访问，返回登录用户名；</p></li> <li><p><code>GET /user</code> 接口，读权限或写权限可访问，返回登录用户信息；</p></li> <li><p><code>POST /user</code> 接口，只有写权限可以访问，返回访问令牌中的额外信息（也就是自定义的 Token 增强器 CustomTokenEnhancer 加入到访问令牌中的额外信息，Key 是 userDetails），这里也演示了使用 TokenStore 来解析 Token 的方式。</p></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>userservice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span>prepost<span class="token punctuation">.</span></span><span class="token class-name">PreAuthorize</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AccessToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthenticationDetails</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token comment">/***
     * 读权限或写权限可访问，返回登录用户名
     * @param authentication
     * @return
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 读权限或写权限可访问，返回登录用户信息
     *
     * @param authentication
     * @return
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2Authentication</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 只有写权限可以访问，返回访问令牌中的额外信息
     *
     * @param authentication
     * @return
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OAuth2AuthenticationDetails</span> details <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OAuth2AuthenticationDetails</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OAuth2AccessToken</span> accessToken <span class="token operator">=</span> tokenStore<span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">.</span><span class="token function">getAdditionalInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token string">&quot;userDetails&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>第三步，创建核心的资源服务器配置类。这里我们需要注意下面两点：</p> <ul><li><p>我们硬编码了资源服务器的 ID 为 userservice；</p></li> <li><p>现在我们使用的是不落数据库的 JWT 方式 + 非对称加密，需要通过本地公钥进行验证，因此在这里我们配置了公钥的路径。</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>userservice</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>method<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableGlobalMethodSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableResourceServer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">ResourceServerConfigurerAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">ResourceServerSecurityConfigurer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">FileCopyUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span> <span class="token comment">//启用资源服务器</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//启用方法注解方式来进行权限控制</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 声明了资源服务器的 ID 是 userservice，声明了资源服务器的 TokenStore 是 JWT
     *
     * @param resources
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ResourceServerSecurityConfigurer</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        resources<span class="token punctuation">.</span><span class="token function">resourceId</span><span class="token punctuation">(</span><span class="token string">&quot;userservice&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置 TokenStore
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置公钥
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;public.cert&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> publicKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            publicKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">FileCopyUtils</span><span class="token punctuation">.</span><span class="token function">copyToByteArray</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        converter<span class="token punctuation">.</span><span class="token function">setVerifierKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置了除了 /user 路径之外的请求可以匿名访问
     *
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/user/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>到这里，我们来想一下，如果授权服务器产生 Token 的话，受保护资源服务器必须要有一种办法来验证 Token，那如果这里的 Token 不是 JWT 的方式，我们可以怎么办呢？</p> <p>我来说下我的方法吧：</p> <ul><li><p>首先，Token 可以保存在数据库或 Redis 中，资源服务器和授权服务器共享底层的 TokenStore 来验证；</p></li> <li><p>然后，资源服务器可以使用 RemoteTokenServices，来从授权服务器的 <code>/oauth/check_token</code>  端点进行 Token 校验。</p></li></ul> <p>到这里，资源服务器就配置完成了，我们还在资源服务器中分别创建了两个控制器 HelloController 和 UserController，用于分别测试可以匿名访问以及受到权限保护的资源。</p> <h2 id="初始化数据配置"><a href="#初始化数据配置" class="header-anchor">#</a> 初始化数据配置</h2> <p>在实现了授权服务器和受保护资源服务器代码后，我们再来初始化 oauth 数据库的数据就非常容易理解了。总结起来，我们需要配置用户、权限和客户端三部分。</p> <ol><li><p>配置两个用户。</p> <ul><li>其中，读用户 reader 具有读权限，密码为 reader；</li> <li>写用户 writer 具有读写权限，密码为 writer。</li></ul> <p>还记得吗，密码我们使用的是 BCryptPasswordEncoder 加密（准确说是哈希）？</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token string">'$2a$04$C6pPJvC1v6.enW6ZZxX.luTdpSI/1gcgTVN7LhvQV6l/AfmzNU/3i'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token string">'$2a$04$M9t2oVs3/VIreBMocOujqOaB/oziWL0SnlWdt8hV4YnlhQrORA0fS'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>配置两个权限，也就是配置 reader 用户具有读权限，writer 用户具有写权限：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>authorities<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token string">'READ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>authorities<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>配置三个客户端：</p> <ol><li>其中客户端 userservice1 使用资源拥有者凭据许可类型</li> <li>客户端 userservice2 使用客户端凭据许可类型</li> <li>客户端 userservice3 使用授权码许可类型。</li></ol> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice1'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'password,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice2'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'client_credentials,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice3'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'authorization_code,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">'https://baidu.com,http://localhost:8082/ui/login,http://localhost:8083/ui/login,http://localhost:8082/ui/remoteCall'</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol> <p>值得说明的是：</p> <ul><li><p>三个客户端账号能使用的资源 ID 都是 userservice，对应我们受保护资源服务器刚才配置的资源 ID，也就是 userservice，这两者需要一致。</p></li> <li><p>三个客户端账号的密码都是 1234。</p></li> <li><p>三个客户端账号的授权范围都是 FOO（并不是关键信息），它们可以拿到的权限是读写。不过，对于和用户相关的授权许可类型（比如资源拥有者凭据许可、授权码许可），最终拿到的权限还取决于客户端权限和用户权限的交集。</p></li></ul> <p>通过 grant_types 字段配置支持不同的授权许可类型。这里为了便于测试观察，我们给三个客户端账号各自配置了一种授权许可类型；在实际业务场景中，你完全可以为同一个客户端配置支持 OAuth 2.0 的四种授权许可类型。</p> <p>userservice1 和 userservice2 我们配置了用户自动批准授权（不会弹出一个页面要求用户进行授权）。</p> <h2 id="演示三种授权许可类型"><a href="#演示三种授权许可类型" class="header-anchor">#</a> 演示三种授权许可类型</h2> <p>到这里，授权服务器和受保护资源服务器程序都搭建完成了，数据库也配置了用于测试的用户、权限和客户端。接下来，我们就使用 Postman 来手工测试一下 OAuth 2.0 的授权码许可、资源拥有者凭据许可、客户端凭据许可这三种授权许可类型吧。</p> <h3 id="资源拥有者凭据许可类型"><a href="#资源拥有者凭据许可类型" class="header-anchor">#</a> 资源拥有者凭据许可类型</h3> <p>首先，我们测试的是资源拥有者凭据许可，POST 请求地址是：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/token?grant_type=password&amp;client_id=userservice1&amp;client_secret=1234&amp;username=writer&amp;password=writer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到的结果如下</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/token?grant_type=password&amp;client_id=userservice1&amp;client_secret=1234&amp;username=writer&amp;password=writer</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
Cache-Control<span class="token operator">:</span> no-store
Pragma<span class="token operator">:</span> no-cache
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json;charset=UTF<span class="token number">-8</span>
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">21</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoid3JpdGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI4MjAyMSwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoid3JpdGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQsV1JJVEUifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFELFdSSVRFIl0sImp0aSI6ImVjM2Y3YTY1LTA4MzQtNDQ2ZC05NDkyLWVhZjhkN2VhZjZjOCIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMSJ9.BA8vH4KN2Cx4EG0mA78VM0rNDDNrYDxcuNpa6jCT49YA7xNeWXbv3Q47nEJg_idv59EAkJdxtJfIMgX8olhik1YxwAgJcA92BlEoqY4N2jNAkgNXtvIHaa_V2Eq3m8B_KhMV2xNQFm0G2JEr0DIfSK6Lr8o_ODbu3cBfAKvy648&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoid3JpdGVyIiwic2NvcGUiOlsiRk9PIl0sImF0aSI6ImVjM2Y3YTY1LTA4MzQtNDQ2ZC05NDkyLWVhZjhkN2VhZjZjOCIsImV4cCI6MTYxMDg2NjgyMSwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoid3JpdGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQsV1JJVEUifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFELFdSSVRFIl0sImp0aSI6IjhmYTk0NTJmLTE4NTktNDg0Ni1iZGUxLThlM2ZmMmIwOGRjNSIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMSJ9.P9yxZYDEmxBWGZm0RDq6ZA9vTHXz_rPIKLICjSrTRDbe-dGprvqZaiqJfstzXt3inThnuj_CCK61nA6wOTxf1rM8rkjyBC3y9TK8a-A_DInxIjnPPnlBJWjoknyHeDC9Bh4eCK2auSV9BE1HTAMhLdpoZdkgLAPhNX0z0fgpkUk&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FOO&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userDetails&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ,WRITE&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ec3f7a65-0834-446d-9492-eaf8d7eaf6c8&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>再使用 <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWT 解析工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 看下请求 Token 中的信息：</p> <p><img src="assets/8e4c2dd1931a31197df55cc251b2a07e.png" alt="img"></p> <p>可以看到，Token 中果然包含了 Token 增强器加入的 userDetails 自定义信息。如果我们把公钥粘贴到页面的话，可以看到这个 JWT 校验成功了：</p> <p><img src="assets/4d701319144d3de7c5d743f59e4991ae.png" alt="img"></p> <p>除了本地校验外，还可以访问授权服务器来校验 JWT：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/check_token?client_id=userservice1&amp;client_secret=1234&amp;token=...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-json line-numbers-mode"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/check_token?client_id=userservice1&amp;client_secret=1234&amp;token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoid3JpdGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI4MjAyMSwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoid3JpdGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQsV1JJVEUifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFELFdSSVRFIl0sImp0aSI6ImVjM2Y3YTY1LTA4MzQtNDQ2ZC05NDkyLWVhZjhkN2VhZjZjOCIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMSJ9.BA8vH4KN2Cx4EG0mA78VM0rNDDNrYDxcuNpa6jCT49YA7xNeWXbv3Q47nEJg_idv59EAkJdxtJfIMgX8olhik1YxwAgJcA92BlEoqY4N2jNAkgNXtvIHaa_V2Eq3m8B_KhMV2xNQFm0G2JEr0DIfSK6Lr8o_ODbu3cBfAKvy648</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
Cache-Control<span class="token operator">:</span> no-cache<span class="token punctuation">,</span> no-store<span class="token punctuation">,</span> max-age=<span class="token number">0</span><span class="token punctuation">,</span> must-revalidate
Pragma<span class="token operator">:</span> no-cache
Expires<span class="token operator">:</span> <span class="token number">0</span>
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">55</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;userservice&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;user_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;FOO&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;active&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1608282021</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userDetails&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ,WRITE&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;READ,WRITE&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ec3f7a65-0834-446d-9492-eaf8d7eaf6c8&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;client_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userservice1&quot;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="客户端授权许可类型"><a href="#客户端授权许可类型" class="header-anchor">#</a> 客户端授权许可类型</h3> <p>我们再来测试下客户端授权许可类型。POST 请求地址：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/token?grant_type=client_credentials&amp;client_id=userservice2&amp;client_secret=1234</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
Cache-Control<span class="token operator">:</span> no-store
Pragma<span class="token operator">:</span> no-cache
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json;charset=UTF<span class="token number">-8</span>
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">07</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">56</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI4MjQxNiwiYXV0aG9yaXRpZXMiOlsiUkVBRCIsIldSSVRFIl0sImp0aSI6IjI0ZjhjMGMzLWE0NTQtNGQwYy04NTAxLTQ2MjY0YjMyZTliMCIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMiJ9.H5knrswTnlEnWYfb21EGcYFenIg1gU0hNyy1RELKrQWFuBAocDA_P4OxxzCQ-I4IVxq2N4E5_ve-Oo28jzgWvpgT9LD6BX6KZkw8a2mozgy4Jh-6eLKyIrvf-kX9qaCkztcQoFrqcFloLEsJMeCO7aCXwsflli4f6VbdfltGXpk&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FOO&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;24f8c0c3-a454-4d0c-8501-46264b32e9b0&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这里需要注意的是，并没有提供刷新令牌。这是因为，刷新令牌用于避免访问令牌失效后需要用户再次登录的问题，而客户端授权许可类型没有用户的概念，因此没有刷新令牌，<strong>也无法注入额外的 userDetails 信息</strong>。</p> <p><img src="assets/fcf2b1c1a53ecc33d3a0abc72b6d83da.png" alt="img"></p> <p>也可以试一下，如果我们的授权服务器没有开启 <code>allowFormAuthenticationForClients</code>  参数（允许表单提交认证）的话，客户端的凭证需要通过 Basic Auth 传过去而不是通过 Post：</p> <h3 id="授权码许可类型"><a href="#授权码许可类型" class="header-anchor">#</a> 授权码许可类型</h3> <p>最后，我们来测试下比较复杂的授权码许可。</p> <p><strong>第一步</strong>，打开浏览器访问地址：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=userservice3&amp;redirect_uri=https://baidu.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意，客户端跳转地址需要和数据库中配置的一致（百度的 URL https://baidu.com 我们之前已经在数据库中有配置了）。访问后页面会直接跳转到登录界面，我们使用用户名 「reader」、密码「reader」来登录：</p> <p><img src="assets/73c3bd926e4e350b220447cd8b97d811.png" alt="img"></p> <p>由于我们在数据库中设置的是禁用自动批准授权的模式，所以登录后来到了批准界面：</p> <p><img src="assets/9cac3b06b632220166d7e43607da4901.png" alt="img"></p> <p>点击同意后可以看到，数据库中也会产生授权通过记录：</p> <p><img src="assets/9e942cc7c22ff8b4540e9f6736d56b6f.png" alt="img"></p> <p>**第二步，**我们可以看到浏览器转到了百度并且提供给了我们授权码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
https://www.baidu.com/?code=XKkHGY
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>数据库中也记录了授权码：</p> <p><img src="assets/eff235ff90aafb559d6e45b07a4d173e.png" alt="img"></p> <p>然后 POST 访问下面的地址（code 参数替换为刚才获得的授权码）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=userservice3&amp;client_secret=1234&amp;code=XKkHGY&amp;redirect_uri=https://baidu.com

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以通过授权码换取访问令牌：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST http<span class="token operator">:</span><span class="token comment">//localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=userservice3&amp;client_secret=1234&amp;code=A1813M&amp;redirect_uri=https%3A%2F%2Fbaidu.com</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
Cache-Control<span class="token operator">:</span> no-store
Pragma<span class="token operator">:</span> no-cache
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json;charset=UTF<span class="token number">-8</span>
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">37</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoicmVhZGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI5MDYxNywidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoicmVhZGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFEIl0sImp0aSI6ImVjNWM2NzhmLWYxNTktNGY5YS1iMGJlLWYyNjVkNDZhYjVhYyIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMyJ9.Fv1cuEJChoqZE2xjyW8tk0H8wRcyD2SkdruBrGTJB_V_FoCzFSY5_7WKHR2VTLXeiraq33B21J4S_UKzbNxFnUg1AY_dx6hXSKewXP8obZPOAxP7JUgbewJv7yNr-fQ15LZF1poLZgZp2XDvH4LeVLe-xkpG5I2a6MEE4ItUXJU&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;refresh_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoicmVhZGVyIiwic2NvcGUiOlsiRk9PIl0sImF0aSI6ImVjNWM2NzhmLWYxNTktNGY5YS1iMGJlLWYyNjVkNDZhYjVhYyIsImV4cCI6MTYxMDg3NTQxNywidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoicmVhZGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFEIl0sImp0aSI6IjNkZjMxMDRjLTczNTYtNGVkOS04M2ZlLTBhZTg2ZmFkNTk4MiIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMyJ9.aFxewJI1ekZEcusuOuleQoqE5byjFL5oyUvVSUzzcHkSntvgxOFFYte8kEyfVXaCMAVTdpF1r3WmprdtyQ8qxsNbWIr2SBy7YKUbECf0JVKOSQ6FEMpdzMu9Pvmvds_nT4WGpfUDVf2fFgVQtqA4VnQeZxUeEHwBu9NV_1Rsgt0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FOO&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userDetails&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ec5c678f-f159-4f9a-b0be-f265d46ab5ac&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>虽然 userservice3 客户端可以有读权限和写权限，但是因为我们登录的用户 reader 只有读权限，所以最后拿到也只有读权限。</p> <h2 id="演示权限控制"><a href="#演示权限控制" class="header-anchor">#</a> 演示权限控制</h2> <p>现在我们来测试一下之前定义的两个账号，也就是读账号和写账号，看看它们的权限控制是否有效。</p> <p>首先，测试一下我们的安全配置，访问 <code>http://localhost:8081/hello</code> 端点不需要认证可以匿名访问：</p> <p><img src="assets/7646fe1e6e4cc9914f79881576126459.png" alt="img"></p> <p>访问 <code>http://localhost:8081/user</code> 需要身份认证：</p> <p><img src="assets/3b22a89392c92187960aecd4bc3cf8f6.png" alt="img"></p> <p>不管以哪种模式拿到访问令牌，我们用具有读权限的访问令牌访问资源服务器的如下地址（请求头加入 <code>Authorization: Bearer XXXXXXXXXX</code>，其中 XXXXXXXXXX 代表访问令牌）：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET http<span class="token operator">:</span><span class="token comment">//localhost:8081/user</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> 
X-Content-Type-Options<span class="token operator">:</span> nosniff
X-XSS-Protection<span class="token operator">:</span> <span class="token number">1</span>; mode=block
Cache-Control<span class="token operator">:</span> no-cache<span class="token punctuation">,</span> no-store<span class="token punctuation">,</span> max-age=<span class="token number">0</span><span class="token punctuation">,</span> must-revalidate
Pragma<span class="token operator">:</span> no-cache
Expires<span class="token operator">:</span> <span class="token number">0</span>
X-Frame-Options<span class="token operator">:</span> DENY
Content-Type<span class="token operator">:</span> application/json
Transfer-Encoding<span class="token operator">:</span> chunked
Date<span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">18</span> Dec <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">57</span> GMT
Keep-Alive<span class="token operator">:</span> timeout=<span class="token number">60</span>
Connection<span class="token operator">:</span> keep-alive

<span class="token punctuation">{</span>
  <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;remoteAddress&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sessionId&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tokenValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsidXNlcnNlcnZpY2UiXSwidXNlcl9uYW1lIjoicmVhZGVyIiwic2NvcGUiOlsiRk9PIl0sImV4cCI6MTYwODI5MTMwNiwidXNlckRldGFpbHMiOnsicGFzc3dvcmQiOm51bGwsInVzZXJuYW1lIjoicmVhZGVyIiwiYXV0aG9yaXRpZXMiOlt7ImF1dGhvcml0eSI6IlJFQUQifV0sImFjY291bnROb25FeHBpcmVkIjp0cnVlLCJhY2NvdW50Tm9uTG9ja2VkIjp0cnVlLCJjcmVkZW50aWFsc05vbkV4cGlyZWQiOnRydWUsImVuYWJsZWQiOnRydWV9LCJhdXRob3JpdGllcyI6WyJSRUFEIl0sImp0aSI6IjQzMjhlZDViLTA3OTItNDkxZC04NTJkLWYwMWJhNGEzNGRmZSIsImNsaWVudF9pZCI6InVzZXJzZXJ2aWNlMyJ9.TIz5G2S-gIvgKRWWMRHAPYHB27s4uD0w6Sl9GPMj1L-LCgmiEbi-y2eBl9sW5CgS4bbC9o2zcHeuYx5BAFkaBtfe74dtOejhhCm20ql4kkrzCc352o7IP4h_udeebTIh5qD_76xCQY3Mwwt1a5ThTTJ3Wz_G94872XiYMDqAq9o&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tokenType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bearer&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;decodedDetails&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;authenticated&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAuthentication&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;details&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authenticated&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;principal&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;credentials&quot;</span><span class="token operator">:</span> <span class="token string">&quot;N/A&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;credentials&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;principal&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oauth2Request&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;clientId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userservice3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;FOO&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;requestParameters&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;client_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;userservice3&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;resourceIds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;userservice&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;approved&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;refresh&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;redirectUri&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;responseTypes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;extensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;grantType&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;refreshTokenRequest&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;clientOnly&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reader&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>以 POST 方式访问 http://localhost:8081/user/，显然是失败的：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8081</span><span class="token operator">/</span>user

HTTP<span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">403</span> 
<span class="token class-name">Cache</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">:</span> no<span class="token operator">-</span>store
<span class="token class-name">Pragma</span><span class="token operator">:</span> no<span class="token operator">-</span>cache
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> nosniff
<span class="token class-name">X</span><span class="token operator">-</span>XSS<span class="token operator">-</span><span class="token class-name">Protection</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> mode<span class="token operator">=</span>block
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Frame</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> DENY
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>json
<span class="token class-name">Transfer</span><span class="token operator">-</span><span class="token class-name">Encoding</span><span class="token operator">:</span> chunked
<span class="token class-name">Date</span><span class="token operator">:</span> <span class="token class-name">Fri</span><span class="token punctuation">,</span> <span class="token number">18</span> <span class="token class-name">Dec</span> <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">39</span><span class="token operator">:</span><span class="token number">42</span> GMT
<span class="token class-name">Keep</span><span class="token operator">-</span><span class="token class-name">Alive</span><span class="token operator">:</span> timeout<span class="token operator">=</span><span class="token number">60</span>
<span class="token class-name">Connection</span><span class="token operator">:</span> keep<span class="token operator">-</span>alive

<span class="token punctuation">{</span>
  <span class="token string">&quot;error&quot;</span><span class="token operator">:</span> <span class="token string">&quot;access_denied&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;error_description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;不允许访问&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>因为这个接口要求有写权限：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们换一个具有读写权限的访问令牌来试试：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code># 登录页面
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>oauth<span class="token operator">/</span>authorize<span class="token operator">?</span>response_type<span class="token operator">=</span>code<span class="token operator">&amp;</span>client_id<span class="token operator">=</span>userservice3<span class="token operator">&amp;</span>redirect_uri<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com

用 writer<span class="token operator">/</span>writer 登录

# 换取 token
POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8080</span><span class="token operator">/</span>oauth<span class="token operator">/</span>token<span class="token operator">?</span>grant_type<span class="token operator">=</span>authorization_code<span class="token operator">&amp;</span>client_id<span class="token operator">=</span>userservice3<span class="token operator">&amp;</span>client_secret<span class="token operator">=</span><span class="token number">1234</span><span class="token operator">&amp;</span>code<span class="token operator">=</span><span class="token class-name">Ipbkuq</span><span class="token operator">&amp;</span>redirect_uri<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>baidu<span class="token punctuation">.</span>com

# 访问资源
POST http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8081</span><span class="token operator">/</span>user

HTTP<span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> 
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> nosniff
<span class="token class-name">X</span><span class="token operator">-</span>XSS<span class="token operator">-</span><span class="token class-name">Protection</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> mode<span class="token operator">=</span>block
<span class="token class-name">Cache</span><span class="token operator">-</span><span class="token class-name">Control</span><span class="token operator">:</span> no<span class="token operator">-</span>cache<span class="token punctuation">,</span> no<span class="token operator">-</span>store<span class="token punctuation">,</span> max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> must<span class="token operator">-</span>revalidate
<span class="token class-name">Pragma</span><span class="token operator">:</span> no<span class="token operator">-</span>cache
<span class="token class-name">Expires</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token class-name">X</span><span class="token operator">-</span><span class="token class-name">Frame</span><span class="token operator">-</span><span class="token class-name">Options</span><span class="token operator">:</span> DENY
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>json
<span class="token class-name">Transfer</span><span class="token operator">-</span><span class="token class-name">Encoding</span><span class="token operator">:</span> chunked
<span class="token class-name">Date</span><span class="token operator">:</span> <span class="token class-name">Fri</span><span class="token punctuation">,</span> <span class="token number">18</span> <span class="token class-name">Dec</span> <span class="token number">2020</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">34</span> GMT
<span class="token class-name">Keep</span><span class="token operator">-</span><span class="token class-name">Alive</span><span class="token operator">:</span> timeout<span class="token operator">=</span><span class="token number">60</span>
<span class="token class-name">Connection</span><span class="token operator">:</span> keep<span class="token operator">-</span>alive

<span class="token punctuation">{</span>
  <span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;writer&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;authorities&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;authority&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ,WRITE&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;accountNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;accountNonLocked&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;credentialsNonExpired&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="搭建客户端程序"><a href="#搭建客户端程序" class="header-anchor">#</a> 搭建客户端程序</h2> <p>在上面的演示中，我们使用的是 Postman，也就是手动 HTTP 请求的方式来申请和使用 Token。最后，我们来搭建一个 OAuth 客户端程序自动实现这个过程。</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>plugins <span class="token punctuation">{</span>
    id <span class="token string">'org.springframework.boot'</span> version <span class="token string">'2.4.1'</span>
    id <span class="token string">'io.spring.dependency-management'</span> version <span class="token string">'1.0.10.RELEASE'</span>
    id <span class="token string">'java'</span>
<span class="token punctuation">}</span>

group <span class="token operator">=</span> <span class="token string">'cn.mrcode.cloudoath2.client'</span>
version <span class="token operator">=</span> <span class="token string">'0.0.1-SNAPSHOT'</span>
sourceCompatibility <span class="token operator">=</span> <span class="token string">'1.8'</span>

repositories <span class="token punctuation">{</span>
    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    maven <span class="token punctuation">{</span> url <span class="token string">'https://repo.spring.io/milestone'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ext <span class="token punctuation">{</span>
    <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'springCloudVersion'</span><span class="token punctuation">,</span> <span class="token string gstring">&quot;2020.0.0-RC1&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-starter-oauth2'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-thymeleaf'</span>
<span class="token punctuation">}</span>

dependencyManagement <span class="token punctuation">{</span>
    imports <span class="token punctuation">{</span>
        mavenBom <span class="token string gstring">&quot;org.springframework.cloud:spring-cloud-dependencies:<span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>springCloudVersion<span class="token punctuation">}</span></span>&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

test <span class="token punctuation">{</span>
    <span class="token function">useJUnitPlatform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>配置文件如下：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8082</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /ui
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
      <span class="token key atrule">clientId</span><span class="token punctuation">:</span> userservice3
      <span class="token key atrule">clientSecret</span><span class="token punctuation">:</span> <span class="token number">1234</span>
      <span class="token key atrule">accessTokenUri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/oauth/token
      <span class="token key atrule">userAuthorizationUri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/oauth/authorize
      <span class="token key atrule">scope</span><span class="token punctuation">:</span> FOO
    <span class="token key atrule">resource</span><span class="token punctuation">:</span>
      <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
        <span class="token key atrule">key-value</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          -----BEGIN PUBLIC KEY-----
          MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCM0iHtBw+Kbmynd34MS1g8DvcQ
          hhDNacxRepPKmzMs524UX1bLeMlM6A4TE1Gp106nz5xRGPB4AVHq7BFe25H/xdT3
          SpoSvfnkb9SgfPX7Y+PuNLxhGxUt8qNgzHEjsJomxEiYGsYIaxScFuGK6uXhPi4d
          c4csrdiaAelTIAASRQIDAQAB
          -----END PUBLIC KEY-----</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token comment">#logging:</span>
<span class="token comment">#  level:</span>
<span class="token comment">#    ROOT: DEBUG</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>客户端项目端口 8082，几个需要说明的地方：</p> <ol><li><p>本地测试的时候有一个坑，也就是我们需要配置 context-path，否则可能会出现客户端和授权服务器服务端 Cookie 干扰，导致 CSRF 防御触发的问题。这个问题出现后程序没有任何错误日志输出，只有开启 DEBUG 模式后才能看到 DEBUG 日志里有提示，因此这个问题非常难以排查。说实话，我也不知道 Spring 为什么不把这个信息作为 WARN 级别的日志输出。</p></li> <li><p>作为 OAuth 客户端，我们需要配置 OAuth 服务端获取 Token 的地址、授权（获取授权码）的地址，需要配置客户端的 ID、密码和授权范围。</p></li> <li><p>因为使用的是 JWT Token，我们需要配置公钥（当然，如果不在这里直接配置公钥的话，也可以配置从授权服务器服务端获取公钥）。</p></li></ol> <p>接下来，我们可以开始编码了。</p> <p>第一步，实现 MVC 的配置：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestContextListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">EnableWebMvc</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ViewControllerRegistry</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebMvcConfigurer</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebMvc</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 配置 RequestContextListener 用于启用 session scope 的 Bean
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestContextListener</span> <span class="token function">requestContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置 index 路径的首页 Controller
     *
     * @param registry
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;forward:/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>这里做了两件事情：</p> <ol><li><p>配置 RequestContextListener，用于启用 session scope 的 Bean；</p></li> <li><p>配置了 index 路径的首页 Controller。</p></li></ol> <p>第二步，实现安全方面的配置：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * / 路径和 /login 路径允许访问，其它路径需要身份认证后才能访问
     * @param http
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/login**&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>这里我们实现的是 <code>/</code>  路径和  <code>/login</code>  路径允许访问，其它路径需要身份认证后才能访问。</p> <p>第三步，我们来创建一个控制器：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>mrcode<span class="token punctuation">.</span>cloudoath2<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">OAuth2RestTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">OAuth2Authentication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OAuth2RestTemplate</span> restTemplate<span class="token punctuation">;</span>
    <span class="token comment">// 演示登录后才能访问的安全页面</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/securedPage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">securedPage</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token string">&quot;securedPage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;authentication&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 演示通过 OAuth2RestTemplate 调用受保护资源</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/remoteCall&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">remoteCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseEntity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8081/user/name&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> responseEntity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这里我们实现了两个功能：</p> <ol><li><p>securedPage 页面，实现的功能是，把用户信息作为模型传入了视图，这样打开页面后就能显示用户名和权限。</p></li> <li><p>remoteCall 接口，实现的功能是，通过引入 OAuth2RestTemplate，在登录后就可以使用凭据直接从受保护资源服务器拿资源，不需要繁琐地实现获得访问令牌、在请求头里加入访问令牌的过程。</p></li></ol> <p>第四步，配置一下刚才用到的 OAuth2RestTemplate Bean，并启用 OAuth2Sso 功能：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableOAuth2Sso</span> <span class="token comment">//这个注解包含了 @EnableOAuth2Client</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuthClientConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 定义了 OAuth2RestTemplate，网上一些比较老的资料给出的是手动读取配置文件来实现，
     * 最新版本已经可以自动注入 OAuth2ProtectedResourceDetails
     * @param oAuth2ClientContext
     * @param details
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2RestTemplate</span> <span class="token function">oauth2RestTemplate</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ClientContext</span> oAuth2ClientContext<span class="token punctuation">,</span>
                                                 <span class="token class-name">OAuth2ProtectedResourceDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2RestTemplate</span><span class="token punctuation">(</span>details<span class="token punctuation">,</span> oAuth2ClientContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>第五步，实现首页：index.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Spring Security SSO Client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn btn-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>securedPage<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>以及登录后才能访问的 securedPage 页面：securedPage.html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Secured Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        Welcome, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${authentication.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
        Your authorities are <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${authentication.authorities}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>authorities<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="演示单点登录"><a href="#演示单点登录" class="header-anchor">#</a> 演示单点登录</h2> <p>好，客户端程序搭建好之后，我们先来测试一下单点登录的功能。启动客户端项目，打开浏览器访问：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8082/ui/securedPage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到，页面自动转到了授权服务器（8080 端口）的登录页面：</p> <p><img src="assets/05b76f316304e3ef2d1494bae501c381.png" alt="img"></p> <p>登录后显示了当前用户名和权限：</p> <p><img src="assets/7d24bc73267506c15f9feyy546557237.png" alt="img"></p> <p>我们再启动另一个客户端网站，端口改为 8083，然后访问同样的地址：</p> <p><img src="assets/7a50619ace3e40c8ff7c0aa860f11246.png" alt="img"></p> <p>可以看到直接是登录状态，单点登录测试成功。是不是很方便？其实，为了达成单点登录的效果，程序在背后自动实现了多次 302 重定向，整个流程为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8083/ui/securedPage -&gt;
http://localhost:8083/ui/login -&gt;
http://localhost:8080/oauth/authorize?client_id=userservice3&amp;redirect_uri=http://localhost:8083/ui/login&amp;response_type=code&amp;scope=FOO&amp;state=Sobjqe -&gt;
http://localhost:8083/ui/login?code=CDdvHa&amp;state=Sobjqe -&gt;
http://localhost:8083/ui/securedPage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="演示客户端请求资源服务器资源"><a href="#演示客户端请求资源服务器资源" class="header-anchor">#</a> 演示客户端请求资源服务器资源</h2> <p>还记得吗，在上一节「搭建客户端程序」中，我们还定义了一个 remoteCall 接口，直接使用 OAuth2RestTemplate 来访问远程资源服务器的资源。现在，我们来测试一下这个接口是否可以实现自动的 OAuth 流程。访问：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>
http://localhost:8082/ui/remoteCall
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>会先转到授权服务器登录，登录后自动跳转回来：</p> <p><img src="assets/016f28b7161d2c600197aa2392b0de27.png" alt="img"></p> <p>可以看到输出了用户名，对应的资源服务器服务端接口是：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>换一个 writer 用户登录试试，也能得到正确的输出：</p> <p><img src="assets/yy2bca66c45cefa56d2d727c3a136a84.png" alt="img"></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>今天这一讲，我们完整演示了如何使用 Spring Cloud 的 OAuth 2.0 组件基于三个程序角色（授权服务器、受保护资源服务器和客户端）实现三种 OAuth 2.0 的授权许可类型（资源拥有者凭据许可、客户端凭据许可和授权码许可）。</p> <p>我们先演示了三种授权许可类型的手动流程，然后也演示了如何实现权限控制和单点登录，以及如何使用客户端程序来实现自动的 OAuth 2.0 流程。</p> <p>我把今天用到的所有代码都放到了 <a href="https://github.com/zq99299/myoath2-demo" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上，你可以点击这个链接查看。</p> <p>最后，我再提一下，将来 Spring 对于 OAuth 2.0 的支持可能会转移到由社区推进的 Spring Authorization Server 项目上来继续运作。如果你感兴趣的话，可以及时关注这个项目的进展。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/txxs/record/edit/master/docs/oath2/02/05.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-12-20 16:11:32</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/record/oath2/02/04.html" class="prev">
        串讲：OAuth 2.0 的工作流程与安全问题
      </a></span> <span class="next"><a href="/record/oath2/02/06.html">
        架构案例：基于 OAuth 2.0/JWT 的微服务参考架构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/record/assets/js/app.884f2913.js" defer></script><script src="/record/assets/js/2.dbe61d54.js" defer></script><script src="/record/assets/js/526.57bd75de.js" defer></script><script src="/record/assets/js/6.8f5ad0bb.js" defer></script>
  </body>
</html>
